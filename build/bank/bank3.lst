AS65 Assembler for R6502 [1.42].                                     Page    1
---------------------------------- bank3.s -----------------------------------

5513 lines read, no errors in pass 1.
c000 =                       _bank0_start=0xc000
                             	include "kernel\kernel.s"
                             ;************************************************
                             ;*
                             ;*	BBC-128 HOMEBREW COMPUTER
                             ;*	Hardware and software design by @6502Nerd (Dol
                             ;*	Copyright 2014-20
                             ;*  Free to use for any non-commercial purpose su
                             ;*  appropriate credit of my authorship please!
                             ;*
                             ;*  KERNEL.S
                             ;*	The 'kernel' routine includes code and data wh
                             ;* 	be in every ROM bank.  In the auto-generated 
                             ;*  files, the kernel is added before the bank sp
                             ;*	code.  See bank0.s as an example.
                             ;*
                             ;************************************************
                             
                             ;* Include all definition and code files in the r
                             	include "inc\includes.i"
                             ;************************************************
                             ;*
                             ;*	BBC-128 HOMEBREW COMPUTER
                             ;*	Hardware and software design by @6502Nerd (Dol
                             ;*	Copyright 2014-20
                             ;*  Free to use for any non-commercial purpose su
                             ;*  appropriate credit of my authorship please!
                             ;*
                             ;*  INCLUDES.S
                             ;*  Main include file for key definitions and mac
                             ;*  Many of the settings here are exremely machin
                             ;*  Defines : IO block addresses, VIA port usage,
                             ;*  settings, useful macros, sound chip registers
                             ;*  VDP registers, ACIA registers.
                             ;*
                             ;************************************************
                             
                             ;* The IO block is at 0x04000 and decodes up to
                             ;* eight IO addresses, at 0x0080 intervals
                             ;* All eight are not used at the present time:
                             ;* - 0 : VIA 1 (Keyboard)
                             ;* - 1 : VIA 2 (Sound and SD card interface)
                             ;* - 2 : VDP (Video)
                             ;* - 3 : ACIA (Serial)
                             ;* - 4 : RTC (DS12887 real time clock + RAM)
0400 =                       IO_0		= 0x0400
0480 =                       IO_1		= 0x0480
0500 =                       IO_2		= 0x0500
0580 =                       IO_3		= 0x0580
0600 =                       IO_4		= 0x0600
0680 =                       IO_5		= 0x0680
0700 =                       IO_6		= 0x0700
0780 =                       IO_7		= 0x0780
                             
                             ;* VDP is accessed through IO_2
0500 =                       VDP_MODE0		= IO_2
0501 =                       VDP_MODE1		= IO_2+1
0501 =                       VDP_STATUS		= IO_2+1
0501 =                       VDP_ADDR		= IO_2+1
0500 =                       VDP_VRAM		= IO_2
0001 =                       VDP_SHORTDELAY	= 1
AS65 Assembler for R6502 [1.42].                                     Page    2
---------------------------------- bank3.s -----------------------------------

0003 =                       VDP_LONGDELAY 	= 3
0010 =                       VDP_FLASH		= 0x10				;* Must be a power of 2 *
                             
                             ;* This structure defines the key information
                             ;* kept about the VDP current mode
0000 =                       	struct vdp_addr_struct
0000 =                       	dw vdp_addr_nme				;* Address of name table
0002 =                       	dw vdp_addr_col				;* Address of colour table
0004 =                       	dw vdp_addr_pat				;* Address of pattern table
0006 =                       	dw vdp_addr_spa				;* Address of sprite pattern 
0008 =                       	dw vdp_addr_spp				;* Address of sprite position
000a =                       	db vdp_bord_col				;* Value of border colour
000b =                       	db vdp_gmode				;* Graphics mode 0,1,2 or 0x80 (
                             	end struct
                             
                             ;* Standard definitions of 6522 registers
                             ;* As found in the datasheets
0000 =                       PRB			= 0x00
0001 =                       PRA			= 0x01
0002 =                       DDRB		= 0x02
0003 =                       DDRA		= 0x03
0004 =                       T1CL		= 0x04
0005 =                       T1CH		= 0x05
0006 =                       T1LL		= 0x06
0007 =                       T1LH		= 0x07
0008 =                       T2CL		= 0x08
0009 =                       T2CH		= 0x09
000a =                       SR			= 0x0a
000b =                       ACR			= 0x0b
000c =                       PCR			= 0x0c
000d =                       IFR			= 0x0d
000e =                       IER			= 0x0e
000f =                       PRAH		= 0x0f
                             
0001 =                       IFR_CA2		= 0x01
0002 =                       IFR_CA1		= 0x02
                             
                             ;* AY-3-8910 definitions
                             ;* The sound chip is accessed through VIA 2
0481 =                       SND_ADBUS	= IO_1+PRA
0480 =                       SND_MODE	= IO_1+PRB
                             
0040 =                       SND_SELREAD			= 0x40
0002 =                       SND_SELWRITE		= 0x02
0042 =                       SND_SELSETADDR		= (SND_SELREAD|SND_SELWRITE)
00bd =                       SND_DESELECT_MASK	= (0xff-SND_SELREAD-SND_SELWRIT
                             
0000 =                       SND_REG_CHAPL	= 0x00
0001 =                       SND_REG_CHAPH	= 0x01
0002 =                       SND_REG_CHBPL	= 0x02
0003 =                       SND_REG_CHBPH	= 0x03
0004 =                       SND_REG_CHCPL	= 0x04
0005 =                       SND_REG_CHCPH	= 0x05
0006 =                       SND_REG_CHNP	= 0x06
0007 =                       SND_REG_CTL		= 0x07
0008 =                       SND_REG_CHAVOL	= 0x08
0009 =                       SND_REG_CHBVOL	= 0x09
000a =                       SND_REG_CHBVOL	= 0x0a
000b =                       SND_REG_ENVPL	= 0x0b
000c =                       SND_REG_ENVPH	= 0x0c
000d =                       SND_REG_ENVCYC	= 0x0d
                             
AS65 Assembler for R6502 [1.42].                                     Page    3
---------------------------------- bank3.s -----------------------------------

000e =                       SND_REG_IOA	= 0x0e
000f =                       SND_REG_IOB	= 0x0f
                             
                             ;* 6551 ACIA definitions
                             ;* As found in the datasheets
0580 =                       SER_DATA	= (IO_3+0)
0581 =                       SER_STATUS	= (IO_3+1)
0581 =                       SER_RESET	= (IO_3+1)
0582 =                       SER_CMD		= (IO_3+2)
0583 =                       SER_CTL		= (IO_3+3)
                             
0080 =                       SER_IRQ		= 0x80
0040 =                       SER_DSRB	= 0x40
0020 =                       SER_DCDB	= 0x20
0010 =                       SER_TDRE	= 0x10
0008 =                       SER_RDRF	= 0x08
0004 =                       SER_OVRN	= 0x04
0002 =                       SER_FE		= 0x02
0001 =                       SER_PE		= 0x01
0080 =                       SER_SBN		= 0x80
0040 =                       SER_WL1		= 0x40
0020 =                       SER_WL0		= 0x20
0060 =                       SER_WL		= (SER_WL1|SER_WL0)
0010 =                       SER_RCS		= 0x10
0008 =                       SER_SBR3	= 0x08
0004 =                       SER_SBR2	= 0x04
0002 =                       SER_SBR1	= 0x02
0001 =                       SER_SBR0	= 0x01
000f =                       SER_SBR		= (SER_SBR3|SER_SBR2|SER_SBR1|SER_SBR0)
000f =                       SER_19200B	= (SER_SBR3|SER_SBR2|SER_SBR1|SER_SBR0
000e =                       SER_9600B	= (SER_SBR3|SER_SBR2|SER_SBR1)
0080 =                       SER_PMC1	= 0x80
0040 =                       SER_PMC0	= 0x40
00c0 =                       SER_PMC		= (SER_PMC1|SER_PMC0)
0020 =                       SER_PME		= 0x20
0010 =                       SER_REM		= 0x10
0008 =                       SER_TIC1	= 0x08
0004 =                       SER_TIC0	= 0x04
000c =                       SER_TIC		= (SER_TIC1|SER_TIC0)
0002 =                       SER_IRD		= 0x02
0001 =                       SER_DTR		= 0x01
                             
                             ;* BBC keyboard definitions
                             ;* The keyboard is accessed through VIA 1
                             ;* Port A - all output
0001 =                       KB_ROWA		= 0x01
0002 =                       KB_ROWB		= 0x02
0004 =                       KB_ROWC		= 0x04
0008 =                       KB_COLA		= 0x08
0010 =                       KB_COLB		= 0x10
0020 =                       KB_COLC		= 0x20
0040 =                       KB_COLD		= 0x40
0080 =                       KB_EN		= 0x80
                             ;* Port B
0001 =                       KB_W		= 0x01			; Input - BBC keyboard hardware se
0002 =                       KB_LED0		= 0x02			; Output - led 0
0004 =                       KB_LED1		= 0x04			; Output - led 1
0008 =                       KB_LED2		= 0x08			; Output - led 2
0001 =                       KB_CAPSLK	= 0x01			; Id of Caps Lock - maps to Le
0002 =                       KB_SHIFTLK	= 0x02			; Id of Shift lock - maps to 
                             
0003 =                       KB_REP_TIM	= 3				; Number of VB periods for the 
AS65 Assembler for R6502 [1.42].                                     Page    4
---------------------------------- bank3.s -----------------------------------

0014 =                       KB_REP_DEL	= 20			; Number of VB periods before r
0002 =                       KB_DEBOUNCE	= 2				; Number of VB periods before 
                             
0001 =                       UTF_SOH		= 0x01
0003 =                       UTF_ETX		= 0x03			; Break character
0007 =                       UTF_BEL		= 0x07
0008 =                       CRSR_LEFT	= 0x08
0009 =                       CRSR_RIGHT	= 0x09
000a =                       CRSR_DOWN	= 0x0a
000b =                       CRSR_UP		= 0x0b
0006 =                       UTF_ACK		= 0x06			; Used for the copy key in this
000c =                       UTF_FF		= 0x0c
000d =                       UTF_CR		= 0x0d
0015 =                       UTF_NACK	= 0x15
0017 =                       UTF_ETB		= 0x17
001a =                       UTF_BRK		= 0x1a			; Debug - drop in to monitor
007f =                       UTF_DEL		= 0x7f
0020 =                       UTF_SPECIAL = 0x20
                             
                             ;* SD Card interface definitions
                             ;* The card is accessed through port B of VIA 2
0001 =                       SD_CLK		= 0x01			; Clock output to SD card
0004 =                       SD_CD		= 0x04			; Card detect input
0008 =                       SD_CS		= 0x08			; Card select output
0010 =                       SD_DI		= 0x10			; Data output from VIA to SD Card
0080 =                       SD_DO		= 0x80			; Data input to VIA from SD card
                             
0010 =                       SD_MOSI		= SD_DI
0080 =                       SD_MISO		= SD_DO
0480 =                       SD_REG		= IO_1+PRB
                             
0000 =                       CMD_ERR_NOERROR			= 0x00
0001 =                       CMD_ERR_NOTFOUND		= 0x01
0002 =                       CMD_ERR_PARM			= 0x02
0003 =                       CMD_ERR_VAL				= 0x03
                             
                             ;* Memory management definitions
                             ;* Y1,Y0 = ROM bank selection CIA1 PORTB
0080 =                       MM_Y1					= 0x80
0040 =                       MM_Y0					= 0x40
                             ;* X1,X0 = RAM bank selection CIA1 PORTB
0020 =                       MM_X1					= 0x20
0010 =                       MM_X0					= 0x10
                             ;* DIS = ROM disable *CIA2* PORTB
0020 =                       MM_DIS					= 0x20
                             
                             ;* Number formats for conversion routines
0000 =                       NUM_ANY		= 0x00
0001 =                       NUM_DEC		= 0x01
0002 =                       NUM_HEX		= 0x02
0003 =                       NUM_BIN		= 0x03
                             
                             	
                             ;* SD Card Master Boot Record (MBR) definitions
                             ;* The MBR contains the essential information
                             ;* needed to access the data on the card
                             ;* MBR is usually sector 0, but not always
                             ;* however the card I am using does work ok.
0000 =                       MBR_Code				=	0x0000
0003 =                       MBR_OEMName				=	0x0003
000b =                       MBR_BytesPerSect		=	0x000b
000d =                       MBR_SectPerClust		=	0x000d
AS65 Assembler for R6502 [1.42].                                     Page    5
---------------------------------- bank3.s -----------------------------------

000e =                       MBR_ResvSect			=	0x000e
0010 =                       MBR_FATCopies			=	0x0010
0011 =                       MBR_RootEntries			=	0x0011
0013 =                       MBR_SmlSect				=	0x0013
0015 =                       MBR_MediaDesc			=	0x0015
0016 =                       MBR_SectPerFAT			=	0x0016
0018 =                       MBR_SectPerTrk			=	0x0018
001a =                       MBR_NumHeads			=	0x001a
001c =                       MBR_NumHidSect			=	0x001c
0020 =                       MBR_NumSect				=	0x0020
0024 =                       MBR_DrvNum				=	0x0024
0026 =                       MBR_ExtSig				=	0x0026
0027 =                       MBR_SerNo				=	0x0027
002b =                       MBR_VolName				=	0x002b
0036 =                       MBR_FATName				=	0x0036
003e =                       MBR_ExeCode				=	0x003e
01c6 =                       MBR_BootPart1			=	(0x01be+0x08)
01fe =                       MBR_ExeMark				=	0x01fe
                             
                             ;* FAT16 definitions - these are offsets
                             ;* in to a FAT table entry which is
                             ;* 32 bytes in length.
0000 =                       	struct FATFileDesc
0000 =                       	ds FAT_Name,8
0008 =                       	ds FAT_Ext,3
000b =                       	ds FAT_Attr,1
000c =                       	ds FAT_Resv,1
000d =                       	ds FAT_Createms,1
000e =                       	ds FAT_CreateTime,2
0010 =                       	ds FAT_CreateDate,2
0012 =                       	ds FAT_AccessDate,2
0014 =                       	ds FAT_EAIndex,2
0016 =                       	ds FAT_ModTime,2
0018 =                       	ds FAT_ModDate,2
001a =                       	ds FAT_FirstClust,2
001c =                       	ds FAT_FileSize,4
                             	end struct
                             
                             ;* Flag to mark file as a directory
0010 =                       FAT_Attr_Dir			=	0x10
                             
                             ;* The FileHandle stucture is key to
                             ;* accessing the file system
0000 =                       	struct FileHandle
0000 =                       	ds FH_Name, 13				; 8 name, 3 extension, 1 separ
000d =                       	ds FH_Attr, 1				; What kind of file ** keep str
000e =                       	ds FH_Size, 4				; File size
0012 =                       	ds FH_CurrClust, 2			; Current cluster
0014 =                       	ds FH_SectCounter, 1		; Sector counter to know w
0015 =                       	ds FH_CurrSec, 4			; Current sector
0019 =                        	ds FH_Pointer, 4			; Pointer in to file for nex
001d =                       	ds FH_DirSect, 4			; Parent directory sector
0021 =                       	ds FH_DirOffset, 2			; Offset of this entry in t
0023 =                       	ds FH_FirstClust, 2			; First cluster of file da
0025 =                       	ds FH_LastClust, 2			; Last cluster accessed
0027 =                       	ds FH_TimeDate, 5			; Time-Date created (ms, tim
002c =                       	ds FH_FileMode, 1			; File mode (0=read, else wr
002d =                       	ds FH_FSpecPtr, 2			; Pointer to file spec being
                             	end struct
                             
0001 =                       FS_BLK_FLG_LOAD		 	= 	0x01		; On next byte, load 
0002 =                       FS_BLK_FLG_FLUSH		=	0x02		; Block has changed, ne
AS65 Assembler for R6502 [1.42].                                     Page    6
---------------------------------- bank3.s -----------------------------------

                             	
0001 =                       FS_ERR_EOF				=	0x01
                             
                             
                             ;* USEFUL MACROS HERE
                             
                             ;* Software break to throw errors
                             ;* use like this : SWBRK XX
                             ;* Where XX is the error code
                             SWBRK macro sig
                             	brk
                             	db sig
                             	endm
                             
                             _pushAXY macro
                             	pha
                             	phx
                             	phy
                             	endm
                             
                             _pullAXY macro
                             	ply
                             	plx
                             	pla
                             	endm
                             
                             _println macro msg
                             	_pushAXY
                             	ldx #lo(msg)
                             	lda #hi(msg)
                             	jsr io_print_line
                             	_pullAXY
                             	endm
                             
                             _println_low macro msg
                             	ldx #lo(msg)
                             	lda #hi(msg)
                             	jsr io_print_line
                             	endm
                             
                             _printmsgA macro msg
                             	phx
                             	phy
                             	pha
                             	ldx #lo(msg)
                             	lda #hi(msg)
                             	jsr io_print_line
                             	pla
                             	pha
                             	jsr str_a_to_x
                             	jsr _put_byte
                             	txa
                             	jsr _put_byte
                             	lda #UTF_CR
                             	jsr _put_byte
                             	pla
                             	ply
                             	plx
                             	endm
                             
                             _printA macro
                             	phx
AS65 Assembler for R6502 [1.42].                                     Page    7
---------------------------------- bank3.s -----------------------------------

                             	phy
                             	pha
                             	jsr str_a_to_x
                             	jsr _put_byte
                             	txa
                             	jsr _put_byte
                             	pla
                             	ply
                             	plx
                             	endm
                             
                             _printCRLF macro
                             	pha
                             	lda #UTF_CR
                             	jsr _put_byte
                             	pla
                             	endm
                             
                             _printC macro ch
                             	pha
                             	lda #ch
                             	jsr _put_byte
                             	pla
                             	endm
                             
                             _printCA macro
                             	pha
                             	jsr _put_byte
                             	pla
                             	endm
                             
                             _sendcmd macro cmd
                             	_pushAXY
                             	ldx #lo(cmd)
                             	lda #hi(cmd)
                             	jsr sd_sendcmd
                             	_pullAXY
                             	endm
                             
                             _incZPWord macro wordp
                             	inc wordp
                             	db	0xd0, 0x02
                             	inc wordp+1
                             	endm
                             
                             _decZPWord macro wordp
                             	pha
                             	sec
                             	lda wordp
                             	sbc #1
                             	sta wordp
                             	lda wordp+1
                             	sbc #0
                             	sta wordp+1
                             	pla
                             	endm
                             
                             _decZPWordA macro wordp
                             	sec
                             	lda wordp
                             	sbc #1
                             	sta wordp
AS65 Assembler for R6502 [1.42].                                     Page    8
---------------------------------- bank3.s -----------------------------------

                             	lda wordp+1
                             	sbc #0
                             	sta wordp+1
                             	endm
                             
                             _cpyZPWord macro worda,wordb
                             	lda worda
                             	sta wordb
                             	lda worda+1
                             	sta wordb+1
                             	endm
                             	
                             _addZPWord macro worda, wordb
                             	clc
                             	lda worda
                             	adc wordb
                             	sta worda
                             	lda worda+1
                             	adc wordb+1
                             	sta worda+1
                             	endm
                             
                             _subZPWord macro worda, wordb
                             	sec
                             	lda worda
                             	sbc wordb
                             	sta worda
                             	lda worda+1
                             	sbc wordb+1
                             	sta worda+1
                             	endm
                             	
                             _adcZPWord macro worda,const
                             	clc
                             	lda worda
                             	adc #const
                             	sta worda
                             	lda worda+1
                             	adc #0
                             	sta worda+1
                             	endm
                             
                             _adcZPByte macro worda, byte
                             	clc
                             	lda worda
                             	adc byte
                             	sta worda
                             	db 0x90, 0x02		; bcc 2
                             	inc worda+1
                             	endm
                             
                             _sbcZPByte macro worda, byte
                             	sec
                             	lda worda
                             	sbc byte
                             	sta worda
                             	db 0xb0, 0x02		; bcs 2
                             	inc worda+1
                             	endm
                             
                             _bcc macro skip
                             	db 0x90, skip
AS65 Assembler for R6502 [1.42].                                     Page    9
---------------------------------- bank3.s -----------------------------------

                             	endm
                             
                             _bcs macro skip
                             	db 0xb0, skip
                             	endm
                             
                             _df_ost_peekType macro
                             	ldy df_parmtop
                             	lda df_rtstck-1,y
                             	endm
                             
                             	include "inc\graph.i"
                             ;************************************************
                             ;*
                             ;*	BBC-128 HOMEBREW COMPUTER
                             ;*	Hardware and software design by @6502Nerd (Dol
                             ;*	Copyright 2014-20
                             ;*  Free to use for any non-commercial purpose su
                             ;*  appropriate credit of my authorship please!
                             ;*
                             ;*  GRAPH.I
                             ;*  This is the definition file for graphics, spe
                             ;*  The graphics screen handling module.  It is j
                             ;*  structure definition - but this structure is 
                             ;*  record the important attributes of a text scr
                             ;*  Needed because there is both a 40 and 32 colu
                             ;*  supported by the VDP, and the screens are not
                             ;*  same location.
                             ;*
                             ;************************************************
                             
0000 =                       	struct gr_screen
0000 =                       	dw gr_screen_start			; Start of screen memory in
0002 =                       	dw gr_screen_size			; Number of bytes screen occ
0004 =                       	db gr_screen_w				; Number of columns
0005 =                       	db gr_screen_h				; Number of rows
0006 =                       	db gr_cur_off				; Y offset of cursor image from
0007 =                       	db gr_cur_x					; Current X position of cursor
0008 =                       	db gr_cur_y					; Current Y position of cursor
0009 =                       	dw gr_cur_ptr				; VDP address of cursor
000b =                       	db gr_pixmode				; Pixel plot mode (0=Erase, 1=P
000c =                       	db gr_pixmask				; Pixel plot mask
000d =                       	db gr_pixcol				; Pixel colour
000e =                       	dw gr_geom_tmp				; One word of temp storage for
                             	end struct
                             	include "io\io.i"
                             ;************************************************
                             ;*
                             ;*	BBC-128 HOMEBREW COMPUTER
                             ;*	Hardware and software design by @6502Nerd (Dol
                             ;*	Copyright 2014-20
                             ;*  Free to use for any non-commercial purpose su
                             ;*  appropriate credit of my authorship please!
                             ;*
                             ;*  IO.I
                             ;*  Definitions file for the IO module.  The key 
                             ;*  used by the IO system is defined here.
                             ;*
                             ;************************************************
                             
                             ;* General IO structure allows the system to swap
                             ;* different IO devices by using indirect calls t
AS65 Assembler for R6502 [1.42].                                     Page   10
---------------------------------- bank3.s -----------------------------------

                             ;* the appropriate routines.
0000 =                       	struct io_struct
0000 =                       	ds	io_get_byte,	2			;* Address of get byte
0002 =                       	ds	io_put_byte,	2			;* Address of put byte
0004 =                       	ds	io_open_r,		2			;* Address of open file for r
0006 =                       	ds	io_open_w,		2			;* Address of open file for w
0008 =                       	ds	io_close_f,		2			;* Address of close file
000a =                       	ds	io_del_f,		2			;* Address of delete file
000c =                       	ds	io_ext1,		2			;* Address of extended function
000e =                       	ds	io_ext2,		2			;* Address of extended function
                             	end struct
                             	include "rtc\rtc.i"
                             ;************************************************
                             ;*
                             ;*	BBC-128 HOMEBREW COMPUTER
                             ;*	Hardware and software design by @6502Nerd (Dol
                             ;*	Copyright 2014-20
                             ;*  Free to use for any non-commercial purpose su
                             ;*  appropriate credit of my authorship please!
                             ;*
                             ;*  RTC.I
                             ;*  Definitions file for the RTC module.  The key
                             ;*  used by the real time clock is defined here.
                             ;*  It is a DS1288
                             ;*
                             ;************************************************
                             
0000 =                       RTC_SEC		= 0x00
0001 =                       RTC_SECA	= 0x01
0002 =                       RTC_MIN		= 0x02
0003 =                       RTC_MINA	= 0x03
0004 =                       RTC_HR		= 0x04
0005 =                       RTC_HRA		= 0x05
0006 =                       RTC_DOW		= 0x06
0007 =                       RTC_DAY		= 0x07
0008 =                       RTC_MTH		= 0x08
0009 =                       RTC_YR		= 0x09
000a =                       RTC_REGA	= 0x0a
000b =                       RTC_REGB	= 0x0b
000c =                       RTC_REGC	= 0x0c
000d =                       RTC_REGD	= 0x0d
                             
0080 =                       RTC_UIP		= 0x80
0040 =                       RTC_DV2		= 0x40
0020 =                       RTC_DV1		= 0x20
0010 =                       RTC_DV0		= 0x10
0080 =                       RTC_RS3		= 0x80
0040 =                       RTC_RS2		= 0x40
0020 =                       RTC_RS1		= 0x20
0010 =                       RTC_RS0		= 0x10
                             
0080 =                       RTC_SET		= 0x80
0040 =                       RTC_PIE		= 0x40
0020 =                       RTC_AIE		= 0x20
0010 =                       RTC_UIE		= 0x10
0080 =                       RTC_SQWE	= 0x80
0004 =                       RTC_DM		= 0x04
0002 =                       RTC_2412	= 0x02
0001 =                       RTC_DSE		= 0x01
                             
0080 =                       RTC_IRQF	= 0x80
0040 =                       RTC_PF		= 0x40
AS65 Assembler for R6502 [1.42].                                     Page   11
---------------------------------- bank3.s -----------------------------------

0020 =                       RTC_AF		= 0x20
0010 =                       RTC_UF		= 0x10
                             
0080 =                       RTC_VRT		= 0x80
                             
0600 =                       RTC_ADDR	= 0x600
0601 =                       RTC_DATA	= 0x601
                             
000e =                       NV_MODE     = 0x0e          ; Default boot up scr
000f =                       NV_COLOUR   = 0x0f          ; Default boot up col
                             
003f =                       NV_RAMSZ    = 63            ; Checksum byte in NV
                             	include "dflat\dflat.i"
                             ;************************************************
                             ;*
                             ;*	BBC-128 HOMEBREW COMPUTER
                             ;*	Hardware and software design by @6502Nerd (Dol
                             ;*	Copyright 2014-20
                             ;*  Free to use for any non-commercial purpose su
                             ;*  appropriate credit of my authorship please!
                             ;*
                             ;*  DFLAT.I
                             ;*  This is the main definitions file for dflat. 
                             ;*  definitions are in here to access the data st
                             ;*  used by dflat.
                             ;*
                             ;************************************************
                             
                             ;* Start dflat program memory
0ca9 =                       DF_PROGSTART=	mem_start
                             ;* This is the top of usable dflat memory plus 1
c000 =                       DF_MEMTOP	=	0xc000
                             
                             ;* Offset in to tokenised line of length and line
0000 =                       DFTK_LINLEN	=	0x00
0001 =                       DFTK_LINNUM	=	0x01
                             
                             ;* Flags for token, escape value for data types a
0080 =                       DFTK_TOKEN	=	0x80
0020 =                       DFTK_ESCVAL	=	0x20
0000 =                       DFTK_EOL	=	0x00
                             
                             ;* Numeric constants are encoded based on size an
                             ;* user representation.
                             ;* For example the decimal value 16 will be encod
                             ;* DFTK_INTDEC followed by the bytes 0 and 16 to 
                             ;* The same value in binary will be encoded as DF
                             ;* followed by the same 0 and 16 bytes.  This is 
                             ;* tokenised value to be displayed in original re
                             ;* So in the two examples, they will be shown as 
                             ;* '0x0010' respectively.
0000 =                       DFTK_CHR	=	0x00
0001 =                       DFTK_RESV1	=	0x01
0002 =                       DFTK_RESV2	=	0x02
0003 =                       DFTK_RESV3	=	0x03
0004 =                       DFTK_RESV4	=	0x04
0005 =                       DFTK_BYTDEC	=	0x05
0006 =                       DFTK_BYTHEX = 	0x06
0007 =                       DFTK_BYTBIN =	0x07
0008 =                       DFTK_RESV8	=	0x08
0009 =                       DFTK_INTDEC	=	0x09
000a =                       DFTK_INTHEX =	0x0a
AS65 Assembler for R6502 [1.42].                                     Page   12
---------------------------------- bank3.s -----------------------------------

000b =                       DFTK_INTBIN	=	0x0b
000c =                       DFTK_RESVC	=	0x0c
000d =                       DFTK_RESVD	=	0x0d
000e =                       DFTK_RESVE	=	0x0e
000f =                       DFTK_RESVF	=	0x0f
                             
                             ;* String constant, variable and procedure tokens
0010 =                       DFTK_STRLIT	=	0x10
0011 =                       DFTK_VAR	=	0x11
0012 =                       DFTK_PROC	=	0x12
001f =                       DFTK_STEND	=	0x1f
                             
                             ;* Qualifier for non-local parameters passed to a
0026 =                       DFTK_VARPARM=	'&'
                             
                             ;* Variable Value Table (VVT) definitions
                             ;* The VVT records the values of variables define
                             ;* the Variable Name Table (VNT).  When a variabl
                             ;* used, it is added to the VNT, and the position
                             ;* VNT is used as an index in to the VVT.
                             ;* Every VVT entry is 8 bytes - so the VNT index 
                             ;* shifted left 3 bits to get the VVT offset.
                             ;* The VNT grows from top of memory down, the VVT
                             ;* grows from start of VNT down.
                             
                             ;* Index in to each entry of the VVT
0000 =                       DFVVT_TYPE	=	0x00
0001 =                       DFVVT_LO	=	0x01
0002 =                       DFVVT_HI	=	0x02
0003 =                       DFVVT_DIM1	=	0x03
0004 =                       DFVVT_DIM2	=	0x04
0008 =                       DFVVT_SZ	=	0x08	;VVT is aligned to 8 byte blocks
                             
                             ;* The meaning of the DFVVT_TYPE entry
0001 =                       DFVVT_INT	=	0x01
0002 =                       DFVVT_BYT	=	0x02
0004 =                       DFVVT_STR	=	0x04
0008 =                       DFVVT_FLT	=	0x08
0040 =                       DFVVT_PROC	=	0x40
0080 =                       DFVVT_PTR	=	0x80
                             
                             ;* Flags indicating the meaning of a token
                             ;* A token has the top bit set (0x80), then the
                             ;* remaining bits indicate what it represents.
0001 =                       DFTK_KW		=	0x01
0002 =                       DFTK_FN		=	0x02
0004 =                       DFTK_STROP	=	0x04
0008 =                       DFTK_OP		=	0x08
0010 =                       DFTK_INT	=	0x10
0020 =                       DFTK_BYT	=	0x20
0040 =                       DFTK_STR	=	0x40
0080 =                       DFTK_FLT	=	0x80
0007 =                       DFTK_OPMSK	=	0x07
00f8 =                       DFTK_RTMSK	= 	0xf8
                             
                             ;* Defines what type of value is on the parameter
                             ;* All numerics are stored as INT, all STR
                             ;* are pointers to the actual string, thus
                             ;* all entries in the parmeter stack are 3 bytes
0003 =                       DFST_INT	=	DFVVT_INT|DFVVT_BYT
0004 =                       DFST_STR	=	DFVVT_STR
00ff =                       DFST_PTR	=	0xff
AS65 Assembler for R6502 [1.42].                                     Page   13
---------------------------------- bank3.s -----------------------------------

                             
                             ;* Token values of specific commands, used during
                             ;* command processing.
                             ;* ANY CHANGE TO THE ORDER OF KEYWORDS NEEDS TO R
0086 =                       DFRT_DEF	=	0x86
0087 =                       DFRT_ENDDEF	=	0x87
0088 =                       DFRT_RETURN	=	0x88
0089 =                       DFRT_ABORT	=	0x89
008c =                       DFRT_REPEAT	=	0x8c
008e =                       DFRT_FOR	=	0x8e
008f =                       DFRT_NEXT	=	0x8f
0090 =                       DFRT_WHILE	=	0x90
0091 =                       DFRT_WEND	=	0x91
0092 =                       DFRT_IF		=	0x92
0093 =                       DFRT_ELSE	=	0x93
0094 =                       DFRT_ENDIF	=	0x94
0095 =                       DFRT_ELSEIF	=	0x95
0096 =                       DFRT_DATA	=	0x96
0097 =                       DFRT_ASM	=	0x97
                             
                             _PushTrueJmp macro
                             	ldx #0xff
                             	txa
                             	jmp df_ost_pushInt
                             	endm
                             
                             _PushFalseJmp macro
                             	ldx #0x00
                             	txa
                             	jmp df_ost_pushInt
                             	endm
                             
                             	include "dflat\dflat.i"
                             ;************************************************
                             ;*
                             ;*	BBC-128 HOMEBREW COMPUTER
                             ;*	Hardware and software design by @6502Nerd (Dol
                             ;*	Copyright 2014-20
                             ;*  Free to use for any non-commercial purpose su
                             ;*  appropriate credit of my authorship please!
                             ;*
                             ;*  DFLAT.I
                             ;*  This is the main definitions file for dflat. 
                             ;*  definitions are in here to access the data st
                             ;*  used by dflat.
                             ;*
                             ;************************************************
                             
                             ;* Start dflat program memory
0ca9 =                       DF_PROGSTART=	mem_start
                             ;* This is the top of usable dflat memory plus 1
c000 =                       DF_MEMTOP	=	0xc000
                             
                             ;* Offset in to tokenised line of length and line
0000 =                       DFTK_LINLEN	=	0x00
0001 =                       DFTK_LINNUM	=	0x01
                             
                             ;* Flags for token, escape value for data types a
0080 =                       DFTK_TOKEN	=	0x80
0020 =                       DFTK_ESCVAL	=	0x20
0000 =                       DFTK_EOL	=	0x00
                             
AS65 Assembler for R6502 [1.42].                                     Page   14
---------------------------------- bank3.s -----------------------------------

                             ;* Numeric constants are encoded based on size an
                             ;* user representation.
                             ;* For example the decimal value 16 will be encod
                             ;* DFTK_INTDEC followed by the bytes 0 and 16 to 
                             ;* The same value in binary will be encoded as DF
                             ;* followed by the same 0 and 16 bytes.  This is 
                             ;* tokenised value to be displayed in original re
                             ;* So in the two examples, they will be shown as 
                             ;* '0x0010' respectively.
0000 =                       DFTK_CHR	=	0x00
0001 =                       DFTK_RESV1	=	0x01
0002 =                       DFTK_RESV2	=	0x02
0003 =                       DFTK_RESV3	=	0x03
0004 =                       DFTK_RESV4	=	0x04
0005 =                       DFTK_BYTDEC	=	0x05
0006 =                       DFTK_BYTHEX = 	0x06
0007 =                       DFTK_BYTBIN =	0x07
0008 =                       DFTK_RESV8	=	0x08
0009 =                       DFTK_INTDEC	=	0x09
000a =                       DFTK_INTHEX =	0x0a
000b =                       DFTK_INTBIN	=	0x0b
000c =                       DFTK_RESVC	=	0x0c
000d =                       DFTK_RESVD	=	0x0d
000e =                       DFTK_RESVE	=	0x0e
000f =                       DFTK_RESVF	=	0x0f
                             
                             ;* String constant, variable and procedure tokens
0010 =                       DFTK_STRLIT	=	0x10
0011 =                       DFTK_VAR	=	0x11
0012 =                       DFTK_PROC	=	0x12
001f =                       DFTK_STEND	=	0x1f
                             
                             ;* Qualifier for non-local parameters passed to a
0026 =                       DFTK_VARPARM=	'&'
                             
                             ;* Variable Value Table (VVT) definitions
                             ;* The VVT records the values of variables define
                             ;* the Variable Name Table (VNT).  When a variabl
                             ;* used, it is added to the VNT, and the position
                             ;* VNT is used as an index in to the VVT.
                             ;* Every VVT entry is 8 bytes - so the VNT index 
                             ;* shifted left 3 bits to get the VVT offset.
                             ;* The VNT grows from top of memory down, the VVT
                             ;* grows from start of VNT down.
                             
                             ;* Index in to each entry of the VVT
0000 =                       DFVVT_TYPE	=	0x00
0001 =                       DFVVT_LO	=	0x01
0002 =                       DFVVT_HI	=	0x02
0003 =                       DFVVT_DIM1	=	0x03
0004 =                       DFVVT_DIM2	=	0x04
0008 =                       DFVVT_SZ	=	0x08	;VVT is aligned to 8 byte blocks
                             
                             ;* The meaning of the DFVVT_TYPE entry
0001 =                       DFVVT_INT	=	0x01
0002 =                       DFVVT_BYT	=	0x02
0004 =                       DFVVT_STR	=	0x04
0008 =                       DFVVT_FLT	=	0x08
0040 =                       DFVVT_PROC	=	0x40
0080 =                       DFVVT_PTR	=	0x80
                             
                             ;* Flags indicating the meaning of a token
AS65 Assembler for R6502 [1.42].                                     Page   15
---------------------------------- bank3.s -----------------------------------

                             ;* A token has the top bit set (0x80), then the
                             ;* remaining bits indicate what it represents.
0001 =                       DFTK_KW		=	0x01
0002 =                       DFTK_FN		=	0x02
0004 =                       DFTK_STROP	=	0x04
0008 =                       DFTK_OP		=	0x08
0010 =                       DFTK_INT	=	0x10
0020 =                       DFTK_BYT	=	0x20
0040 =                       DFTK_STR	=	0x40
0080 =                       DFTK_FLT	=	0x80
0007 =                       DFTK_OPMSK	=	0x07
00f8 =                       DFTK_RTMSK	= 	0xf8
                             
                             ;* Defines what type of value is on the parameter
                             ;* All numerics are stored as INT, all STR
                             ;* are pointers to the actual string, thus
                             ;* all entries in the parmeter stack are 3 bytes
0003 =                       DFST_INT	=	DFVVT_INT|DFVVT_BYT
0004 =                       DFST_STR	=	DFVVT_STR
00ff =                       DFST_PTR	=	0xff
                             
                             ;* Token values of specific commands, used during
                             ;* command processing.
                             ;* ANY CHANGE TO THE ORDER OF KEYWORDS NEEDS TO R
0086 =                       DFRT_DEF	=	0x86
0087 =                       DFRT_ENDDEF	=	0x87
0088 =                       DFRT_RETURN	=	0x88
0089 =                       DFRT_ABORT	=	0x89
008c =                       DFRT_REPEAT	=	0x8c
008e =                       DFRT_FOR	=	0x8e
008f =                       DFRT_NEXT	=	0x8f
0090 =                       DFRT_WHILE	=	0x90
0091 =                       DFRT_WEND	=	0x91
0092 =                       DFRT_IF		=	0x92
0093 =                       DFRT_ELSE	=	0x93
0094 =                       DFRT_ENDIF	=	0x94
0095 =                       DFRT_ELSEIF	=	0x95
0096 =                       DFRT_DATA	=	0x96
0097 =                       DFRT_ASM	=	0x97
                             
                             _PushTrueJmp macro
                             	ldx #0xff
                             	txa
                             	jmp df_ost_pushInt
                             	endm
                             
                             _PushFalseJmp macro
                             	ldx #0x00
                             	txa
                             	jmp df_ost_pushInt
                             	endm
                             
                             	include "dflat\error.i"
                             ;************************************************
                             ;*
                             ;*	BBC128
                             ;*	Dolo Miah (@6502Nerd)
                             ;*	Copyright (c) 2020
                             ;*  Free to use for any non-commercial purpose su
                             ;*  credit of original my authorship please!
                             ;*
                             ;*  ERROR.I
AS65 Assembler for R6502 [1.42].                                     Page   16
---------------------------------- bank3.s -----------------------------------

                             ;*  Error definitions file.
                             ;*  The macro to throw an error is elswhere, but 
                             ;*  It issues a 6502 BRK commmand with the next b
                             ;*  the error code.  The BRK handler then picks u
                             ;*  code and shows the appropriate message plus a
                             ;*  number if a program was running.
                             ;*
                             ;************************************************
                             
                             	; ROM code
                             	code  
                             
                             ; Error message numbers
0000 =                       DFERR_OK		=	0
0001 =                       DFERR_SYNTAX	=	1
0002 =                       DFERR_TYPEMISM	=	2
0003 =                       DFERR_DIM		=	3
0004 =                       DFERR_UNTIL		=	4
0005 =                       DFERR_NOPROC	=	5
0006 =                       DFERR_PROCPARM	=	6
0007 =                       DFERR_IMMEDIATE	=	7
0008 =                       DFERR_UNCLOSEDIF=	8
0009 =                       DFERR_NOIF		=	9
000a =                       DFERR_NEXTFOR	=	10
000b =                       DFERR_FNAME		=	11
000c =                       DFERR_STRLONG	=	12
000d =                       DFERR_BREAK		=	13
000e =                       DFERR_NODATA	=	14
000f =                       DFERR_WEND		=	15
0010 =                       DFERR_NOLINE	=	16
0011 =                       DFERR_RETURN	=	17
0012 =                       DFERR_ABORT		=	18
0013 =                       DFERR_QUANTITY	=	19
0014 =                       DFERR_NOORG		=	20
                             
                             
                             
                             	include "bank\bank.i"
c000 =                       bankjsr_nul_addr	=	0xc000
0000 =                       bankjsr_nul_bank	=	0x00
003f =                       ROM_ZMASK			=	0x3f
00cf =                       RAM_ZMASK			=	0xcf
                             
                             _bankjsr	macro	addr,bank
                             	; Save A
                             	sta tmp_bank1
                             	
                             	; Save current bank
                             	lda bank_num
                             	pha
                             	
                             	; Switch to new bank
                             	lda IO_0+PRB
                             	and #ROM_ZMASK
                             	ora #(bank^3) << 6			; Shift left 6 bits
                             	sta IO_0+PRB
                             
                             	; Restore A
                             	lda tmp_bank1
                             	; JSR to the routine
                             	jsr addr
                             	
AS65 Assembler for R6502 [1.42].                                     Page   17
---------------------------------- bank3.s -----------------------------------

                             	jmp _restore_bank
                             	; 62 clock cycles inc restore vs 6 for a near js
                             
                             	endm
                             	
                             _bankram macro bank
                             	pha
                             	lda IO_0+PRB
                             	and #RAM_ZMASK
                             	ora #bank << 4
                             	sta IO_0+PRB
                             	pla
                             	endm
                             	
                             _bankram_fast macro bank
                             	lda IO_0+PRB
                             	and #RAM_ZMASK
                             	ora #bank << 4
                             	sta IO_0+PRB
                             	endm
                             	
                             
                             	include "kernel\zeropage.i"
                             ;************************************************
                             ;*
                             ;*	BBC-128 HOMEBREW COMPUTER
                             ;*	Hardware and software design by @6502Nerd (Dol
                             ;*	Copyright 2014-20
                             ;*  Free to use for any non-commercial purpose su
                             ;*  appropriate credit of my authorship please!
                             ;*
                             ;*  ZEROPAGE.I
                             ;*  This module name is misleading it is not only
                             ;*  allocations, but also page 2, 3, 4, 5, 6, 7 a
                             ;*  Basically, this module defines:
                             ;*  - All zero page variables for system and dfla
                             ;*  - Page 1 is stack so no need to worry about t
                             ;*  - Page 2 is the serial IO buffer for the 6551
                             ;*  - Page 3 and 4 is a 512 buffer for SD card se
                             ;*  - Page 5 onwards is mainly for dflat working 
                             ;*    but also non-zero page storage for general 
                             ;*    system and scratch usage.
                             ;*  memstart is a handy label that indicates the 
                             ;*  location that we can store dflat programs fro
                             ;*  Zero page is a valuable asset as the 6502 can
                             ;*  this page one cycle quicker than the rest of 
                             ;*  and infact some addressing modes can only use
                             ;*  Due to the value of zero page, a lot of syste
                             ;*  dflat variables are put here.  But we don't h
                             ;*  luxury for single use variables - so you will
                             ;*  see a lot of temporary sounding names which a
                             ;*  have multiple used across the code base.
                             ;*
                             ;************************************************
                             
                             	; Zero page declarations
                             	bss
0000 =                       	org 0x0000
                             
0000 =                       tmp_bank1	ds	1		; Temp storage ONLY FOR USE BY BA
0001 =                       tmp_bank2	ds	1		; Temp storage ONLY FOR USE BY BA
                             
AS65 Assembler for R6502 [1.42].                                     Page   18
---------------------------------- bank3.s -----------------------------------

                             ; Interrupt routine addresses
0002 =                       int_nmi		 ds 2		; Master NMI handler
0004 =                       int_irq		 ds	2		; Master IRQ handler
0006 =                       int_brk		 ds	2		; Master BRK handler
0008 =                       int_uservdp	 ds	2		; Where to jump for VDP interr
000a =                       int_usercia0 ds	2		; Where to jump for CIA0 inter
000c =                       int_usercia1 ds	2		; Where to jump for CIA1 inter
                             
                             ; Serial FIFO buffer pointers
000e =                       ser_first	ds	1		; Pointer to first byte in buffer
000f =                       ser_last	ds	1		; Pointer to last byte in buffer
                             ; VDP parameters
0010 =                       vdp_int_cnt	ds  2		; VDP interrupt counter
0012 =                       vdp_curoff	ds	1		; Cursor off (0 = On)
0013 =                       vdp_curstat	ds	1		; Cursor status
0014 =                       vdp_curval	ds	1		; Cursor value on screen
0015 =                       vdp_blank	ds	1		; Screen blank value normally 32
0016 =                       vdp_delay	ds	1		; Delay counter for VRAM access
                             
                             ; vdp settings
0017 =                       vdp_base	ds	vdp_addr_struct
                             
                             ; Screen geometry
0023 =                       gr_scrngeom	ds	gr_screen
                             
                             ;Keyboard parameters
0033 =                       kb_raw  	ds	1		; Raw keyboard code
0034 =                       kb_last		ds	1		; Raw code of last key
0035 =                       kb_code 	ds	1		; Converted keyboard code
0036 =                       kb_stat		ds	1		; Keyboard status for caps and shi
0037 =                       kb_deb		ds	1		; VB periods since last KB spike
0038 =                       kb_rep		ds	1		; Keyboard repeat timer
0039 =                       kb_rep_tim 	ds	1		; Default repeat speed
003a =                       kb_rep_del 	ds	1		; Default repeat delay timing
003b =                       kb_debounce ds	1		; Default repeat debounce
003c =                       kb_pressed	ds	1		; Set by the interrupt handler i
                             
003d =                       tmp_c		ds	2		; Temp address c
003f =                       tmp_v1		ds	2		; VDP temp addresses
0041 =                       tmp_a		ds	2		; Temp storage a
0043 =                       tmp_b 		ds	2		; Temp address b
0045 =                       tmp_d		ds	2		; Temp storage d
                             
                             ; Raw input/output parameters
0047 =                       buf_adr		ds	2		; Line buffer address
0049 =                       buf_sz		ds	1		; Buffer size
004a =                       buf_ef		ds	1		; End file / line marker
                             
                             ; SD card driver parameters
004b =                       sd_status	ds	1		; SD card status
004c =                       sd_slo		ds	1		; Sector pointer low
004d =                       sd_shi		ds	1		; Sector pointer high
004e =                       sd_sect		ds	4		; SD Card sector address
0052 =                       sd_addr		ds	4		; SD Card byte address
                             
                             ; File system zp parameters
0056 =                       fh_handle	ds	FileHandle ; File handle parameters
                             
                             ; ** Integer function storage **
0085 =                       ztmp_16					; Start of 16 byte scratch area (all 
0085 =                       num_a		ds	4		; 4 byte primary accumulator
0089 =                       num_b		ds	4		; 4 byte secondary accumulator
AS65 Assembler for R6502 [1.42].                                     Page   19
---------------------------------- bank3.s -----------------------------------

008d =                       num_x		ds	4		; 4 byte x register
0091 =                       num_tmp		ds	4		; 4 byte temp space
0095 =                       num_buf		ds	8		; 8 byte string buffer
                             
                             ;
                             ; **** INTERPRETER ZERO PAGE ****
                             ;
009d =                       dflat_zp_s
009d =                       dflat_zp_save_s			; ZP save dflat from here
009d =                       df_checkkey	ds	1		; Key check interval counter
009e =                       df_checkmsk	ds	1		; Mask for check key
009f =                       errno		ds	1		; General error condition status
00a0 =                       df_immed	ds	1		; Immediate mode (0 = not immediat
00a1 =                       df_sp		ds	1		; Stack pointer after error to resto
00a2 =                       df_pc		ds	2		; PC after error to return to
00a4 =                       df_brkpc	ds	2		; PC pushed on the stack for BRK
00a6 =                       df_brkval	ds	1		; Byte after BRK instruction
00a7 =                       df_prgstrt	ds	2		; Start of program code
00a9 =                       df_prgend	ds	2		; End of program code
00ab =                       df_vntstrt	ds	2		; Variable name table start
00ad =                       df_vntend	ds	2		; Variable name table end
00af =                       df_vvtstrt	ds	2		; Variable value table start
00b1 =                       df_vvtend	ds	2		; Variable value table end
00b3 =                       df_varcnt	ds	1		; Variable counter
00b4 =                       df_starstrt	ds	2		; String and array table start
00b6 =                       df_starend	ds	2		; String and array table end
00b8 =                       df_rtstop	ds	1		; Runtime stack pointer
00b9 =                       df_parmtop	ds	1		; Top of parameter stack (grows 
00ba =                       df_strbuff	ds	1		; String expression buffer
00bb =                       df_stridx	ds	1		; Top of string buffer (grows dow
00bc =                       df_sevalptr	ds	2		; Pointer to next free char in 
                             
00be =                       df_linoff	ds	1		; Offset in to line buffer
00bf =                       df_tokoff	ds	1		; Offset in to tokenised buffer
00c0 =                       df_eolidx	ds	1		; End of line index (i.e length)
00c1 =                       df_nxtstidx	ds	1		; Offset to the next statement 
00c2 =                       df_curstidx	ds	1		; Offset to the start of curren
00c3 =                       df_symtab	ds	2		; Pointer to next free symtab ent
00c5 =                       df_symoff	ds	1		; Offset in to token table
00c6 =                       df_symini	ds	2		; Start of symtab
00c8 =                       df_currlin	ds	2		; Execution current line pointer
00ca =                       df_exeoff	ds	1		; Execution line buffer offset
00cb =                       df_nextlin	ds	2		; Next line to execute
00cd =                       df_procmode	ds	1		; Only used during tokenisation
00ce =                       df_procargs	ds	1		; Only used during tokenisation
00cf =                       df_procloc	ds	1		; Counts the number of local par
00d0 =                       df_procptr	ds	2		; Pointer to proc vvt slot
00d2 =                       df_lineptr	ds	2		; Pointer to line during searche
00d4 =                       df_lineidx	ds	1		; Pointer to line index during s
00d5 =                       df_ifnest	ds	1		; Global nested if counter
00d6 =                       df_currdat	ds	2		; Data current line pointer
00d8 =                       df_datoff	ds	1		; Data line buffer offset
00d9 =                       df_rnd		ds	2		; Random number seed
                             
00db =                       df_asmpc	ds	2		; Assembler program counter
00dd =                       df_asmopt	ds	1		; Assembler current option
00de =                       df_asmadmd	ds	1		; Addressing mode
00df =                       df_asmopcde	ds	1		; Current opcode
00e0 =                       df_asmoprnd	ds	2		; Current operand
00e2 =                       df_asmlen	ds	1		; Instruction length
                             
00e3 =                       dflat_zp_save_e			; Save up to this place
AS65 Assembler for R6502 [1.42].                                     Page   20
---------------------------------- bank3.s -----------------------------------

                             
                             ; Temp space for dflat
00e3 =                       df_tmpptra	ds	2		; Temp pointer a
00e5 =                       df_tmpptrb	ds	2		; Temp pointer b
00e7 =                       df_tmpptrc	ds	2		; Temp pointer c
00e9 =                       df_tmpptrd	ds	2		; Temp pointer d
00eb =                       df_tmpptre	ds	2		; Temp pointer e
                             
                             
                             ;***** END OF ZERO PAGE *****
00ed =                       _end_zero_page
                             
                             ;***** Page 1 is CPU stack ****
0100 =                       	org 0x0100
0100 =                       _cpu_stack
0100 =                       			ds	256		; All of page 1
                             
                             ;***** Page 2 and 3 is SD card buffer
0200 =                       	org 0x0200			; SD Card data buffer 512 bytes
0200 =                       sd_buf		ds	512
                             
                             ;***** Page 4,5,6,7 is IO space
0400 =                       	org 0x0400
0400 =                       			ds	1024	; 1 k area divided in to 8x128 byte de
                             
                             
                             ;***** Page 8 is serial buffer *****
0800 =                       	org 0x0800
0800 =                       ser_buf		ds	256		; Serial input / output line buf
                             
                             ;***** Scratch area, used by many things - do not
                             ; string and numeric expression evaluation, scree
0900 =                       	org 0x0900
0900 =                       scratch		ds	256
                             
                             ;***** Dflat space *****
0a00 =                       	org 0x0a00			; Page 9 = dflat space
0a00 =                       df_linbuff
0a00 =                       df_raw		ds	128		; untokenised input line
0a80 =                       df_tokbuff
0a80 =                       df_tok		ds 	128		; tokenised output line
                             
0b00 =                       	org 0x0b00			; Page 10 = fixed space for runtime
0b00 =                       df_rtstck				; operator stack grows up, runtime g
0b00 =                       df_rtspace	ds	256
                             
                             ;***** NON-ZERO PAGE VARIABLES *****
                             
                             ; Active IO device settings
0c00 =                       io_default	ds	1		; The default device number - es
                             ; Copy of jump tables to active device io routine
0c01 =                       io_block	ds	io_struct
                             
                             ; Copy of FAT16 directory
0c11 =                       fs_direntry	ds	FATFileDesc ; copy of dir entry - 
                             
                             ; Filesystem parameters
0c31 =                       fs_bootsect	ds	4		; Start of partition (usually 0
0c35 =                       fs_fatsect	ds	4		; Start of FAT tables
0c39 =                       fs_rootsect	ds	4		; Start of Root Directory
0c3d =                       fs_datasect	ds	4		; Start of Data Area
0c41 =                       fs_dirsect	ds	4		; Current directory sector numbe
AS65 Assembler for R6502 [1.42].                                     Page   21
---------------------------------- bank3.s -----------------------------------

0c45 =                       fs_dirclust	ds	2		; Current directory cluster num
                             
                             ; Working and scratch for filesystem - some data 
0c47 =                       fs_scratch	ds	32		; 32 bytes should be more than 
                             
                             ; Self-modifying code or code that needs to run w
0c67 =                       ram_code	ds  64		; 64 bytes of RAM code space
                             
                             ; Dflat top of memory+1 - normally initialised to
0ca7 =                       df_memtop	ds	2
                             
                             ;***** THIS IS THE START OF FREE SPACE for DFLAT 
0ca9 =                       mem_start
                             
                             
                             
                             
                             ;****************************************
                             ;*	Set 6502 default vectors	*
                             ;****************************************
                             	data				; Set vectors
fffa =                       	org 0xfffa			; Vectors lie at addresses
fffa : 63c7                  	fcw call_nmi_master	; 0xfffa : NMI Vector
fffc : 6bcb                  	fcw init			; 0xfffc : Reset Vector
fffe : c3c7                  	fcw call_irq_master	; 0xfffe : IRQ Vector
                             	
                             	; ROM code
                             	code				;  
c000 =                       	org 0xc000			; Start of ROM
                             
                             	; The bank number is hardwired and aligned to PB
c000 :                       bank_num
                             	if BANK0
                             	  db 192
                             	endif
                             	if BANK1
                             	  db 128
                             	endif
                             	if BANK2
                             	  db 64
                             	endif
                             	if BANK3
c000 : 00                    	  db 0
                             	endif
                             
c001 :                       _code_start
                             	; Restore current bank always at address c001
c001 :                       _OSVectors
                             	include "kernel\osvec.s"
                             ;************************************************
                             ;*
                             ;*	BBC-128 HOMEBREW COMPUTER
                             ;*	Hardware and software design by @6502Nerd (Dol
                             ;*	Copyright 2014-20
                             ;*  Free to use for any non-commercial purpose su
                             ;*  appropriate credit of my authorship please!
                             ;*
                             ;*  OSVEC.S
                             ;*  Simply this is a bunch of JMP XXXX the order 
                             ;*  will always be maintained.  This is to allow 
                             ;*  code programs to be able to rely on fixed loc
                             ;*  some key low-level functions.
AS65 Assembler for R6502 [1.42].                                     Page   22
---------------------------------- bank3.s -----------------------------------

                             ;*  Only low level functions are needed, the idea
                             ;*  as the assembler is part of the BASIC, one ca
                             ;*  level slow stuff using BASIC then switch to M
                             ;*  speed up.
                             ;*  This code goes straight after the bank number
                             ;*  Each JMP is at 0xc001+3*(vector #)
                             ;*
                             ;************************************************
                             
c001 : 4cc0c5           [ 3] 	jmp	io_put_ch			; Vec 0
c004 : 4cbdc5           [ 3] 	jmp io_get_ch			; Vec 1
c007 : 4c50c6           [ 3] 	jmp vdp_wr_reg			; Vec 2
c00a : 4c8ac6           [ 3] 	jmp vdp_poke			; Vec 3
c00d : 4c97c6           [ 3] 	jmp vdp_peek			; Vec 4
c010 : 4cf9c6           [ 3] 	jmp snd_get_joy0		; Vec 5
c013 : 4ca1c6           [ 3] 	jmp snd_set				; Vec 6
c016 : 4c5dc6           [ 3] 	jmp vdp_wr_addr			; Vec 7
c019 : 4c75c6           [ 3] 	jmp	vdp_rd_addr			; Vec 8
c01c :                       _restore_bank
                             	; Save A
c01c : 8500             [ 3] 	sta tmp_bank1
                             	; Get old bank from stack
c01e : 68               [ 4] 	pla
c01f : 8501             [ 3] 	sta tmp_bank2
c021 : ad0004           [ 4] 	lda IO_0+PRB
c024 : 293f             [ 2] 	and #ROM_ZMASK
c026 : 0501             [ 3] 	ora tmp_bank2
c028 : 8d0004           [ 4] 	sta IO_0+PRB
                             	
                             	; Restore A
c02b : a500             [ 3] 	lda tmp_bank1
                             
c02d : 60               [ 6] 	rts
                             
                             	; include cross-bank functions (see extern.mak)
                             	include "bank\autogen.s"	
                             ;
c02e :                       mod_sz_autogen_s
c02e :                       _df_init
                              _bankjsr $f30f, 1
                             
c046 :                       _df_pg_dflat
                              _bankjsr $d825, 1
                             
c05e :                       _fs_chdir_w
                              _bankjsr $d59b, 2
                             
c076 :                       _fs_mkdir_w
                              _bankjsr $d62e, 2
                             
c08e :                       _fs_delete_w
                              _bankjsr $d537, 2
                             
c0a6 :                       _fs_close_w
                              _bankjsr $d4f6, 2
                             
c0be :                       _fs_get_byte_w
                              _bankjsr $d213, 2
                             
c0d6 :                       _fs_open_read_w
                              _bankjsr $d3e2, 2
                             
AS65 Assembler for R6502 [1.42].                                     Page   23
---------------------------------- bank3.s -----------------------------------

c0ee :                       _fs_open_write_w
                              _bankjsr $d4a6, 2
                             
c106 :                       _fs_put_byte_w
                              _bankjsr $d36f, 2
                             
c11e :                       _fs_dir_find_entry_w
                              _bankjsr $d056, 2
                             
c136 :                       _fs_dir_entry_next_w
                              _bankjsr $d08c, 2
                             
c14e :                       _fs_dir_root_start_w
                              _bankjsr $d011, 2
                             
c166 :                       _get_byte
                              _bankjsr $d25b, 0
                             
c17e :                       _put_byte
                              _bankjsr $d270, 0
                             
c196 :                       _gr_get_key
                              _bankjsr $e390, 0
                             
c1ae :                       _gr_put_byte
                              _bankjsr $e39d, 0
                             
c1c6 :                       _gr_init_screen
                              _bankjsr $de59, 0
                             
c1de :                       _init_acia
                              _bankjsr $d27d, 0
                             
c1f6 :                       _init_cia0
                              _bankjsr $d208, 0
                             
c20e :                       _init_cia1
                              _bankjsr $d239, 0
                             
c226 :                       _init_fs
                              _bankjsr $ceee, 2
                             
c23e :                       _init_sdcard
                              _bankjsr $cbe8, 2
                             
c256 :                       _init_snd
                              _bankjsr $d646, 0
                             
c26e :                       _init_keyboard
                              _bankjsr $d28f, 0
                             
c286 :                       _kb_read_raw
                              _bankjsr $d29e, 0
                             
c29e :                       _kb_read_dip
                              _bankjsr $d309, 0
                             
c2b6 :                       _command_line
                              _bankjsr $cbf1, 0
                             
c2ce :                       _gr_cls
                              _bankjsr $de6c, 0
AS65 Assembler for R6502 [1.42].                                     Page   24
---------------------------------- bank3.s -----------------------------------

                             
c2e6 :                       _gr_init_hires
                              _bankjsr $de16, 0
                             
c2fe :                       _gr_line
                              _bankjsr $e1ca, 0
                             
c316 :                       _gr_box
                              _bankjsr $e00a, 0
                             
c32e :                       _gr_circle
                              _bankjsr $e115, 0
                             
c346 :                       _gr_plot
                              _bankjsr $ded7, 0
                             
c35e :                       _gr_hchar
                              _bankjsr $df15, 0
                             
c376 :                       _gr_point
                              _bankjsr $dfbb, 0
                             
c38e :                       _gr_get
                              _bankjsr $def2, 0
                             
c3a6 :                       _gr_set_cur
                              _bankjsr $defa, 0
                             
c3be :                       _snd_get_note
                              _bankjsr $d63f, 0
                             
c3d6 :                       _snd_get_joy0
                              _bankjsr $c6f9, 0
                             
c3ee :                       _snd_set
                              _bankjsr $c6a1, 0
                             
c406 :                       _vdp_peek
                              _bankjsr $c697, 0
                             
c41e :                       _vdp_poke
                              _bankjsr $c68a, 0
                             
c436 :                       _vdp_init
                              _bankjsr $dc00, 0
                             
c44e :                       _rtc_init
                              _bankjsr $d465, 0
                             
c466 :                       _rtc_gettimedate
                              _bankjsr $d5cb, 0
                             
c47e :                       _rtc_setdatetime
                              _bankjsr $d51c, 0
                             
c496 :                       _rtc_nvread
                              _bankjsr $d636, 0
                             
c4ae :                       _rtc_nvwrite
                              _bankjsr $d61e, 0
                             
c4c6 :                       _fs_dir_fhandle_str
AS65 Assembler for R6502 [1.42].                                     Page   25
---------------------------------- bank3.s -----------------------------------

                              _bankjsr $d642, 2
                             
c4de :                       _sd_sendcmd17
                              _bankjsr $cdc0, 2
                             
c4f6 :                       _sd_sendcmd24
                              _bankjsr $ce39, 2
                             
c50e :                       _cmd_immediate
                              _bankjsr $cbe8, 0
                             
c526 :                       _PT3INIT
                              _bankjsr $e009, 3
                             
c53e :                       _PT3START
                              _bankjsr $e000, 3
                             
c556 :                       _PT3PAUSE
                              _bankjsr $e003, 3
                             
c56e :                       _PT3RESUME
                              _bankjsr $e006, 3
                             
c586 :                       mod_sz_autogen_e
                             
                             	
c586 :                       mod_sz_kernel_s
                             
                             ;* Include all common code in the right order
                             	include "io\io.s"
                             ;************************************************
                             ;*
                             ;*	BBC-128 HOMEBREW COMPUTER
                             ;*	Hardware and software design by @6502Nerd (Dol
                             ;*	Copyright 2014-20
                             ;*  Free to use for any non-commercial purpose su
                             ;*  appropriate credit of my authorship please!
                             ;*
                             ;*  IO.S
                             ;*  General IO module.  Allows different IO devic
                             ;*  utilised transparently by the rest of the cod
                             ;*  Other code should use "io_" commands so that 
                             ;*  do not need to know what specific device is p
                             ;*  input and output capabilities.  On startup, t
                             ;*  examines the BBC DIP switch to decide whether
                             ;*  initialise the IO to serial through the ACIA 
                             ;*  the BBC keyboard for input with the VDP for o
                             ;*  Loading and saving files from the SD card is 
                             ;*  achieved by pointing to SD card get and put b
                             ;*  routines.
                             ;*
                             ;************************************************
                             
                             	; ROM code
                             	code
                             
c586 :                       mod_sz_io_s
                             
                             ;****************************************
                             ;* io_init
                             ;* Initialise the default device and make active
                             ;* No keys pressed = serial (default)
AS65 Assembler for R6502 [1.42].                                     Page   26
---------------------------------- bank3.s -----------------------------------

                             ;* F0 pressed = KB/VDP
                             ;* F1 pressed = Serial
                             ;* Keyboard and screen or serial port
                             ;* Output : None
                             ;* Regs affected : P, A
                             ;****************************************
c586 :                       io_init
c586 : a900             [ 2] 	lda #0				; Assume it's serial
c588 : 48               [ 3] 	pha
c589 : 209ec2           [ 6] 	jsr _kb_read_dip	; Check DIPs if 0xff then assum
c58c : 2910             [ 2] 	and #0x10
c58e : d00b             [ 3] 	bne io_init_set_default
c590 : 2086c2           [ 6] 	jsr _kb_read_raw	; Check pressed key
c593 : e081             [ 2] 	cpx #0x81			; f1 key pressed (i.e. boot up in se
c595 : f004             [ 3] 	beq io_init_set_default
                             	; Else set to KB/screen for IO
c597 : 68               [ 4] 	pla
c598 : a901             [ 2] 	lda #1
c59a : 48               [ 3] 	pha
c59b :                       io_init_set_default
c59b : 68               [ 4] 	pla
c59c : 8d000c           [ 4] 	sta io_default
c59f : 4ca2c5           [ 3] 	jmp io_set_default	; Activate the default device
                             
                             ;****************************************
                             ;* io_set_default, io_active_device
                             ;* Activate device based on default or A
                             ;* Input : A = Device number
                             ;* Output : None
                             ;* Regs affected : P, A
                             ;****************************************
c5a2 :                       io_set_default			; Entry point for default
c5a2 : ad000c           [ 4] 	lda io_default
c5a5 :                       io_active_device		; Entry point for A set
c5a5 : 0a               [ 2] 	asl	a				; x16 the Block number
c5a6 : 0a               [ 2] 	asl a
c5a7 : 0a               [ 2] 	asl a
c5a8 : 0a               [ 2] 	asl a
c5a9 : a8               [ 2] 	tay
c5aa : a200             [ 2] 	ldx #0
                             	; Copy device settings to io block
c5ac :                       io_copy_data
c5ac : b920c6           [ 4] 	lda io_devices,y
c5af : 9d010c           [ 5] 	sta io_block,x
c5b2 : c8               [ 2] 	iny
c5b3 : e8               [ 2] 	inx
c5b4 : e010             [ 2] 	cpx #io_struct
c5b6 : d0f4             [ 3] 	bne io_copy_data
                             	
c5b8 : a90d             [ 2] 	lda #UTF_CR		; Line terminator is CR
c5ba : 854a             [ 3] 	sta buf_ef
c5bc : 60               [ 6] 	rts
                             
                             ;****************************************
                             ;* io_get_ch
                             ;* Get a char (wait forever or just check)
                             ;* Input : C = 1 for synchronous, 0 for async
                             ;* Output : A = Byte code, C = 0 means A is inval
                             ;* Regs affected : P, A
                             ;****************************************
c5bd :                       io_get_ch
c5bd : 6c010c           [ 6] 	jmp (io_block+io_get_byte)
AS65 Assembler for R6502 [1.42].                                     Page   27
---------------------------------- bank3.s -----------------------------------

                             	
                             
                             ;****************************************
                             ;* io_put_ch
                             ;* Put a char
                             ;* Input : A = char
                             ;* Regs affected : P, A
                             ;****************************************
c5c0 :                       io_put_ch
c5c0 : 6c030c           [ 6] 	jmp (io_block+io_put_byte)
                             	
                             ;****************************************
                             ;* io_open_read
                             ;* Open for reading
                             ;* Input : X,A = pointer to filename (zero termin
                             ;* Output : C=0 success
                             ;* Regs affected : All
                             ;****************************************
c5c3 :                       io_open_read
c5c3 : 6c050c           [ 6] 	jmp (io_block+io_open_r)
                             	
                             ;****************************************
                             ;* io_open_write
                             ;* Open for reading
                             ;* Input : X,A = pointer to filename (zero termin
                             ;* Output : C=0 success
                             ;* Regs affected : All
                             ;****************************************
c5c6 :                       io_open_write
c5c6 : 6c070c           [ 6] 	jmp (io_block+io_open_w)
                             
                             ;****************************************
                             ;* io_close
                             ;* Close a file
                             ;* Input : 
                             ;* Output : C=0 success
                             ;* Regs affected : All
                             ;****************************************
c5c9 :                       io_close
c5c9 : 6c090c           [ 6] 	jmp (io_block+io_close_f)
                             	
                             ;****************************************
                             ;* io_delete
                             ;* Delete a file
                             ;* Input : 
                             ;* Output : C=0 success
                             ;* Regs affected : All
                             ;****************************************
c5cc :                       io_delete
c5cc : 6c0b0c           [ 6] 	jmp (io_block+io_del_f)
                             	
                             ;****************************************
                             ;* io_read_line
                             ;* Read a line, terminated by terminating char or
                             ;* Input : buf_(sz/ef) : Address, Max size, end m
                             ;*		    X,A = destination (uses buf_adr)
                             ;*		    Y=max line length
                             ;* Output : Y = Line length C = Buffer limit reac
                             ;* Regs affected : None
                             ;****************************************
c5cf :                       io_read_line
c5cf : 8647             [ 3] 	stx buf_adr			; Save pointer to storage
AS65 Assembler for R6502 [1.42].                                     Page   28
---------------------------------- bank3.s -----------------------------------

c5d1 : 8548             [ 3] 	sta buf_adr+1
c5d3 : 8449             [ 3] 	sty buf_sz			; Max length
c5d5 : 08               [ 3] 	php					; Save echo state
c5d6 : a000             [ 2] 	ldy #0x00			; Starting at first byte
c5d8 :                       io_get_line_byte
c5d8 : 38               [ 2] 	sec					; Getting bytes synchronously
c5d9 : 20bdc5           [ 6] 	jsr io_get_ch		; Get a byte
c5dc : b026             [ 4] 	bcs io_get_line_done; Got nothing then finish
c5de : 28               [ 4] 	plp					; Get echo state
c5df : 08               [ 3] 	php					; Instantly save it back
c5e0 : 900c             [ 3] 	bcc io_skip_echo	; Carry not set = don't echo
c5e2 : c97f             [ 2] 	cmp #UTF_DEL		; Delete?
c5e4 : d005             [ 3] 	bne io_do_echo
c5e6 : c000             [ 2] 	cpy #0				; Already at beginning?
c5e8 : f004             [ 3] 	beq io_skip_echo	; Don't echo delete
c5ea : 88               [ 2] 	dey					; Else decrement length
c5eb :                       io_do_echo
c5eb : 20c0c5           [ 6] 	jsr io_put_ch		; Echo it
c5ee :                       io_skip_echo
c5ee : c920             [ 2] 	cmp #UTF_SPECIAL	; Special character?
c5f0 : 9007             [ 3] 	bcc io_skip_special	; Skip if so (don't add to b
c5f2 : c97f             [ 2] 	cmp #UTF_DEL		; Don't proces DEL either
c5f4 : f003             [ 3] 	beq io_skip_special
c5f6 : 9147             [ 5] 	sta (buf_adr),y		; Save it
c5f8 : c8               [ 2] 	iny					; Increase length
c5f9 :                       io_skip_special
c5f9 : c54a             [ 3] 	cmp buf_ef			; Is it the terminating char?
c5fb : f007             [ 4] 	beq io_get_line_done	; If yes then done
c5fd : c449             [ 3] 	cpy buf_sz			; Reached the buffer max size?
c5ff : d0d7             [ 3] 	bne io_get_line_byte	; No, get another byte
c601 : 28               [ 4] 	plp					; Remember to pull echo state off stack
c602 : 38               [ 2] 	sec					; Yes, set carry flag
c603 : 60               [ 6] 	rts					; And done
c604 :                       io_get_line_done
c604 : a900             [ 2] 	lda #0
c606 : 9147             [ 5] 	sta (buf_adr),y		; Terminate with 0
c608 : 28               [ 4] 	plp					; Remember to pull echo state off stack
c609 : 18               [ 2] 	clc					; Clear carry flag
c60a : 60               [ 6] 	rts					; Fin
                             
                             ;****************************************
                             ;* io_print_line
                             ;* Print a line (when data is not already in seri
                             ;* Input : X = Address Lo, A = Address Hi
                             ;* Output : Y=number chars output
                             ;* Regs affected : All
                             ;****************************************
c60b :                       io_print_line
c60b : 48               [ 3] 	pha
                             
c60c : 863d             [ 3] 	stx tmp_c					; Store the string pointer
c60e : 853e             [ 3] 	sta tmp_c+1					; lo and hi
c610 : a000             [ 2] 	ldy #0						; Start at the beginning!
c612 :                       io_print_line_byte
c612 : b13d             [ 5] 	lda (tmp_c),y				; Copy byte to
c614 : f006             [ 3] 	beq io_print_done			; If zero then done - print
c616 : 20c0c5           [ 6] 	jsr io_put_ch				; Transmit
c619 : c8               [ 2] 	iny
c61a : d0f6             [ 3] 	bne io_print_line_byte		; Carry on until zero fo
c61c :                       io_print_done
c61c : 68               [ 4] 	pla
c61d : 60               [ 6] 	rts
AS65 Assembler for R6502 [1.42].                                     Page   29
---------------------------------- bank3.s -----------------------------------

                             
                             
                             ;*** Null operation just clc and return ***
c61e :                       io_null_op
c61e : 18               [ 2] 	clc
c61f : 60               [ 6] 	rts
                             	
                             ;* IO devices defined here
c620 :                       io_devices
                             ;* Device zero is the serial port
                             ;* only offers get and put
c620 :                       io_device0					; Serial device, input = Ser, outp
c620 : 66c1                  	dw	_get_byte			; io_get_ch
c622 : 7ec1                  	dw	_put_byte			; io_put_ch
c624 : 1ec6                  	dw	io_null_op			; io_open_r
c626 : 1ec6                  	dw	io_null_op			; io_open_w
c628 : 1ec6                  	dw	io_null_op			; io_close_f
c62a : 1ec6                  	dw	io_null_op			; io_del_f
c62c : 1ec6                  	dw	io_null_op			; io_ext1
c62e : 1ec6                  	dw	io_null_op			; io_ext2
                             ;* Device one is keyboard / screen
                             ;* only offers get and put
c630 :                       io_device1					; Default device, input = screen e
c630 : 96c1                  	dw	_gr_get_key			; io_get_ch
c632 : aec1                  	dw	_gr_put_byte		; io_put_ch
c634 : 1ec6                  	dw	io_null_op			; io_open_r
c636 : 1ec6                  	dw	io_null_op			; io_open_w
c638 : 1ec6                  	dw	io_null_op			; io_close_f
c63a : 1ec6                  	dw	io_null_op			; io_del_f
c63c : 1ec6                  	dw	io_null_op			; io_ext1
c63e : 1ec6                  	dw	io_null_op			; io_ext2
                             ;* Device two is the file system on SD card
                             ;* Offers all IO functions
c640 :                       io_device2					; SD device, input = SD, output = 
c640 : bec0                  	dw	_fs_get_byte_w		; io_get_ch
c642 : 06c1                  	dw	_fs_put_byte_w		; io_put_ch
c644 : d6c0                  	dw	_fs_open_read_w		; io_open_r
c646 : eec0                  	dw	_fs_open_write_w	; io_open_w
c648 : a6c0                  	dw	_fs_close_w			; io_close_f
c64a : 8ec0                  	dw	_fs_delete_w		; io_del_f
c64c : 1ec6                  	dw	io_null_op			; io_ext1
c64e : 1ec6                  	dw	io_null_op			; io_ext2
                             
c650 :                       mod_sz_io_e
                             
                             
                             	include "kernel\vdp-low.s"
                             ;************************************************
                             ;*
                             ;*	BBC-128 HOMEBREW COMPUTER
                             ;*	Hardware and software design by @6502Nerd (Dol
                             ;*	Copyright 2014-20
                             ;*  Free to use for any non-commercial purpose su
                             ;*  appropriate credit of my authorship please!
                             ;*
                             ;*  VDP-LOW.S
                             ;*  Low level VDP routines which will always be p
                             ;*  every ROM bank.  This is to ensure if IRQ nee
                             ;*  no slow bank switching is needed, but also to
                             ;*	OS vectored access to VDP routines for M/C fro
                             ;*
                             ;************************************************
AS65 Assembler for R6502 [1.42].                                     Page   30
---------------------------------- bank3.s -----------------------------------

                             
                             ;****************************************
                             ;* vdp_wr_reg
                             ;* Write to Register A the value X
                             ;* Input : A - Register Number, X - Data
                             ;* Output : None
                             ;* Regs affected : P
                             ;****************************************
c650 :                       vdp_wr_reg
c650 : 8e0105           [ 4] 	stx VDP_MODE1
                             ; Extra nop for fast CPU
c653 : ea               [ 2] 	nop
c654 : ea               [ 2] 	nop
c655 : 0980             [ 2] 	ora #0x80
c657 : 8d0105           [ 4] 	sta VDP_MODE1
c65a : 4980             [ 2] 	eor #0x80
c65c : 60               [ 6] 	rts
                             	
                             ;****************************************
                             ;* vdp_wr_addr
                             ;* Write to address in X (low) and A (high) - for
                             ;* Input : A - Address high byte, X - Address low
                             ;* Output : None
                             ;* Regs affected : P
                             ;****************************************
c65d :                       vdp_wr_addr
c65d : 8e0105           [ 4] 	stx VDP_MODE1
                             ; Extra nop for fast CPU
c660 : ea               [ 2] 	nop
c661 : ea               [ 2] 	nop
c662 : ea               [ 2] 	nop
c663 : 0940             [ 2] 	ora #0x40		; Required by VDP
c665 : 8d0105           [ 4] 	sta VDP_MODE1
c668 : 4940             [ 2] 	eor #0x40		; Undo that bit
c66a : 60               [ 6] 	rts
                             
                             
                             ;****************************************
                             ;* vdp_mem_wait
                             ;* Delay some time before a memory access,
                             ;* taking in to account mode 9918 needs up
                             ;* to 3.1uS for text mode, 8uS for graphics
                             ;* I and II
                             ;* @ 5.35Mhz	= 16 cycles for 3.1uS
                             ;*				= 43 cycles for 8uS
                             ;* Input : None
                             ;* Output : None
                             ;* Regs affected : None
                             ;****************************************
c66b :                       vdp_mem_wait
c66b : da               [ 3] 	phx								; 3
c66c : a616             [ 3] 	ldx vdp_delay					; 3
c66e : f003             [ 3] 	beq vdp_mem_wait_end			; 3
c670 :                       vdp_mem_wait_loop
c670 : ca               [ 2] 	dex								; 2
c671 : d0fd             [ 3] 	bne	vdp_mem_wait_loop			; 3
c673 :                       vdp_mem_wait_end
c673 : fa               [ 4] 	plx								; 3
c674 : 60               [ 6] 	rts								; 6
                             	
                             ;****************************************
                             ;* vdp_rd_addr
AS65 Assembler for R6502 [1.42].                                     Page   31
---------------------------------- bank3.s -----------------------------------

                             ;* Set read address 
                             ;* Input : A - high, X - low 
                             ;* Output : None
                             ;* Regs affected : None
                             ;****************************************
c675 :                       vdp_rd_addr
c675 : 8e0105           [ 4] 	stx VDP_MODE1
                             ; These nops are needed for fast CPU
c678 : ea               [ 2] 	nop
c679 : ea               [ 2] 	nop
c67a : ea               [ 2] 	nop
c67b : 8d0105           [ 4] 	sta VDP_MODE1
c67e : 80eb             [ 3] 	bra vdp_mem_wait
                             	
                             ;****************************************
                             ;* vdp_rd_vram
                             ;* Read VRAM byte, result in A
                             ;* Input : None
                             ;* Output : A - Byte from VRAM
                             ;* Regs affected : P
                             ;****************************************
c680 :                       vdp_rd_vram
c680 : ad0005           [ 4] 	lda VDP_VRAM
c683 : 80e6             [ 3] 	bra vdp_mem_wait
                             	
                             ;****************************************
                             ;* vdp_wr_vram
                             ;* Write VRAM byte in A
                             ;* Input : A - Byte to write
                             ;* Output : None
                             ;* Regs affected : None
                             ;****************************************
c685 :                       vdp_wr_vram
c685 : 8d0005           [ 4] 	sta VDP_VRAM
c688 : 80e1             [ 3] 	bra vdp_mem_wait
                             	
                             ;****************************************
                             ;* vdp_poke
                             ;* Write VRAM byte in A, (YX)
                             ;* Input : A - Byte to write
                             ;*		   X = Low Address
                             ;*		   Y = High Address
                             ;* Output : None
                             ;* Regs affected : None
                             ;****************************************
c68a :                       vdp_poke
c68a : 08               [ 3] 	php
c68b : 48               [ 3] 	pha
c68c : 98               [ 2] 	tya
c68d : 78               [ 2] 	sei
c68e : 205dc6           [ 6] 	jsr vdp_wr_addr
c691 : 68               [ 4] 	pla
c692 : 2085c6           [ 6] 	jsr vdp_wr_vram
c695 : 28               [ 4] 	plp
c696 : 60               [ 6] 	rts
                             
                             ;****************************************
                             ;* vdp_peek
                             ;* Get VRAM byte in (AX)
                             ;*		   X = Low Address
                             ;*		   A = High Address
                             ;* Output : A = byte read
AS65 Assembler for R6502 [1.42].                                     Page   32
---------------------------------- bank3.s -----------------------------------

                             ;* Regs affected : None
                             ;****************************************
c697 :                       vdp_peek
c697 : 08               [ 3] 	php
c698 : 78               [ 2] 	sei
c699 : 2075c6           [ 6] 	jsr vdp_rd_addr
c69c : 2080c6           [ 6] 	jsr vdp_rd_vram
c69f : 28               [ 4] 	plp
c6a0 : 60               [ 6] 	rts
                             
                             	include "kernel\snd-low.s"
                             ;************************************************
                             ;*
                             ;*	BBC-128 HOMEBREW COMPUTER
                             ;*	Hardware and software design by @6502Nerd (Dol
                             ;*	Copyright 2014-20
                             ;*  Free to use for any non-commercial purpose su
                             ;*  appropriate credit of my authorship please!
                             ;*
                             ;*  SND-LOW.S
                             ;*  Low level sound routines which will always be
                             ;*  in every ROM bank.  Mainly to provide fast OS
                             ;*	access to VDP routines for M/C from BASIC
                             ;*
                             ;************************************************
                             
                             ;****************************************
                             ;* snd_set
                             ;* Set AY register X to value Y
                             ;* Input : X = Reg no, Y = Value
                             ;* Output : None
                             ;* Regs affected : None
                             ;****************************************
c6a1 :                       snd_set
c6a1 : 48               [ 3] 	pha
                             
c6a2 : a9ff             [ 2] 	lda #0xff				; Set Port A to output
c6a4 : 8d8304           [ 4] 	sta IO_1 + DDRA
                             
c6a7 : 8e8104           [ 4] 	stx SND_ADBUS			; Put X on the sound bus (X = re
                             
c6aa : ad8004           [ 4] 	lda SND_MODE			; Need to preserve contents of ot
c6ad : 29bd             [ 2] 	and #SND_DESELECT_MASK	; Mask off mode bits
c6af : 0942             [ 2] 	ora #SND_SELSETADDR		; Select AY mode to latch a
c6b1 : 8d8004           [ 4] 	sta SND_MODE			; This write will process the dat
                             
c6b4 : 29bd             [ 2] 	and #SND_DESELECT_MASK	; Mask off mode bits
c6b6 : 8d8004           [ 4] 	sta SND_MODE			; This write will deselect the AY
                             	
c6b9 : 8c8104           [ 4] 	sty SND_ADBUS			; Put Y on the sound bus (Y = va
c6bc : 0902             [ 2] 	ora #SND_SELWRITE		; Select mode for writing dat
c6be : 8d8004           [ 4] 	sta SND_MODE			; This write will process the dat
                             	
c6c1 : 29bd             [ 2] 	and #SND_DESELECT_MASK	; Mask off mode bits
c6c3 : 8d8004           [ 4] 	sta SND_MODE			; This write will deselect the AY
                             
c6c6 : 68               [ 4] 	pla
                             	
c6c7 : 60               [ 6] 	rts
                             
                             ;****************************************
                             ;* snd_get
AS65 Assembler for R6502 [1.42].                                     Page   33
---------------------------------- bank3.s -----------------------------------

                             ;* Get AY register X to Y
                             ;* Input : X = Reg no
                             ;* Output : Y = Value
                             ;* Regs affected : None
                             ;****************************************
c6c8 :                       snd_get
c6c8 : 48               [ 3] 	pha
                             
c6c9 : a9ff             [ 2] 	lda #0xff				; Set Port A to output
c6cb : 8d8304           [ 4] 	sta IO_1 + DDRA
                             
c6ce : 8e8104           [ 4] 	stx SND_ADBUS			; Put X on the sound bus (X = re
                             
c6d1 : ad8004           [ 4] 	lda SND_MODE			; Need to preserve contents of ot
c6d4 : 29bd             [ 2] 	and #SND_DESELECT_MASK	; Mask off mode bits
c6d6 : 0942             [ 2] 	ora #SND_SELSETADDR		; Select AY mode to latch a
c6d8 : 8d8004           [ 4] 	sta SND_MODE			; This write will process the dat
                             
c6db : 29bd             [ 2] 	and #SND_DESELECT_MASK	; Mask off mode bits
c6dd : 8d8004           [ 4] 	sta SND_MODE			; This write will deselect the AY
                             
c6e0 : a900             [ 2] 	lda #0x00				; Set Port A to input
c6e2 : 8d8304           [ 4] 	sta IO_1 + DDRA
                             
c6e5 : ad8004           [ 4] 	lda SND_MODE			; Need to preserve contents of ot
c6e8 : 29bd             [ 2] 	and #SND_DESELECT_MASK	; Mask off mode bits
c6ea : 0940             [ 2] 	ora #SND_SELREAD		; Select mode for reading data
c6ec : 8d8004           [ 4] 	sta SND_MODE			; This write will process the dat
                             
c6ef : ac8104           [ 4] 	ldy SND_ADBUS			; Get value in to Y
                             	
c6f2 : 29bd             [ 2] 	and #SND_DESELECT_MASK	; Mask off mode bits
c6f4 : 8d8004           [ 4] 	sta SND_MODE			; This write will deselect the AY
                             
c6f7 : 68               [ 4] 	pla
                             	
c6f8 : 60               [ 6] 	rts
                             
                             ;****************************************
                             ;* snd_get_joy0
                             ;* Return value of joystick 0
                             ;* Input : None
                             ;* Output : Y = Value
                             ;* Regs affected : X
                             ;****************************************
c6f9 :                       snd_get_joy0
c6f9 : a20f             [ 2] 	ldx #SND_REG_IOB		; Joystick is plugged in to IO
c6fb : 20c8c6           [ 6] 	jsr snd_get				; Get IOB, result in Y
c6fe : 60               [ 6] 	rts
                             
                             	include "kernel\main.s"
                             ;************************************************
                             ;*
                             ;*	BBC-128 HOMEBREW COMPUTER
                             ;*	Hardware and software design by @6502Nerd (Dol
                             ;*	Copyright 2014-20
                             ;*  Free to use for any non-commercial purpose su
                             ;*  appropriate credit of my authorship please!
                             ;*
                             ;*  MAIN.S
                             ;*  This is where the main user program is execut
                             ;*  the 'kernel' once the system is initialised a
AS65 Assembler for R6502 [1.42].                                     Page   34
---------------------------------- bank3.s -----------------------------------

                             ;*  Today, main does very little - first shows th
                             ;*  boot up message, and then passes control to d
                             ;*
                             ;************************************************
                             
                             	; ROM code
                             	code  
                             
c6ff :                       main
                             
c6ff :                       infinity
c6ff : 2046c0           [ 6] 	jsr _df_pg_dflat
c702 : 4cffc6           [ 3] 	jmp infinity
                             
c705 :                       msg_hello_world
                             	;* build.s is generated by the assemble.bat file
                             	;* all it does is echo an assembler line to
                             	;* including the build date in the message.
                             	include "kernel\build.s"
c705 : 4275696c64203a..       db "Build : 23-01-2025\r"
c718 : 3132384b204272..       db "128K Breadboard Computer\r"
c731 : 42792040363530..       db "By @6502Nerd\r"
c73e : 436f7079726967..       db "Copyright (c) 2025\r",0
                             
                             
                             	include "kernel\irq.s"
                             	
                             ;************************************************
                             ;*
                             ;*	BBC-128 HOMEBREW COMPUTER
                             ;*	Hardware and software design by @6502Nerd (Dol
                             ;*	Copyright 2014-20
                             ;*  Free to use for any non-commercial purpose su
                             ;*  appropriate credit of my authorship please!
                             ;*
                             ;*  IRQ.S
                             ;*	This is the IRQ handler - handles both the ver
                             ;*  blank interrupt from the VDP as well as softw
                             ;*  
                             ;*  As the handler has to be in every bank and it
                             ;*  accesses the VDP, then low level VDP routines
                             ;*  bundled in this file to ensure they are alway
                             ;*  without a bank switch being needed (which is 
                             ;************************************************
                             
                             ;* NMI handler installs to handle serial receive 
c752 :                       init_nmi
                             	; Core IRQ handler
c752 : a963             [ 2] 	lda #lo(nmi)
c754 : 8502             [ 3] 	sta int_nmi
c756 : a9c7             [ 2] 	lda #hi(nmi)
c758 : 8503             [ 3] 	sta int_nmi+1
                             
c75a : a9d3             [ 2] 	lda #lo(null_handler)
c75c : 850c             [ 3] 	sta int_usercia1
c75e : a9c7             [ 2] 	lda #hi(null_handler)
c760 : 850d             [ 3] 	sta int_usercia1+1
                             
c762 : 60               [ 6] 	rts
                             
                             ;* Calls the master IRQ handler
c763 :                       call_nmi_master
AS65 Assembler for R6502 [1.42].                                     Page   35
---------------------------------- bank3.s -----------------------------------

                             ;	jmp (int_nmi)
                             
                             ;* Master NMI handler
                             ;* 6551 uses this - fills the receive buffer
                             ;* VIA 2 uses this- user interrupt
c763 :                       nmi
c763 : 48               [ 3] 	pha
                             
c764 : ad8105           [ 4] 	lda SER_STATUS				; Read status register (clears
c767 : 100c             [ 3] 	bpl	nmi_skip_acia			; If no interrupt don't do a
                             
c769 : 5a               [ 3] 	phy
c76a : ad8005           [ 4] 	lda SER_DATA				; Read the data register of 6551
c76d : a40f             [ 3] 	ldy ser_last				; Put byte in last position of F
c76f : 990008           [ 5] 	sta ser_buf,y
c772 : e60f             [ 5] 	inc ser_last				; Advance position of last
                             
c774 : 7a               [ 4] 	ply
c775 :                       nmi_skip_acia
                             	;* Try PIA1 first for rapid Timer handling
c775 : ad8d04           [ 4] 	lda IO_1 + IFR
c778 : 1026             [ 3] 	bpl nmi_fin
c77a : 5a               [ 3] 	phy
c77b : da               [ 3] 	phx
                             	; Reset interrupt by reading T1C-L
c77c : ad8404           [ 4] 	lda IO_1+T1CL
                             	; Swtich to RAM bank 2 don't touch anything else
c77f : ad0004           [ 4] 	lda IO_0+PRB
c782 : 48               [ 3] 	pha                     ; Remember the bank #
c783 : 29cf             [ 2] 	and #0b11001111
c785 : 0920             [ 2] 	ora #0b00100000
c787 : 8d0004           [ 4] 	sta IO_0+PRB
                             	; Switch out ROM for RAM
c78a : ad8004           [ 4] 	lda IO_1+PRB                    ; Get current RO
c78d : 48               [ 3] 	pha
c78e : 29df             [ 2] 	and #(0xff ^ MM_DIS)            ; Switch off ROM
c790 : 8d8004           [ 4] 	sta IO_1+PRB                    ; Update port to
c793 : 20cfc7           [ 6] 	jsr call_irq_usercia1			; Call user cia1 handler
                             	; Restore ROM
c796 : 68               [ 4] 	pla                             ; Get original p
c797 : 8d8004           [ 4] 	sta IO_1+PRB                    ; Update port to
                             	; Restore RAM bank
c79a : 68               [ 4] 	pla                             ; Get original p
c79b : 8d0004           [ 4] 	sta IO_0+PRB                    ; Update port to
c79e : fa               [ 4] 	plx
c79f : 7a               [ 4] 	ply
c7a0 :                       nmi_fin
c7a0 : 68               [ 4] 	pla
c7a1 : 40               [ 6] 	rti
                             
                             
                             ;* Obviously this can only be done with
                             ;* interrupts disabled!
c7a2 :                       init_irq
                             	; Core IRQ handler
c7a2 : a9d4             [ 2] 	lda #lo(irq)
c7a4 : 8504             [ 3] 	sta int_irq
c7a6 : a9c7             [ 2] 	lda #hi(irq)
c7a8 : 8505             [ 3] 	sta int_irq+1
                             	
                             	; Core BRK handler
c7aa : a9fa             [ 2] 	lda #lo(irq_brk)
AS65 Assembler for R6502 [1.42].                                     Page   36
---------------------------------- bank3.s -----------------------------------

c7ac : 8506             [ 3] 	sta int_brk
c7ae : a9c7             [ 2] 	lda #hi(irq_brk)
c7b0 : 8507             [ 3] 	sta int_brk+1
                             
                             	; User handlers for VDP, PIA0 interrupts
c7b2 : a9d3             [ 2] 	lda #lo(null_handler)
c7b4 : 8508             [ 3] 	sta int_uservdp
c7b6 : a9c7             [ 2] 	lda #hi(null_handler)
c7b8 : 8509             [ 3] 	sta int_uservdp+1
                             
c7ba : a9d3             [ 2] 	lda #lo(null_handler)
c7bc : 850a             [ 3] 	sta int_usercia0
c7be : a9c7             [ 2] 	lda #hi(null_handler)
c7c0 : 850b             [ 3] 	sta int_usercia0+1
                             
c7c2 : 60               [ 6] 	rts
                             
                             ;* Calls the master IRQ handler
c7c3 :                       call_irq_master
c7c3 : 6c0400           [ 6] 	jmp (int_irq)
                             	
                             ;* Calls the BRK handler
c7c6 :                       call_irq_brk
c7c6 : 6c0600           [ 6] 	jmp (int_brk)
                             
                             ;* Call the userVDP handler
c7c9 :                       call_irq_uservdp
c7c9 : 6c0800           [ 6] 	jmp (int_uservdp)
                             	
                             ;* Call the user CIA0 handler
c7cc :                       call_irq_usercia0
c7cc : 6c0a00           [ 6] 	jmp (int_usercia0)
                             
                             ;* Call the user CIA1 handler
c7cf :                       call_irq_usercia1
c7cf : 6c0c00           [ 6] 	jmp (int_usercia1)
                             	
                             ;* null interrupt
c7d2 :                       null_irq
c7d2 : 40               [ 6] 	rti
                             
                             ;* null handler
c7d3 :                       null_handler
c7d3 : 60               [ 6] 	rts
                             	
                             
                             ;* Master IRQ handler
c7d4 :                       irq
                             	_pushAXY
                             
                             
                             	; Check if IRQ or BRK
                             	; load P from stack in to A
c7d7 : ba               [ 2] 	tsx
c7d8 : bd0401           [ 4] 	lda 0x104,x
                             	; BRK bit set?
c7db : 2910             [ 2] 	and #0x10
c7dd : d0e7             [ 3] 	bne call_irq_brk
                             	
c7df : 18               [ 2] 	clc						; Standard behaviour
                             	
                             	;* Try VDP next
AS65 Assembler for R6502 [1.42].                                     Page   37
---------------------------------- bank3.s -----------------------------------

c7e0 :                       irq_check_vdp	
c7e0 : ad0105           [ 4] 	lda VDP_STATUS			; Read status register
c7e3 : 1009             [ 3] 	bpl	irq_check_cia0		; Skip if not VBLANK
c7e5 : 20c9c7           [ 6] 	jsr call_irq_uservdp	; Call use VDP handler
c7e8 : 2047c8           [ 6] 	jsr int_vdp_handler		; Call  OS VDP handler
c7eb : 2025c8           [ 6] 	jsr int_kb_handler		; Call OS cia0 handler (keyb
                             
                             	;* Try VIA0 last as it's keyboard (low speed)
c7ee :                       irq_check_cia0
c7ee : ad0d04           [ 4] 	lda IO_0 + IFR
c7f1 : 1003             [ 3] 	bpl irq_fin
c7f3 : 20ccc7           [ 6] 	jsr call_irq_usercia0	; Call user cia0 handler
                             
c7f6 :                       irq_fin
                             	_pullAXY
                             
c7f9 : 40               [ 6] 	rti
                             	
                             ;* Handle BRK
c7fa :                       irq_brk
                             	; Handle BRK
                             	; Get PCL,H minus 2 gives the BRK instruction ad
c7fa : 38               [ 2] 	sec
c7fb : bd0501           [ 4] 	lda 0x0105,x
c7fe : e902             [ 2] 	sbc #2
c800 : 85a4             [ 3] 	sta df_brkpc
c802 : bd0601           [ 4] 	lda 0x0106,x
c805 : e900             [ 2] 	sbc #0
c807 : 85a5             [ 3] 	sta df_brkpc+1
                             	; Get the byte pointed to by old PC
                             	; which is 1 on from the BRK
c809 : a001             [ 2] 	ldy #1
c80b : b1a4             [ 5] 	lda (df_brkpc),y
c80d : 85a6             [ 3] 	sta df_brkval
c80f : 859f             [ 3] 	sta errno
                             	; now update the return address
c811 : a5a2             [ 3] 	lda df_pc
c813 : 9d0501           [ 5] 	sta 0x105,x
c816 : a5a3             [ 3] 	lda df_pc+1
c818 : 9d0601           [ 5] 	sta 0x106,x
                             	
                             	_pullAXY
                             
                             	; Save the registers in temp area
c81e : 8585             [ 3] 	sta num_a
c820 : 8686             [ 3] 	stx num_a+1
c822 : 8487             [ 3] 	sty num_a+2
                             	; when RTI occurs:
                             	;  will return to error handler
                             	;  df_brkval will contain signature
c824 : 40               [ 6] 	rti
                             	
                             ;****************************************
                             ;* int_kb_handler
                             ;* Keyboard interrupt handler
                             ;****************************************
c825 :                       int_kb_handler	
c825 : a537             [ 3] 	lda kb_deb				; If keyboard pressed is debounce 
c827 : d00d             [ 3] 	bne int_skip_scan		; If not zero, then don't che
c829 : ad0d04           [ 4] 	lda IO_0 + IFR			; Check status register CIA0
c82c : 2901             [ 2] 	and #IFR_CA2			; Keyboard pressed?
c82e : f00c             [ 3] 	beq int_keys_up
AS65 Assembler for R6502 [1.42].                                     Page   38
---------------------------------- bank3.s -----------------------------------

c830 :                       int_do_read
c830 : 853c             [ 3] 	sta kb_pressed			; Put non-zero in to this flag
c832 : a53b             [ 3] 	lda kb_debounce			; Set debounce
c834 : 8537             [ 3] 	sta kb_deb
c836 :                       int_skip_scan
c836 : a901             [ 2] 	lda #IFR_CA2			; Clear CA2
c838 : 8d0d04           [ 4] 	sta IO_0 + IFR
c83b : 60               [ 6] 	rts
c83c :                       int_keys_up					; No key pressed
c83c : 6433             [ 3] 	stz kb_raw				; Using 65c02 stz opcode
c83e : 6434             [ 3] 	stz kb_last
c840 : 6435             [ 3] 	stz kb_code
c842 : 6437             [ 3] 	stz kb_deb
c844 : 6438             [ 3] 	stz kb_rep
c846 : 60               [ 6] 	rts
                             	
                             ;****************************************
                             ;* int_vdp_handler
                             ;* VDP interrupt handler
                             ;****************************************
c847 :                       int_vdp_handler
c847 : 2073c8           [ 6] 	jsr update_timers	; If it is then update system 
                             
c84a : a512             [ 3] 	lda vdp_curoff		; Is cursor enabled?
c84c : d024             [ 3] 	bne int_vdp_fin		; Skip if not
                             
c84e : c613             [ 5] 	dec vdp_curstat		; Decrement VDP counter
c850 : a513             [ 3] 	lda vdp_curstat		; Check it
c852 : 297f             [ 2] 	and #0x7f			; If bottom 7 bits !=0
c854 : d01c             [ 3] 	bne int_vdp_fin		; No flashing to be done
c856 : a513             [ 3] 	lda vdp_curstat		; Invert top bit (bottoms bits=
c858 : 4990             [ 2] 	eor #0x80+VDP_FLASH	; Start counter again
c85a : 8513             [ 3] 	sta vdp_curstat		
                             
c85c : 18               [ 2] 	clc					; Add offset for cursor address in vram
c85d : a52c             [ 3] 	lda gr_scrngeom+gr_cur_ptr
c85f : 6529             [ 3] 	adc gr_scrngeom+gr_cur_off
c861 : aa               [ 2] 	tax
c862 : a52d             [ 3] 	lda gr_scrngeom+gr_cur_ptr+1
c864 : 6900             [ 2] 	adc #0
                             
c866 : 205dc6           [ 6] 	jsr vdp_wr_addr
                             	
c869 : a513             [ 3] 	lda vdp_curstat
c86b : 2980             [ 2] 	and #0x80
c86d : 4514             [ 3] 	eor vdp_curval		; EOR top bit with what is under
c86f : 2085c6           [ 6] 	jsr vdp_wr_vram
c872 :                       int_vdp_fin	
c872 : 60               [ 6] 	rts
                             
                             
                             ;****************************************
                             ;* update_timers
                             ;* Update 24 bit timer and debounce counters
                             ;****************************************
c873 :                       update_timers
c873 : e610             [ 5] 	inc vdp_int_cnt
c875 : d002             [ 3] 	bne inc_kb_timers
c877 : e611             [ 5] 	inc vdp_int_cnt+1
c879 :                       inc_kb_timers
c879 : a637             [ 3] 	ldx kb_deb			; Is debounce 0?
c87b : f002             [ 3] 	beq skip_kb_deb
AS65 Assembler for R6502 [1.42].                                     Page   39
---------------------------------- bank3.s -----------------------------------

c87d : c637             [ 5] 	dec kb_deb
c87f :                       skip_kb_deb
c87f : a638             [ 3] 	ldx kb_rep			; Is repeat timer 0?
c881 : f002             [ 3] 	beq skip_kb_rep
c883 : c638             [ 5] 	dec kb_rep
c885 :                       skip_kb_rep
c885 : 60               [ 6] 	rts
                             	
                             
                             	include "utils\misc.s"
                             ;************************************************
                             ;*
                             ;*	BBC-128 HOMEBREW COMPUTER
                             ;*	Hardware and software design by @6502Nerd (Dol
                             ;*	Copyright 2014-20
                             ;*  Free to use for any non-commercial purpose su
                             ;*  appropriate credit of my authorship please!
                             ;*
                             ;*  MISC.S
                             ;*  Miscellaneous module for commmon utility func
                             ;*
                             ;************************************************
                             
                             	; ROM code
                             	code
                             
                             ;****************************************
                             ;* long_delay
                             ;* Long delay (X decremented every 0.125ms)
                             ;* Input : X = number of 0.125ms ticks to wait (m
                             ;* Output : None
                             ;* Regs affected : None
                             ;****************************************
c886 :                       long_delay
c886 : 08               [ 3] 	php
                             	_pushAXY
                             
                             	
c88a : a000             [ 2] 	ldy #0x00
c88c :                       long_delay_1
c88c : ea               [ 2] 	nop
c88d : ea               [ 2] 	nop
c88e : ea               [ 2] 	nop
c88f : ea               [ 2] 	nop
c890 : 88               [ 2] 	dey
c891 : d0f9             [ 3] 	bne long_delay_1
c893 : ca               [ 2] 	dex
c894 : d0f6             [ 3] 	bne long_delay_1
                             
                             	_pullAXY
                             
c899 : 28               [ 4] 	plp
                             	
c89a : 60               [ 6] 	rts
                             
                             
                             	include "utils\utils.s"
                             ;************************************************
                             ;*
                             ;*	BBC-128 HOMEBREW COMPUTER
                             ;*	Hardware and software design by @6502Nerd (Dol
                             ;*	Copyright 2014-20
AS65 Assembler for R6502 [1.42].                                     Page   40
---------------------------------- bank3.s -----------------------------------

                             ;*  Free to use for any non-commercial purpose su
                             ;*  appropriate credit of my authorship please!
                             ;*
                             ;*  UTILS.S
                             ;*  This module implements various utility functi
                             ;*  converting from ASCII to binary form for numb
                             ;*  vice-versa to allow humans to actually be abl
                             ;*  and read numbers in their prefered form!
                             ;*
                             ;************************************************
                             
                             	; ROM code
                             	code
                             
c89b :                       utilPrintSPC
c89b : 48               [ 3] 	pha
c89c : a920             [ 2] 	lda #' '
c89e : 20c0c5           [ 6] 	jsr io_put_ch
c8a1 : 68               [ 4] 	pla
c8a2 : 60               [ 6] 	rts
                             
c8a3 :                       utilPrintCRLF
c8a3 : 48               [ 3] 	pha
c8a4 : a90d             [ 2] 	lda #UTF_CR
c8a6 : 20c0c5           [ 6] 	jsr io_put_ch
c8a9 : 68               [ 4] 	pla
c8aa : 60               [ 6] 	rts
                             
c8ab :                       utilPrintA
c8ab : 8545             [ 3] 	sta tmp_d
c8ad : 48               [ 3] 	pha
c8ae : 8a               [ 2] 	txa
c8af : 48               [ 3] 	pha
c8b0 : a545             [ 3] 	lda tmp_d
c8b2 : 20d0c8           [ 6] 	jsr str_a_to_x
c8b5 : 20c0c5           [ 6] 	jsr io_put_ch
c8b8 : 8a               [ 2] 	txa
c8b9 : 20c0c5           [ 6] 	jsr io_put_ch
c8bc : 68               [ 4] 	pla
c8bd : aa               [ 2] 	tax
c8be : 68               [ 4] 	pla
c8bf : 60               [ 6] 	rts
                             
                             ;****************************************
                             ;* util_clr_mem
                             ;* Clear a block of main ram
                             ;* Input : X, A = Block start, Y = Block size
                             ;* Regs affected : P
                             ;****************************************
c8c0 :                       util_clr_mem
c8c0 : 48               [ 3] 	pha
c8c1 : 5a               [ 3] 	phy
c8c2 : 863f             [ 3] 	stx tmp_v1
c8c4 : 8540             [ 3] 	sta tmp_v1+1
c8c6 : a900             [ 2] 	lda #0
c8c8 :                       mem_clr_byte
c8c8 : 88               [ 2] 	dey
c8c9 : 913f             [ 5] 	sta (tmp_v1),y
c8cb : d0fb             [ 3] 	bne mem_clr_byte
c8cd : 7a               [ 4] 	ply
c8ce : 68               [ 4] 	pla
c8cf : 60               [ 6] 	rts
AS65 Assembler for R6502 [1.42].                                     Page   41
---------------------------------- bank3.s -----------------------------------

                             
                             ;****************************************
                             ;* str_a_to_x
                             ;* Convert accumulator to hex string
                             ;* Input : A = Byte to convert
                             ;* Output : A = High Char, X = Low Char
                             ;* Regs affected : P
                             ;****************************************
c8d0 :                       str_a_to_x
c8d0 : 48               [ 3] 	pha					; Save the byte using later on
c8d1 : 290f             [ 2] 	and #0x0f			; Mask low nibble
c8d3 : 18               [ 2] 	clc
c8d4 : 6930             [ 2] 	adc #'0'			; Convert to UTF
c8d6 : c93a             [ 2] 	cmp #('9'+1)		; If A greater than '9' then
c8d8 : 9002             [ 3] 	bcc skip_a_f_1		; skip a-f adjustment
c8da : 6926             [ 2] 	adc #0x26			; Add 27 (6+C) to get in to A-F rang
c8dc :                       skip_a_f_1
c8dc : aa               [ 2] 	tax					; Low char is in X
c8dd : 68               [ 4] 	pla					; Get byte back
c8de : 4a               [ 2] 	lsr a				; Make high nibble low
c8df : 4a               [ 2] 	lsr a
c8e0 : 4a               [ 2] 	lsr a
c8e1 : 4a               [ 2] 	lsr a
c8e2 : 18               [ 2] 	clc
c8e3 : 6930             [ 2] 	adc #'0'			; Convert to UTF
c8e5 : c93a             [ 2] 	cmp #('9'+1)		; If A greater than '9' then
c8e7 : 9002             [ 3] 	bcc skip_a_f_2		; skip a-f adjustment
c8e9 : 6926             [ 2] 	adc #0x26			; Add 27 (6+C) to get in to A-F rang
c8eb :                       skip_a_f_2
                             
c8eb : 18               [ 2] 	clc					; No error
c8ec : 60               [ 6] 	rts					; A high nibble
                             
                             ;****************************************
                             ;* str_x_to_a
                             ;* Convert hex string to accumulator
                             ;* Input : A = High Char, X = Low Char
                             ;* Output : A = Value
                             ;* Regs affected : P
                             ;****************************************
c8ed :                       str_x_to_a
c8ed : 0920             [ 2] 	ora #0x20			; Make alpha in to lower case
c8ef : 38               [ 2] 	sec					; Process high char in A
c8f0 : e930             [ 2] 	sbc #'0'			; Convert to hex nibble
c8f2 : c90a             [ 2] 	cmp #10				; If A < 10 then
c8f4 : 9002             [ 3] 	bcc skip_x_f_1		; skip a-f adjustment
c8f6 : e927             [ 2] 	sbc #0x27			; Sub 7 to get in to A-F range
c8f8 :                       skip_x_f_1
c8f8 : c910             [ 2] 	cmp #0x10			; Nibble should be <= 0x0f
c8fa : b01d             [ 4] 	bcs	str_x_to_a_err	; Error if not
                             
c8fc : 0a               [ 2] 	asl a				; This is the high nibble
c8fd : 0a               [ 2] 	asl a
c8fe : 0a               [ 2] 	asl a
c8ff : 0a               [ 2] 	asl a
c900 : 48               [ 3] 	pha					; Save the high nibble
c901 : 8a               [ 2] 	txa					; Now process the low char in X
c902 : 0920             [ 2] 	ora #0x20			; Make alpha in to lower case
c904 : 38               [ 2] 	sec
c905 : e930             [ 2] 	sbc #'0'			; Convert to hex nibble
c907 : c90a             [ 2] 	cmp #10				; If A < 10 then
c909 : 9002             [ 3] 	bcc skip_x_f_2		; skip a-f adjustment
AS65 Assembler for R6502 [1.42].                                     Page   42
---------------------------------- bank3.s -----------------------------------

c90b : e927             [ 2] 	sbc #0x27			; Sub 7 to get in to A-F range
c90d :                       skip_x_f_2
c90d : c910             [ 2] 	cmp #0x10			; Nibble should be <= 0x0f
c90f : b007             [ 3] 	bcs	str_x_to_a_errl	; Error if not
                             
c911 : 8585             [ 3] 	sta num_a			; Store low nibble in temp
c913 : 68               [ 4] 	pla					; Get high nibble
c914 : 0585             [ 3] 	ora num_a			; OR with low nibble
                             
c916 : 18               [ 2] 	clc					; No error
c917 : 60               [ 6] 	rts					; A contains value
                             
c918 :                       str_x_to_a_errl
c918 : 68               [ 4] 	pla
c919 :                       str_x_to_a_err
                             	SWBRK CMD_ERR_VAL
                             
                             
                             ;****************************************
                             ;* con_n_to_a
                             ;* Convert numeric string to accumulator (unsigne
                             ;* Input : Pointer to string (X=L, A=H), Y = Sour
                             ;* Output : num_a, num_a+1 contains word, X=numbe
                             ;* A = Source type detected
                             ;* Regs affected : CS = Error
                             ;****************************************
c91b :                       con_n_to_a
c91b : 8691             [ 3] 	stx num_tmp
c91d : 8592             [ 3] 	sta num_tmp+1
c91f : 6485             [ 3] 	stz num_a
c921 : 6486             [ 3] 	stz num_a+1
c923 : c000             [ 2] 	cpy #NUM_ANY
c925 : f014             [ 3] 	beq con_n_to_a_detect
c927 : 88               [ 2] 	dey
c928 : d003             [ 3] 	bne con_n_not_dec
c92a :                       con_dec_jmp
c92a : 4cbec9           [ 3] 	jmp con_dec_to_a_int
c92d :                       con_n_not_dec
c92d : 88               [ 2] 	dey
c92e : d003             [ 3] 	bne con_n_not_hex
c930 :                       con_hex_jmp
c930 : 4c55c9           [ 3] 	jmp con_hex_to_a_int
c933 :                       con_n_not_hex
c933 : 88               [ 2] 	dey
c934 : d003             [ 3] 	bne con_n_err
c936 :                       con_bin_jmp
c936 : 4c94c9           [ 3] 	jmp con_bin_to_a_int
c939 :                       con_n_err
c939 : 38               [ 2] 	sec
c93a : 60               [ 6] 	rts
c93b :                       con_n_to_a_detect
c93b : b291             [ 5] 	lda (num_tmp)
c93d : c930             [ 2] 	cmp #'0'
c93f : d0e9             [ 3] 	bne con_dec_jmp
c941 : a001             [ 2] 	ldy #1
c943 : b191             [ 5] 	lda (num_tmp),y
c945 : 0920             [ 2] 	ora #0x20
c947 : c978             [ 2] 	cmp #'x'
c949 : f0e5             [ 3] 	beq con_hex_jmp
c94b : c962             [ 2] 	cmp #'b'
c94d : f0e7             [ 3] 	beq con_bin_jmp
c94f : 80d9             [ 3] 	bra con_dec_jmp
AS65 Assembler for R6502 [1.42].                                     Page   43
---------------------------------- bank3.s -----------------------------------

                             
                             ;****************************************
                             ;* con_hex_to_a
                             ;* Convert hex string to accumulator (unsigned)
                             ;* Input : Pointer to string (X=L, A=H)
                             ;* Output : num_a, num_a+1 contains word, X=numbe
                             ;* Regs affected : CS = Error
                             ;****************************************
c951 :                       con_hex_to_a
c951 : 8691             [ 3] 	stx num_tmp
c953 : 8592             [ 3] 	sta num_tmp+1
c955 :                       con_hex_to_a_int
c955 : a205             [ 2] 	ldx #5			; > 4 digits will cause error
c957 : a002             [ 2] 	ldy #2			; start at first digit
c959 :                       con_hex_digit
c959 : b191             [ 5] 	lda (num_tmp),y
c95b : 0920             [ 2] 	ora #0x20					; Make alpha in to lower case
c95d : 38               [ 2] 	sec							; Process high char in A
c95e : e930             [ 2] 	sbc #'0'					; Convert to hex nibble
c960 : c90a             [ 2] 	cmp #10						; If A < 10 then
c962 : 9002             [ 3] 	bcc con_hex_skip_x_f_1		; skip a-f adjustment
c964 : e927             [ 2] 	sbc #0x27					; Sub 7 to get in to A-F range
c966 :                       con_hex_skip_x_f_1
c966 : c910             [ 2] 	cmp #0x10					; Nibble should be <= 0x0f
c968 : b01c             [ 3] 	bcs	con_hex_done			; Potentially done if not
c96a : 48               [ 3] 	pha
                             	; make room for lo nibble
c96b : 0685             [ 5] 	asl num_a
c96d : 2686             [ 5] 	rol num_a+1
c96f : 0685             [ 5] 	asl num_a
c971 : 2686             [ 5] 	rol num_a+1
c973 : 0685             [ 5] 	asl num_a
c975 : 2686             [ 5] 	rol num_a+1
c977 : 0685             [ 5] 	asl num_a
c979 : 2686             [ 5] 	rol num_a+1
                             	; save in low nibble
c97b : 68               [ 4] 	pla
c97c : 0585             [ 3] 	ora num_a
c97e : 8585             [ 3] 	sta num_a
c980 : c8               [ 2] 	iny
c981 : ca               [ 2] 	dex
c982 : d0d5             [ 3] 	bne con_hex_digit
                             	; if got to a 5th digit then error
c984 :                       con_hex_err
c984 : 38               [ 2] 	sec
c985 : 60               [ 6] 	rts
                             	; found a non-hex digit
c986 :                       con_hex_done
                             	; if no digits processed then error
c986 : c002             [ 2] 	cpy #2
c988 : f0fa             [ 3] 	beq con_hex_err
                             	; move y to x for digits processed
c98a : 98               [ 2] 	tya
c98b : aa               [ 2] 	tax
c98c : a902             [ 2] 	lda #NUM_HEX
c98e : 18               [ 2] 	clc
c98f : 60               [ 6] 	rts
                             
                             ;****************************************
                             ;* con_bin_to_a
                             ;* Convert binary string to accumulator (unsigned
                             ;* Input : Pointer to string (X=L, A=H)
AS65 Assembler for R6502 [1.42].                                     Page   44
---------------------------------- bank3.s -----------------------------------

                             ;* Output : num_a, num_a+1 contains word, X=numbe
                             ;* Regs affected : CS = Error
                             ;****************************************
c990 :                       con_bin_to_a
c990 : 8691             [ 3] 	stx num_tmp
c992 : 8592             [ 3] 	sta num_tmp+1
c994 :                       con_bin_to_a_int
c994 : a002             [ 2] 	ldy #2
c996 : a211             [ 2] 	ldx #17						; Max 16 binary digits allowed
c998 :                       con_bin_digit
c998 : b191             [ 5] 	lda (num_tmp),y
c99a : c930             [ 2] 	cmp #'0'
c99c : 9010             [ 3] 	bcc con_bin_done
c99e : c932             [ 2] 	cmp #'1'+1
c9a0 : b00c             [ 3] 	bcs con_bin_done
                             	; sets C if '1' else resets C
c9a2 : 69cf             [ 2] 	adc #0xff-'0'
                             	; shift in digit
c9a4 : 2685             [ 5] 	rol num_a
c9a6 : 2686             [ 5] 	rol num_a+1
c9a8 : c8               [ 2] 	iny
c9a9 : ca               [ 2] 	dex
c9aa : d0ec             [ 3] 	bne con_bin_digit
                             	; on the 17th digit is too much, error
c9ac : 800a             [ 3] 	bra con_bin_err
c9ae :                       con_bin_done
                             	; didn't process any digit = error
c9ae : c002             [ 2] 	cpy #2
c9b0 : f006             [ 3] 	beq con_bin_err
                             	; put digits processed in to X
c9b2 : 98               [ 2] 	tya
c9b3 : aa               [ 2] 	tax
c9b4 : a903             [ 2] 	lda #NUM_BIN
c9b6 : 18               [ 2] 	clc
c9b7 : 60               [ 6] 	rts
c9b8 :                       con_bin_err
c9b8 : 38               [ 2] 	sec
c9b9 : 60               [ 6] 	rts
                             
                             ;****************************************
                             ;* con_d_to_a
                             ;* Convert decimal string to accumulator (SIGNED)
                             ;* Input : Pointer to string (X=L, A=H)
                             ;* Output : num_a, num_a+1 contains word, X=numbe
                             ;* Regs affected : CS = Error
                             ;****************************************
c9ba :                       con_dec_to_a
c9ba : 8691             [ 3] 	stx num_tmp
c9bc : 8592             [ 3] 	sta num_tmp+1
c9be :                       con_dec_to_a_int
c9be : a000             [ 2] 	ldy #0
                             	; Detect if leading minus sign
c9c0 : b291             [ 5] 	lda (num_tmp)
c9c2 : c92d             [ 2] 	cmp #'-'
c9c4 : d001             [ 3] 	bne str_d_find_end
                             	; skip over minus if found
c9c6 : c8               [ 2] 	iny
c9c7 :                       str_d_find_end
c9c7 : b191             [ 5] 	lda (num_tmp),y
c9c9 : c930             [ 2] 	cmp #'0'
c9cb : 9007             [ 3] 	bcc str_d_found_end
c9cd : c93a             [ 2] 	cmp #'9'+1
AS65 Assembler for R6502 [1.42].                                     Page   45
---------------------------------- bank3.s -----------------------------------

c9cf : b003             [ 3] 	bcs str_d_found_end
c9d1 : c8               [ 2] 	iny
c9d2 : 80f3             [ 3] 	bra str_d_find_end
c9d4 :                       str_d_found_end
c9d4 : c007             [ 2] 	cpy #6+1			; Biggest int is 6 chars
c9d6 : b052             [ 4] 	bcs str_d_error		; e.g. -32767 including minus
c9d8 : 8494             [ 3] 	sty num_tmp+3
c9da : 6493             [ 3] 	stz num_tmp+2
c9dc : 6485             [ 3] 	stz num_a
c9de : 6486             [ 3] 	stz num_a+1
c9e0 :                       str_d_process_digit
c9e0 : 88               [ 2] 	dey
c9e1 : 3026             [ 4] 	bmi str_d_digits_done
                             
c9e3 : b191             [ 5] 	lda (num_tmp),y
                             
c9e5 : c92d             [ 2] 	cmp #'-'			; Got to minus sign?
c9e7 : f020             [ 4] 	beq str_d_digits_done ; also done
                             
c9e9 : 38               [ 2] 	sec
c9ea : e930             [ 2] 	sbc #'0'
                             	; Convert digit to number
                             	; and then offset in to
                             	; look up table of powers
c9ec : 18               [ 2] 	clc
c9ed : 0a               [ 2] 	asl a
c9ee : 6593             [ 3] 	adc num_tmp+2
                             	; X contains index to powers
c9f0 : aa               [ 2] 	tax
c9f1 : a585             [ 3] 	lda num_a
c9f3 : 7d2cca           [ 4] 	adc str_d_powers,x
c9f6 : 8585             [ 3] 	sta num_a
c9f8 : a586             [ 3] 	lda num_a+1
c9fa : 7d2dca           [ 4] 	adc str_d_powers+1,x
c9fd : 8586             [ 3] 	sta num_a+1
c9ff : b029             [ 4] 	bcs str_d_error
                             	; Move to next power of 10 index
ca01 : a593             [ 3] 	lda num_tmp+2
ca03 : 6914             [ 2] 	adc #20
ca05 : 8593             [ 3] 	sta num_tmp+2
ca07 : 80d7             [ 4] 	bra str_d_process_digit
ca09 :                       str_d_digits_done
                             	; check if minus
ca09 : b291             [ 5] 	lda (num_tmp)
ca0b : c92d             [ 2] 	cmp #'-'
ca0d : d011             [ 3] 	bne str_d_skip_neg
ca0f : a694             [ 3] 	ldx num_tmp+3		; Must have >= 2 chars
ca11 : e002             [ 2] 	cpx #2				; else it's an error
ca13 : 9015             [ 3] 	bcc str_d_error
ca15 : a685             [ 3] 	ldx num_a
ca17 : a586             [ 3] 	lda num_a+1
ca19 : 2090ca           [ 6] 	jsr twos_complement
ca1c : 8685             [ 3] 	stx num_a
ca1e : 8586             [ 3] 	sta num_a+1
ca20 :                       str_d_skip_neg
ca20 : a694             [ 3] 	ldx num_tmp+3
ca22 : e001             [ 2] 	cpx #1				; must be at least 1 char
ca24 : 9004             [ 3] 	bcc str_d_error
ca26 : a901             [ 2] 	lda #NUM_DEC
ca28 : 18               [ 2] 	clc
ca29 : 60               [ 6] 	rts
ca2a :                       str_d_error
AS65 Assembler for R6502 [1.42].                                     Page   46
---------------------------------- bank3.s -----------------------------------

ca2a : 38               [ 2] 	sec
ca2b : 60               [ 6] 	rts
                             
ca2c :                       str_d_powers
ca2c : 00000100020003..      	dw	0, 1, 2, 3, 4, 5, 6, 7, 8, 9
ca40 : 00000a0014001e..      	dw	0, 10, 20, 30, 40, 50, 60, 70, 80, 90
ca54 : 00006400c8002c..      	dw	0, 100, 200, 300, 400, 500, 600, 700, 800, 90
ca68 : 0000e803d007b8..      	dw	0, 1000, 2000, 3000, 4000, 5000, 6000, 7000, 
ca7c : 00001027204e30..      	dw	0, 10000, 20000, 30000, 40000, 50000, 60000, 
                             	
                             
                             ;****************************************
                             ;* twos_complement
                             ;* Twos complement of X,A (X=low)
                             ;* Input : X = Low byte, A = High Byte to convert
                             ;* Output : X,A in 2's complement
                             ;* Regs affected : P
                             ;****************************************
ca90 :                       twos_complement
ca90 : 49ff             [ 2] 	eor #0xff
ca92 : 48               [ 3] 	pha
ca93 : 8a               [ 2] 	txa
ca94 : 49ff             [ 2] 	eor #0xff
ca96 : aa               [ 2] 	tax
ca97 : 68               [ 4] 	pla
ca98 : e8               [ 2] 	inx
ca99 : d001             [ 3] 	bne twos_complement_skip_X
ca9b : 1a               [ 2] 	inc a
ca9c :                       twos_complement_skip_X
ca9c : 60               [ 6] 	rts
                             
                             
                             ;****************************************
                             ;* int_to_bcd
                             ;* Convert A,X (signed int) to BCD
                             ;* Input : X = Low byte, A = High Byte to convert
                             ;* Output : 3 bytes of num_a is updated
                             ;* Regs affected : None
                             ;****************************************
ca9d :                       int_to_bcd
ca9d : 08               [ 3] 	php
ca9e : 48               [ 3] 	pha
ca9f : da               [ 3] 	phx
                             
caa0 : 8691             [ 3] 	stx num_tmp
caa2 : 8592             [ 3] 	sta num_tmp+1
caa4 : c980             [ 2] 	cmp #0x80			; Negative?
caa6 : 9003             [ 3] 	bcc int_to_bcd_skip_neg
caa8 : 2090ca           [ 6] 	jsr twos_complement
caab :                       int_to_bcd_skip_neg
caab : 6485             [ 3] 	stz num_a
caad : 6486             [ 3] 	stz num_a+1
caaf : 6487             [ 3] 	stz num_a+2
cab1 : 6488             [ 3] 	stz num_a+3
cab3 : a210             [ 2] 	ldx #16
cab5 : f8               [ 2] 	sed
cab6 :                       int_to_bcd_bit
cab6 : 0691             [ 5] 	asl num_tmp
cab8 : 2692             [ 5] 	rol num_tmp+1
caba : a585             [ 3] 	lda num_a
cabc : 6585             [ 3] 	adc num_a
cabe : 8585             [ 3] 	sta num_a
AS65 Assembler for R6502 [1.42].                                     Page   47
---------------------------------- bank3.s -----------------------------------

cac0 : a586             [ 3] 	lda num_a+1
cac2 : 6586             [ 3] 	adc num_a+1
cac4 : 8586             [ 3] 	sta num_a+1
cac6 : a587             [ 3] 	lda num_a+2
cac8 : 6587             [ 3] 	adc num_a+2
caca : 8587             [ 3] 	sta num_a+2
cacc : ca               [ 2] 	dex
cacd : d0e7             [ 3] 	bne int_to_bcd_bit
                             	
cacf : fa               [ 4] 	plx
cad0 : 68               [ 4] 	pla
cad1 : 28               [ 4] 	plp
cad2 : 60               [ 6] 	rts
                             	
                             ;****************************************
                             ;* word_to_bcd
                             ;* Convert A,X (unsighed word) to BCD
                             ;* Input : X = Low byte, A = High Byte to convert
                             ;* Output : 3 bytes of num_a is updated as BCD
                             ;* Regs affected : None
                             ;****************************************
cad3 :                       word_to_bcd
cad3 : 08               [ 3] 	php
cad4 : 48               [ 3] 	pha
cad5 : da               [ 3] 	phx
                             
cad6 : 8691             [ 3] 	stx num_tmp
cad8 : 8592             [ 3] 	sta num_tmp+1
cada : 6485             [ 3] 	stz num_a
cadc : 6486             [ 3] 	stz num_a+1
cade : 6487             [ 3] 	stz num_a+2
cae0 : 6488             [ 3] 	stz num_a+3
cae2 : a210             [ 2] 	ldx #16			; 16 binary bits
cae4 : f8               [ 2] 	sed
cae5 :                       word_to_bcd_bit
cae5 : 0691             [ 5] 	asl num_tmp
cae7 : 2692             [ 5] 	rol num_tmp+1
cae9 : a585             [ 3] 	lda num_a
caeb : 6585             [ 3] 	adc num_a
caed : 8585             [ 3] 	sta num_a
caef : a586             [ 3] 	lda num_a+1
caf1 : 6586             [ 3] 	adc num_a+1
caf3 : 8586             [ 3] 	sta num_a+1
caf5 : a587             [ 3] 	lda num_a+2
caf7 : 6587             [ 3] 	adc num_a+2
caf9 : 8587             [ 3] 	sta num_a+2
cafb : ca               [ 2] 	dex
cafc : d0e7             [ 3] 	bne word_to_bcd_bit
                             	
cafe : fa               [ 4] 	plx
caff : 68               [ 4] 	pla
cb00 : 28               [ 4] 	plp
cb01 : 60               [ 6] 	rts
                             
                             ;****************************************
                             ;* int_to_str_ch
                             ;* Helper routine to stuff decimal char in to num
                             ;* Input : A=BCD digit, Y=num_buf index, C=insert
                             ;* Output : num_buf in ASCII, A=ASCII digit
                             ;* Regs affected : C cleared if non-zero
                             ;****************************************
cb02 :                       int_to_str_ch
AS65 Assembler for R6502 [1.42].                                     Page   48
---------------------------------- bank3.s -----------------------------------

cb02 : 290f             [ 2] 	and #0xf
cb04 : 0930             [ 2] 	ora #0x30					; Convert to ascii
cb06 : 4930             [ 2] 	eor #0x30					; Check if zero digit
cb08 : d005             [ 3] 	bne int_to_str_nz			; If not zero definitely sto
cb0a : b003             [ 3] 	bcs int_to_str_nz			; Also if C=1
cb0c : 4930             [ 2] 	eor #0x30					; Restore A
cb0e : 60               [ 6] 	rts							; Return without storing anything
cb0f :                       int_to_str_nz
cb0f : 4930             [ 2] 	eor #0x30					; Restore A
cb11 : 999500           [ 5] 	sta num_buf,y
cb14 : c8               [ 2] 	iny
cb15 : 38               [ 2] 	sec							; Set C as a non-zero encountered
cb16 :                       int_to_str_ch_fin
cb16 : 60               [ 6] 	rts
                             
                             ;****************************************
                             ;* int_to_str
                             ;* Convert int to string
                             ;* Input : in X,A (low,high), C=leading zeros wan
                             ;* Output : num_buf in ASCII 6 digits + zero term
                             ;* Regs affected : P
                             ;****************************************
cb17 :                       int_to_str
                             	_pushAXY
                             
cb1a : a000             [ 2] 	ldy #0						; first pos of num_buf
cb1c : 0900             [ 2] 	ora #0						; Test A for sign bit
cb1e : 08               [ 3] 	php							; Remember C bit of P
cb1f : 100a             [ 3] 	bpl int_to_str_skip_neg		; Skip if not (postive 
cb21 : 2090ca           [ 6] 	jsr twos_complement			; Flip X,A from 2s complem
cb24 : 48               [ 3] 	pha							; Remember A
cb25 : a92d             [ 2] 	lda #'-'					; Put in negative sign
cb27 : 8595             [ 3] 	sta num_buf
cb29 : c8               [ 2] 	iny							; Start at second buffer pos
cb2a : 68               [ 4] 	pla							; Restore A
cb2b :                       int_to_str_skip_neg
cb2b : 20d3ca           [ 6]  	jsr word_to_bcd				; Convert X,A to BCD
cb2e : a202             [ 2] 	ldx #2						; Start at BCD high byte
cb30 :                       int_str
cb30 : 28               [ 4] 	plp							; Get C but immediately
cb31 : 08               [ 3] 	php							; Save C (due to loop check later)
cb32 : b585             [ 4] 	lda num_a,x					; Get BCD digit
cb34 : 859c             [ 3] 	sta num_buf+7				; Save A it for the units later
cb36 : 4a               [ 2] 	lsr a						; Tens - shift to lower nibble
cb37 : 4a               [ 2] 	lsr a
cb38 : 4a               [ 2] 	lsr a
cb39 : 4a               [ 2] 	lsr a
cb3a : 28               [ 4] 	plp							; Get C
cb3b : 2002cb           [ 6] 	jsr int_to_str_ch			; Put ASCII code in num_buf
cb3e : a59c             [ 3] 	lda num_buf+7				; Get A for the units
cb40 : 2002cb           [ 6] 	jsr int_to_str_ch			; Put ASCII code in num_buf
cb43 : 08               [ 3] 	php							; Save C
cb44 : ca               [ 2] 	dex
cb45 : 10e9             [ 3] 	bpl int_str
cb47 : 28               [ 4] 	plp							; Check C
cb48 : b005             [ 3] 	bcs	int_to_str_fin			; If set then something pri
cb4a : a930             [ 2] 	lda #'0'					; Stuff a zero
cb4c : 8595             [ 3] 	sta num_buf					; Must be in first position..
cb4e : c8               [ 2] 	iny
cb4f :                       int_to_str_fin
cb4f : a900             [ 2] 	lda #0						; Terminator
cb51 : 999500           [ 5] 	sta num_buf,y
AS65 Assembler for R6502 [1.42].                                     Page   49
---------------------------------- bank3.s -----------------------------------

cb54 : c8               [ 2] 	iny
                             	_pullAXY
                             
cb58 : 60               [ 6] 	rts
                             
                             
                             ;****************************************
                             ;* bcd_to_str
                             ;* Convert num_buf to chars
                             ;* Input : num_a in BCD format
                             ;* Output : num_buf in ASCII 6 digits
                             ;* Output is big endian, input is not
                             ;* Regs affected : P
                             ;****************************************
                             ;bcd_to_str
                             ;	pha
                             ;	phx
                             ;	phy
                             ;
                             ;	ldx #5						; Index in to string
                             ;	ldy #0						; Current BCD digit
                             ;bcd_str
                             ;	lda num_a,y
                             ;	; Convert 1s digit of byte
                             ;	pha
                             ;	and #0xf
                             ;	clc
                             ;	adc #0x30
                             ;	sta num_buf,x
                             ;	; Convert 10s digit of byte
                             ;	pla
                             ;	lsr a
                             ;	lsr a
                             ;	lsr a
                             ;	lsr a
                             ;	clc
                             ;	adc #0x30					; Convert to ASCII
                             ;	sta num_buf-1,x
                             ;	dex
                             ;	dex
                             ;	iny
                             ;	cpy #3						; 3 BCD digits max
                             ;	bne bcd_str
                             ;
                             ;	ply
                             ;	plx
                             ;	pla
                             ;	rts
                             	
                             ;****************************************
                             ;* out_bcd
                             ;* Output a bcd string in num_buf
                             ;* Input : num_buf has the ASCII
                             ;* Input : C=1 print leading zeros else not
                             ;* Output : num_buf in ASCII 6 digits
                             ;* Output is big endian, input is not, Y=digits p
                             ;* Regs affected : P
                             ;****************************************
                             ;out_bcd
                             ;	pha
                             ;	phx
                             ;	php
AS65 Assembler for R6502 [1.42].                                     Page   50
---------------------------------- bank3.s -----------------------------------

                             ;	ldy #0						; How many digits printed
                             ;	ldx #0						; Index in to string
                             ;out_bcd_digit
                             ;	lda num_buf,x
                             ;	cpy #0						; If not in leading zero mode
                             ;	bne out_bcd_print			; No then go print
                             ;
                             ;	cmp #'0'					; else check if zero
                             ;	bne out_bcd_print			; No then go print
                             ;
                             ;	plp
                             ;	php
                             ;	bcc out_bcd_next			; If C=0 go to next digit, e
                             ;out_bcd_print
                             ;	iny
                             ;	jsr io_put_ch
                             ;out_bcd_next
                             ;	inx
                             ;	cpx #6
                             ;	bne out_bcd_digit
                             ;	cpy #0						; If nothing printed
                             ;	bne out_bcd_fin
                             ;	lda #'0'					; Need to put out 1 zero
                             ;	jsr io_put_ch
                             ;	iny
                             ;out_bcd_fin
                             ;	plp
                             ;	plx
                             ;	pla
                             ;	clc
                             ;	rts
                             	
                             ;****************************************
                             ;* str_a_to_d
                             ;* Convert X,A to decimal string in sevalptr
                             ;* Input : X,A = number Low,High
                             ;* Input : C=1 keep leading zeros else not
                             ;* Output : sevalptr in ASCII max 6 digits
                             ;*          Y=length including sign
                             ;* Output is big endian, input is not
                             ;* Regs affected : P
                             ;****************************************
cb59 :                       str_a_to_d
cb59 : 60               [ 6] 	rts
                             	
                             ;****************************************
                             ;* print_a_to_d
                             ;* Convert X,A to decimal string
                             ;* Input : X,A = number Low,High
                             ;* Input : C=1 print leading zeros else not
                             ;* Output : num_buf in ASCII max 6 digits
                             ;*          Y=digits printed including sign
                             ;* Output is big endian, input is not
                             ;* Regs affected : P
                             ;****************************************
cb5a :                       print_a_to_d
cb5a : 2017cb           [ 6] 	jsr int_to_str
cb5d : a000             [ 2] 	ldy #0
cb5f :                       print_a_to_d_ch
cb5f : b99500           [ 4] 	lda num_buf,y
cb62 : f006             [ 3] 	beq print_a_to_d_fin
cb64 : 20c0c5           [ 6] 	jsr io_put_ch
AS65 Assembler for R6502 [1.42].                                     Page   51
---------------------------------- bank3.s -----------------------------------

cb67 : c8               [ 2] 	iny
cb68 : d0f5             [ 3] 	bne print_a_to_d_ch
cb6a :                       print_a_to_d_fin
cb6a : 60               [ 6] 	rts
                             	
                             
                             ;* Reset vector points here - 6502 starts here
cb6b :                       init
                             ;	jmp init_test
                             	; First clear ram
                             ;	sei					; No need as disabled on startup
                             ;	cld					; No need as disabled on startup
cb6b : a2ff             [ 2] 	ldx #0xff			; Initialise stack pointer
cb6d : 9a               [ 2] 	txs
cb6e : 4cc9cb           [ 3] 	jmp init_ram		; jmp not jsr to ram initialiser
cb71 :                       init_2					; init_ram will jump back to here
                             	
cb71 : 2077cb           [ 6] 	jsr kernel_init
                             
cb74 : 4cffc6           [ 3] 	jmp main
                             
cb77 :                       kernel_init
cb77 : 2052c7           [ 6] 	jsr init_nmi		; Initialise NMI handling
cb7a : 20a2c7           [ 6] 	jsr init_irq		; Initialise IRQ handling
cb7d : 20dec1           [ 6] 	jsr _init_acia		; initialise the serial chip
                             	
cb80 : 20f6c1           [ 6] 	jsr _init_cia0		; initialise cia 0
cb83 : 200ec2           [ 6] 	jsr _init_cia1		; initialise cia 1
cb86 : 2026c5           [ 6] 	jsr _PT3INIT		; Load PT3 player code into shadow
cb89 :                       kernel_test
cb89 : 2056c2           [ 6] 	jsr _init_snd		; initialise the sound chip
cb8c : 206ec2           [ 6] 	jsr _init_keyboard	; initialise keyboard timer s
cb8f : 2036c4           [ 6] 	jsr _vdp_init		; initialise vdp
cb92 : a900             [ 2] 	lda #0				; Default = 40 column mode - put on st
cb94 : 48               [ 3] 	pha
cb95 : a20e             [ 2] 	ldx #NV_MODE		; NV location for default text mod
cb97 : 2096c4           [ 6] 	jsr _rtc_nvread		; Try to read location
cb9a : b00b             [ 3] 	bcs kernel_skip_nv	; If bad NV ram then skip try
cb9c : aa               [ 2] 	tax					; Save the mode temporarily
cb9d : 68               [ 4] 	pla					; Get the default mode from stack
cb9e : 8a               [ 2] 	txa					; And push the NV mode that was read
cb9f : 48               [ 3] 	pha
cba0 : a20f             [ 2] 	ldx #NV_COLOUR		; NV location for the default co
cba2 : 2096c4           [ 6] 	jsr _rtc_nvread		; Try to read location (assumed
cba5 : 8521             [ 3] 	sta vdp_base+vdp_bord_col	; Save it to the borde
cba7 :                       kernel_skip_nv	
cba7 : 68               [ 4] 	pla					; Get the mode (either default or the NV
cba8 : 20c6c1           [ 6] 	jsr _gr_init_screen
cbab : 2086c5           [ 6] 	jsr io_init			; Set default input/output device
cbae : 58               [ 2] 	cli					; irq interrupts enable
                             
                             	; Print the boot up message - requires IO and IR
                             	_println msg_hello_world
                             
                             
                             
cbbc : 204ec4           [ 6] 	jsr _rtc_init		; Initialise RTC - * AFTER INTERR
cbbf : 203ec2           [ 6] 	jsr _init_sdcard	; initialise the sd card interf
cbc2 : 2026c2           [ 6] 	jsr _init_fs		; initialise the filesystem
cbc5 : 202ec0           [ 6] 	jsr _df_init		; Initialise interpreter
                             
cbc8 : 60               [ 6] 	rts
AS65 Assembler for R6502 [1.42].                                     Page   52
---------------------------------- bank3.s -----------------------------------

                             
                             	
                             ;* Initialises RAM, skipping pages 4-8 which are 
                             ;* Zeroes all addressable RAM in the default bank
cbc9 :                       init_ram
cbc9 : 6400             [ 3] 	stz 0x00			; Start at page 0
cbcb : 6401             [ 3] 	stz 0x01
cbcd : a002             [ 2] 	ldy #0x02			; But Y initially at 2 to not overwr
cbcf : a200             [ 2] 	ldx #0x00			; Page counter starts at zero
cbd1 : a900             [ 2] 	lda #0				; Normal RAM filled with zero
cbd3 :                       init_ram_1
cbd3 : e005             [ 2] 	cpx	#5				; Page <5 is ok (zeroes out VIA0 and 1
cbd5 : 9004             [ 3] 	bcc init_ram_fill
cbd7 : e008             [ 2] 	cpx #8				; Page >=8 is ok
cbd9 : 9005             [ 3] 	bcc init_ram_skip	; But >=5 and <8 do not initia
cbdb :                       init_ram_fill
cbdb : 9100             [ 5] 	sta (0x00),y		; Write initialisation value to RA
cbdd : c8               [ 2] 	iny
cbde : d0fb             [ 3] 	bne init_ram_fill	; Do a whole page
cbe0 :                       init_ram_skip
cbe0 : e8               [ 2] 	inx					; Increment page counter
cbe1 : 8601             [ 3] 	stx 0x01			; Save to address pointer
cbe3 : d0ee             [ 3] 	bne init_ram_1		; Do all pages until page 0xff d
                             	
cbe5 : 4c71cb           [ 3] 	jmp init_2			; Carry on initialisation
                             
cbe8 :                       mod_sz_kernel_e
                             
                             
                             
                             ; Bank specific code goes here
                             	include "sound\ptplayer.s"
                             ; ===============================================
                             ; Vortex Tracker II v1.0 PT3 player for 6502
                             ; Based on ORIC 1/ATMOS (6502) version
                             ; Updated for HB-BBC-128 Homebrew Computer by 650
                             ; ScalexTrixx (A.C) - (c)2018
                             ;
                             ; Translated and adapted from ZX Spectrum Player 
                             ; by S.V.Bulba (with Ivan Roshin for some parts/a
                             ; https://bulba.untergrund.net/main_e.htm (c)2004
                             ;
0030 =                       Revision = "0" 
                             ; ===============================================
                             ; REV 0: 
                             ; ======
                             ; rev 0.34 (WK/TS)  - correction / 1.773 (288=x25
                             ;                   => file_end = $8E68
                             ;
                             ; rev 0.33 (WK)     - optimizations: PTDECOD
                             ;                   => file_end = $8E53
                             ;
                             ; rev 0.32 (WK)     - optimizations: PLAY
                             ;                   => file_end = $8F43
                             ;
                             ; rev 0.31 (WK)     - optimizations: CHREGS
                             ;                   => file_end = $8FC4
                             ;
                             ; rev 0.30 (WK)     - New base "full working" ver
                             ;                   - optimizations: zp variables
                             ;                   => file_end = $9027
                             ;
AS65 Assembler for R6502 [1.42].                                     Page   53
---------------------------------- bank3.s -----------------------------------

                             ; --------------------------------
                             ; WK: working / TS: test version |
                             ; ===============================================
                             ; TODO:
                             ; - lda ($AC),y -> lda ($AC,x)
                             ; - NOISE Register opt (/2 ?)
                             ; - déplacer / 1.773 avant CHREGS (cf CPC versio
                             ; - dans PD_LOOP: vérifier si des jmp relatifs s
                             ; - fix .bbs address
                             ; - check zero pages addresses
                             ; ===============================================
                             ;
                             ;	ORG $8000
                             ;
                             ; -------------------------------------
                                     bss
                             
00ed =                       	org $ed         ; Uses *all* of zero page from h
                                 
00ed =                       SETUP   ds 1      ; set bit0 to 1, if you want to
                                                ; bit7 is set each time, when 
                             ; "registers" Z80
                             ; A = A
                             ; F = flags
                             
00ee =                       z80_A   ds 1      ; save A
00ef =                       z80_C   ds 1
00f0 =                       z80_B   ds 1
00f1 =                       z80_E   ds 1
00f2 =                       z80_D   ds 1
00f3 =                       z80_L   ds 1
00f4 =                       z80_H   ds 1
00f5 =                       z80_IX  ds 2
00f7 =                       z80_AP  ds 1      ; save A'
                             ; temp variable used during play
00f8 =                       val1    ds 2
00fa =                       val2    ds 2
00fc =                       val3    ds 2
00fe =                       val4    ds 2
00f8 =                       TA1 = val1
00f9 =                       TA2 = val1+1
00fa =                       TB1 = val2
00fb =                       TB2 = val2+1
00fc =                       TC1 = val3
00fd =                       TC2 = val3+1
00fe =                       TB3 = val4
00ff =                       TC3 = val4+1
                             
                             ; =====================================
                             ; module PT3 address
                             ; =====================================
                                     code
                             ; For dflat, allow build of code for other locati
                             ; default is 0xe000
                             
                              if !PT3RELOCADDR
                             PT3RELOCADDR = 0xe000
                              endif
e000 =                               org $e000
                             
                             ; START = $e000 or PT3RELOCADDR
                             ; START+00 : Initialise a tune and start
AS65 Assembler for R6502 [1.42].                                     Page   54
---------------------------------- bank3.s -----------------------------------

                             ; START+03 : Disable tune and stop
                             ; START+06 : Mute sound every interrupt
                             ; START+09 : Pause but allow other sounds while p
                             ; START+0C : Resume tune
                             ; All will be extern routines
e000 :                       PT3START
e000 : 4c44e0           [ 3]         jmp _doStart
e003 :                       PT3PAUSE
e003 : 4c31e0           [ 3]         jmp _doPause
e006 :                       PT3RESUME
e006 : 4c3ee0           [ 3]         jmp _doResume
                             
                             ; We need to copy all this code to shadow RAM beh
                             ; Also ensure we're in **Bank 2** (not Bank 3) of
                             ; This is an extern routine needs to be callable 
                             ; Is called at power-on / reset
e009 :                       PT3INIT
                                     ; Swtich to RAM bank 2 don't touch anythi
e009 : ad0004           [ 4]         lda IO_0+PRB
e00c : 48               [ 3]         pha                     ; Remember the ba
e00d : 29cf             [ 2]         and #0b11001111         ; mask out old ba
e00f : 0920             [ 2]         ora #0b00100000         ; mask in bank bi
e011 : 8d0004           [ 4]         sta IO_0+PRB
                             
                                     ; Copy from PT3START to PT3END
                                     ; To shadow RAM directly underneath
e014 : a000             [ 2]         ldy #lo(PT3START)
e016 : a000             [ 2]         ldy #0x00
e018 : 8441             [ 3]         sty tmp_a               ; Page + Y index,
e01a : a2e0             [ 2]         ldx #hi(PT3START)
e01c : a2c0             [ 2]         ldx #0xc0
e01e : 8642             [ 3]         stx tmp_a+1
                             
e020 :                       PT3INIT_COPY
e020 : b141             [ 5]         lda (tmp_a),y           ; Get ROM byte
e022 : 9141             [ 5]         sta (tmp_a),y           ; Write to memory
e024 : c8               [ 2]         iny
e025 : d0f9             [ 3]         bne PT3INIT_COPY
e027 : e8               [ 2]         inx
e028 : 8642             [ 3]         stx tmp_a+1             ; Increment page 
e02a : d0f4             [ 3]         bne PT3INIT_COPY
                             
                                     ; Ok all code in this file copied from RO
e02c : 68               [ 4]         pla
e02d : 8d0004           [ 4]         sta IO_0+PRB            ; Restore RAM ban
e030 : 60               [ 6]         rts
                             
                             
                             ; Can play other sounds while paused
e031 :                       _doPause
                                     ; Disable T1 interrupt on VIA 1
e031 : a940             [ 2]         lda #0b01000000
e033 : 8d8e04           [ 4]         sta IO_1+IER
                             
                                     ; Kill the channels with the sound throug
e036 : a03f             [ 2]         ldy #0b00111111
e038 : a207             [ 2]         ldx #SND_REG_CTL
e03a : 20a1c6           [ 6]         jsr snd_set
e03d : 60               [ 6]         rts
                             
                             ; Reinstate the PT3 IRQ
e03e :                       _doResume
AS65 Assembler for R6502 [1.42].                                     Page   55
---------------------------------- bank3.s -----------------------------------

                                     ; Enable T1 interrupt on VIA 1
e03e : a9c0             [ 2]         lda #0b11000000
e040 : 8d8e04           [ 4]         sta IO_1+IER
e043 : 60               [ 6]         rts
                             
                             
                             ; Initialise the player to start using A,X as son
                             
e044 :                       _doStart
                                     ; Disable T1 interrupt on VIA 1 just in c
e044 : a040             [ 2]         ldy #0b01000000
e046 : 8c8e04           [ 4]         sty IO_1+IER
                             ; For dflat, assume that A,X provides address of 
e049 : 85f3             [ 3]         sta z80_L
e04b : 86f4             [ 3]         stx z80_H
                                     ; Swtich to RAM bank 2 don't touch anythi
e04d : ad0004           [ 4]         lda IO_0+PRB
e050 : 48               [ 3]         pha                     ; Remember the ba
e051 : 29cf             [ 2]         and #0b11001111
e053 : 0920             [ 2]         ora #0b00100000
e055 : 8d0004           [ 4]         sta IO_0+PRB
                                     ; Switch out ROM for RAM
e058 : ad8004           [ 4]         lda IO_1+PRB                    ; Get cur
e05b : 48               [ 3]         pha
e05c : 29df             [ 2]         and #(0xff ^ MM_DIS)            ; Switch 
e05e : 8d8004           [ 4]         sta IO_1+PRB                    ; Update 
                             ;        bra _doStart_test
                             
e061 : 20e5e0           [ 6] 	jsr INIT
                                     ; Remember previous user irq
e064 : a50c             [ 3]         lda int_usercia1
e066 : 8d96e0           [ 4]         sta oldIrq
e069 : a50d             [ 3]         lda int_usercia1+1
e06b : 8d97e0           [ 4]         sta oldIrq+1
                                     ; Set up timer for 50Hz (20ms) interrupts
                                     ; @5.36MHz it is 107,200 cycles
                                     ; which doesn't fit into 16 bits!
                                     ; so instead set up 100Hz (10ms) interrup
                                     ; which is 53,600 cycles, but only
                                     ; invoke the sound player every other
                                     ; interrupt!
                                     ; 53,600 = 0xd160
                                     ; Timre 1 of VIA 1
e06e : a960             [ 2]         lda #0x60
e070 : 8d8404           [ 4]         sta IO_1+T1CL
e073 : a9d1             [ 2]         lda #0xd1
e075 : 8d8504           [ 4]         sta IO_1+T1CH
                                     ; T1 of VIA1 set to continuous
e078 : a940             [ 2]         lda #0b01000000
e07a : 8d8b04           [ 4]         sta IO_1+ACR
                                     ; Instate PT3 irq
e07d : a9ad             [ 2]         lda #lo(pt3Irq)
e07f : 850c             [ 3]         sta int_usercia1
e081 : a9e0             [ 2]         lda #hi(pt3Irq)
e083 : 850d             [ 3]         sta int_usercia1+1
                                     ; Enable T1 interrupt
e085 : a9c0             [ 2]         lda #0b11000000
e087 : 8d8e04           [ 4]         sta IO_1+IER
                             ;_doStart_test
                                     ; Restore ROM
e08a : 68               [ 4]         pla                             ; Get ori
e08b : 8d8004           [ 4]         sta IO_1+PRB                    ; Update 
AS65 Assembler for R6502 [1.42].                                     Page   56
---------------------------------- bank3.s -----------------------------------

                                     ; Restore RAM bank
e08e : 68               [ 4]         pla                             ; Get ori
e08f : 8d0004           [ 4]         sta IO_0+PRB                    ; Update 
e092 : 60               [ 6]         rts
                                  
e093 : 0000                  CrPsPtr	fcw 0 ; current position in PT3 module
e095 : 00                    intCount fcb 0      ; byte flag to call player on
e096 : 0000                  oldIrq fcw 0    ; Remember old IRQ vector
                             
                             ;Identifier
e098 : 3d565449492050..      	    db "=VTII PT3 Player r.",Revision,"="
                             
                             ;
                             ; Call pt3 player every interrupt
e0ad :                       pt3Irq
                                     ; Call player every other interrupt
e0ad : a980             [ 2]         lda #0x80
e0af : 4d95e0           [ 4]         eor intCount
e0b2 : 8d95e0           [ 4]         sta intCount
e0b5 : 1003             [ 3]         bpl skipInt_1
                                     ; Call the player each tick
e0b7 : 2046ea           [ 6]         jsr PLAY
e0ba :                       skipInt_1
e0ba :                       skipInt
e0ba : 60               [ 6]         rts
                             
e0bb :                       CHECKLP
                             	                                                
e0bb : a5ed             [ 3]         lda SETUP                                
e0bd : 0980             [ 2]         ora #%10000000                           
e0bf : 85ed             [ 3]         sta SETUP
e0c1 : a901             [ 2] 	lda #%00000001                                  
e0c3 : 24ed             [ 3]         bit SETUP
e0c5 : d001             [ 3]         bne s1                                   
e0c7 : 60               [ 6] 	rts
e0c8 : 68               [ 4] s1	pla                                           
e0c9 : 68               [ 4]         pla       ; dépile 2 fois puisque rts sh
e0ca : ee43ee           [ 6] 	inc DelyCnt                                     
e0cd : ee07ee           [ 6]         inc ANtSkCn                              
e0d0 :                       _MUTE	                                           
e0d0 : a900             [ 2]         lda #00                                  
e0d2 : 85f4             [ 3]         sta z80_H                                
e0d4 : 85f3             [ 3] 	sta z80_L                                       
e0d6 : 8d51ee           [ 4] 	sta AYREGS+AmplA                                
e0d9 : 8d52ee           [ 4] 	sta AYREGS+AmplB                                
e0dc : 8d53ee           [ 4]         sta AYREGS+AmplC
e0df : 8d50ee           [ 4]         sta AYREGS+Mixer  ; This is the daddy - s
e0e2 : 4c37ec           [ 3] 	jmp ROUT                                        
                             
e0e5 :                       INIT
e0e5 : a5f3             [ 3] 	lda z80_L                                       
e0e7 : 8df0e3           [ 4] 	sta MODADDR+1
e0ea : 8d33e7           [ 4]         sta MDADDR2+1
e0ed : 85f5             [ 3]         sta z80_IX
e0ef : 48               [ 3]         pha
e0f0 : a5f4             [ 3]         lda z80_H
e0f2 : 8df6e3           [ 4]         sta MODADDR+7
e0f5 : 8d39e7           [ 4]         sta MDADDR2+7
e0f8 : 85f6             [ 3]         sta z80_IX+1
e0fa : 48               [ 3]         pha
e0fb : a964             [ 2]         lda #lo(100)                             
e0fd : 85f1             [ 3]         sta z80_E
AS65 Assembler for R6502 [1.42].                                     Page   57
---------------------------------- bank3.s -----------------------------------

e0ff : a900             [ 2]         lda #00
e101 : 85f2             [ 3]         sta z80_D
e103 : a8               [ 2]         tay
e104 : 18               [ 2] 	clc                                             
e105 : a5f1             [ 3]         lda z80_E
e107 : 65f3             [ 3]         adc z80_L
e109 : 85f3             [ 3]         sta z80_L
e10b : a5f4             [ 3]         lda z80_H
e10d : 6900             [ 2]         adc #00
e10f : 85f4             [ 3]         sta z80_H
e111 : b1f3             [ 5]         lda (z80_L),y                            
e113 : 8d5feb           [ 4] 	sta Delay+1                                     
e116 : a5f1             [ 3]         lda z80_E
e118 : 65f3             [ 3]         adc z80_L
e11a : 85f3             [ 3]         sta z80_L
e11c : 8d93e0           [ 4]         sta CrPsPtr                              
e11f : a5f4             [ 3]         lda z80_H
e121 : 6900             [ 2]         adc #00
e123 : 85f4             [ 3]         sta z80_H    
e125 : 8d94e0           [ 4]         sta CrPsPtr+1
e128 : a066             [ 2] 	ldy #102               
e12a : b1f5             [ 5]         lda (z80_IX),y
e12c : 85f1             [ 3]         sta z80_E
e12e : 18               [ 2] 	clc                                             
e12f : 65f3             [ 3]         adc z80_L
e131 : 85f3             [ 3]         sta z80_L
e133 : a5f4             [ 3]         lda z80_H
e135 : 6900             [ 2]         adc #00
e137 : 85f4             [ 3]         sta z80_H       
e139 : e6f3             [ 5] 	inc z80_L                                       
e13b : d002             [ 3]         bne s2
e13d : e6f4             [ 5]         inc z80_H
e13f : a5f3             [ 3] s2	lda z80_L                                     
e141 : 8d96ea           [ 4]         sta LPosPtr+1
e144 : a5f4             [ 3]         lda z80_H
e146 : 8d9aea           [ 4]         sta LPosPtr+5
e149 : 68               [ 4] 	pla                                             
e14a : 85f2             [ 3]         sta z80_D
e14c : 68               [ 4]         pla
e14d : 85f1             [ 3]         sta z80_E
e14f : a067             [ 2] 	ldy #103               
e151 : b1f5             [ 5]         lda (z80_IX),y
e153 : 18               [ 2] 	clc                                             
e154 : 65f1             [ 3]         adc z80_E
e156 : 8dbdea           [ 4]         sta PatsPtr+1   
e159 : a068             [ 2]         ldy #104                  
e15b : b1f5             [ 5]         lda (z80_IX),y
e15d : 65f2             [ 3]         adc z80_D
e15f : 8dc4ea           [ 4]         sta PatsPtr+8
e162 : a9a9             [ 2]         lda #lo(169)                             
e164 : 18               [ 2]         clc                                      
e165 : 65f1             [ 3]         adc z80_E
e167 : 8d22e7           [ 4]         sta OrnPtrs+1   
e16a : a900             [ 2]         lda #00
e16c : 65f2             [ 3]         adc z80_D
e16e : 8d29e7           [ 4]         sta OrnPtrs+8
e171 : a969             [ 2]         lda #lo(105)                             
e173 : 18               [ 2]         clc                                      
e174 : 65f1             [ 3]         adc z80_E
e176 : 8ddfe3           [ 4]         sta SamPtrs+1
e179 : a900             [ 2]         lda #00
                                     ;INIT zeroes from VARS to VAR0END-1 (area
AS65 Assembler for R6502 [1.42].                                     Page   58
---------------------------------- bank3.s -----------------------------------

e17b : a06c             [ 2]         ldy #(VAR0END-VARS-1)
e17d :                       LOOP_LDIR 
e17d : 99eced           [ 5]         sta VARS,y
e180 : 88               [ 2]         dey         ; (carry not modified)
e181 : 10fa             [ 3]         bpl LOOP_LDIR
                                     ; A = #00  
e183 : 65f2             [ 3]         adc z80_D
e185 : 8de6e3           [ 4]         sta SamPtrs+8                            
e188 : a5ed             [ 3]         lda SETUP                                
e18a : 297f             [ 2]         and #%01111111
e18c : 85ed             [ 3]         sta SETUP
                                     
e18e : a98a             [ 2] 	lda #lo(T1_)
e190 : 85f1             [ 3]         sta z80_E
e192 : a9ed             [ 2]         lda #hi(T1_)
e194 : 85f2             [ 3]         sta z80_D
e196 : a901             [ 2]         lda #$01                                 
e198 : 8d43ee           [ 4] 	sta DelyCnt                                     
e19b : 8d07ee           [ 4]         sta ANtSkCn
e19e : 8d24ee           [ 4]         sta BNtSkCn
e1a1 : 8d41ee           [ 4]         sta CNtSkCn
e1a4 : a9f0             [ 2]         lda #$F0
e1a6 : 8d08ee           [ 4] 	sta AVolume                                     
e1a9 : 8d25ee           [ 4] 	sta BVolume                                     
e1ac : 8d42ee           [ 4] 	sta CVolume                                     
e1af : a986             [ 2]         lda #lo(EMPTYSAMORN)                     
e1b1 : 85f3             [ 3]         sta z80_L
e1b3 : 8d64ea           [ 4]         sta AdInPtA+1
e1b6 : 8df9ed           [ 4]         sta AOrnPtr
e1b9 : 8d16ee           [ 4]         sta BOrnPtr
e1bc : 8d33ee           [ 4]         sta COrnPtr
e1bf : 8dfbed           [ 4]         sta ASamPtr
e1c2 : 8d18ee           [ 4]         sta BSamPtr
e1c5 : 8d35ee           [ 4]         sta CSamPtr
e1c8 : a9ed             [ 2]         lda #hi(EMPTYSAMORN)
e1ca : 85f4             [ 3]         sta z80_H
e1cc : 8d68ea           [ 4] 	sta AdInPtA+5                                   
e1cf : 8dfaed           [ 4] 	sta AOrnPtr+1                                   
e1d2 : 8d17ee           [ 4] 	sta BOrnPtr+1                                   
e1d5 : 8d34ee           [ 4] 	sta COrnPtr+1                                   
e1d8 : 8dfced           [ 4] 	sta ASamPtr+1                                   
e1db : 8d19ee           [ 4] 	sta BSamPtr+1                                   
e1de : 8d36ee           [ 4] 	sta CSamPtr+1                                   
                             	    			                                         
                                     
e1e1 : a00d             [ 2] 	ldy #13                    
e1e3 : b1f5             [ 5]         lda (z80_IX),y
e1e5 : 38               [ 2]         sec                                      
e1e6 : e930             [ 2]         sbc #$30        ; ascii value - 30 = vers
e1e8 : 9004             [ 3] 	bcc L20         ; inverse (pour SUB aussi)      
e1ea : c90a             [ 2] 	cmp #10                                         
e1ec : 9002             [ 3] 	bcc L21         ; < 10                          
e1ee :                       L20	    
e1ee : a906             [ 2]         lda #6          ; version par defaut si i
e1f0 :                       L21	    
e1f0 : 8d97e5           [ 4]         sta Version+1                            
e1f3 : 48               [ 3] 	pha             ; save version nb
e1f4 : c904             [ 2]         cmp #4          ; version 4 ?            
e1f6 : 9003             [ 3]         bcc s7b         ; < 4 (inverse carry)
e1f8 : 18               [ 2]         clc
e1f9 : 9001             [ 3]         bcc s8b         ; always
e1fb : 38               [ 2] s7b     sec
AS65 Assembler for R6502 [1.42].                                     Page   59
---------------------------------- bank3.s -----------------------------------

e1fc : a063             [ 2] s8b     ldy #99                 
e1fe : b1f5             [ 5]         lda (z80_IX),y  
e200 : 2a               [ 2]         rol a           ; carry !                
e201 : 2907             [ 2] 	and #7          ; clear all bit except 0-1-2    
e203 : aa               [ 2]         tax             ; save A
                             ;NoteTableCreator (c) Ivan Roshin
                             ;A - NoteTableNumber*2+VersionForNoteTable
                             ;(xx1b - 3.xx..3.4r, xx0b - 3.4x..3.6x..VTII1.0)
                             
e204 : a936             [ 2]      	lda #lo(NT_DATA)											    
e206 : 85f3             [ 3]      	sta z80_L
e208 : a9ed             [ 2]      	lda #hi(NT_DATA)
e20a : 85f4             [ 3]      	sta z80_H
e20c : a5f1             [ 3]      	lda z80_E													
e20e : 85ef             [ 3]      	sta z80_C
e210 : a5f2             [ 3]      	lda z80_D
e212 : 85f0             [ 3]      	sta z80_B
e214 : a900             [ 2]      	lda #00
e216 : a8               [ 2]         tay           ; ldy #00	        
e217 : 85f2             [ 3]      	sta z80_D
e219 : 8a               [ 2]      	txa           ; restore A									
e21a : 0a               [ 2]      	asl a															
e21b : 85f1             [ 3]      	sta z80_E													
e21d : 18               [ 2]      	clc                                        
e21e : 65f3             [ 3]         adc z80_L
e220 : 85f3             [ 3]         sta z80_L
e222 : a5f2             [ 3]         lda z80_D
e224 : 65f4             [ 3]         adc z80_H
e226 : 85f4             [ 3]         sta z80_H													
e228 : b1f3             [ 5]      	lda (z80_L),y												
e22a : 85f1             [ 3]      	sta z80_E
e22c : e6f3             [ 5]      	inc z80_L                                  
e22e : d002             [ 3]         bne s9b
e230 : e6f4             [ 5]         inc z80_H
e232 :                       s9b 
e232 : 46f1             [ 5] 	lsr z80_E											    				     				
e234 : b004             [ 3] 	bcs sb		; si c = 0 => $EA (NOP) / si c = 1 => $1
e236 : a9ea             [ 2] sa  	lda #$EA 	; -> $EA (NOP)
e238 : d002             [ 3]         bne sb1		; always	
e23a : a918             [ 2] sb	lda #$18	; -> $18 (clc) 									
e23c : 8daee2           [ 4] sb1	sta L3		            									
e23f : a5f1             [ 3] 	lda z80_E													
e241 : a6f3             [ 3] 	ldx z80_L
e243 : 85f3             [ 3] 	sta z80_L
e245 : 86f1             [ 3] 	stx z80_E
e247 : a5f2             [ 3] 	lda z80_D
e249 : a6f4             [ 3] 	ldx z80_H
e24b : 85f4             [ 3] 	sta z80_H
e24d : 86f2             [ 3] 	stx z80_D
e24f : 18               [ 2] 	clc                                             
e250 : a5ef             [ 3]     	lda z80_C
e252 : 65f3             [ 3]     	adc z80_L
e254 : 85f3             [ 3]     	sta z80_L
e256 : a5f0             [ 3]     	lda z80_B
e258 : 65f4             [ 3]     	adc z80_H
e25a : 85f4             [ 3]     	sta z80_H
                             
e25c : b1f1             [ 5] 	lda (z80_E),y												
e25e : 18               [ 2] 	clc                                             
e25f : 6946             [ 2]         adc #lo(T_)
e261 : 85ef             [ 3] 	sta z80_C
e263 : 48               [ 3]         pha                                      
AS65 Assembler for R6502 [1.42].                                     Page   60
---------------------------------- bank3.s -----------------------------------

e264 : 69ed             [ 2]         adc #hi(T_)                              
e266 : 38               [ 2] 	sec                                             
e267 : e5ef             [ 3]         sbc z80_C
e269 : 85f0             [ 3]         sta z80_B                                
e26b : 48               [ 3] 	pha
                             
e26c : a949             [ 2] 	lda #lo(NT_)											
e26e : 85f1             [ 3] 	sta z80_E
e270 : 48               [ 3] 	pha															
e271 : a9ef             [ 2] 	lda #hi(NT_)
e273 : 85f2             [ 3] 	sta z80_D
e275 : 48               [ 3] 	pha
e276 : a90c             [ 2] 	lda #12														
e278 : 85f0             [ 3] 	sta z80_B
e27a :                       L1	    
e27a : a5ef             [ 3]         lda z80_C													
e27c : 48               [ 3] 	pha
e27d : a5f0             [ 3] 	lda z80_B
e27f : 48               [ 3] 	pha
e280 : b1f3             [ 5] 	lda (z80_L),y												
e282 : 85ef             [ 3] 	sta z80_C
e284 : e6f3             [ 5] 	inc z80_L                                       
e286 : d002             [ 3]         bne sc
e288 : e6f4             [ 5]         inc z80_H
e28a :                       sc     
e28a : a5f3             [ 3] 	lda z80_L												    
e28c : 48               [ 3] 	pha
e28d : a5f4             [ 3] 	lda z80_H
e28f : 48               [ 3] 	pha
e290 : b1f3             [ 5] 	lda (z80_L),y												
e292 : 85f0             [ 3] 	sta z80_B
                             
e294 : a5f1             [ 3] 	lda z80_E       												
e296 : 85f3             [ 3] 	sta z80_L
e298 : 48               [ 3]         pha
e299 : a5f2             [ 3] 	lda z80_D
e29b : 85f4             [ 3] 	sta z80_H
e29d : 48               [ 3]         pha
e29e : a917             [ 2] 	lda #lo(23)		    										
e2a0 : 85f1             [ 3] 	sta z80_E
e2a2 : a900             [ 2] 	lda #hi(23)
e2a4 : 85f2             [ 3] 	sta z80_D
e2a6 : a908             [ 2] 	lda #8														
e2a8 : 85f6             [ 3] 	sta z80_IX+1
                                     
e2aa :                       L2	    
e2aa : 46f0             [ 5]         lsr z80_B													
e2ac : 66ef             [ 5] 	ror z80_C													
e2ae :                       L3	    
e2ae : ac                    	fcb $AC			; clc ($18) or NOP ($EA)
e2af : a5ef             [ 3] 	lda z80_C													
e2b1 : 6900             [ 2] 	adc #00  		    								    	
e2b3 : 91f3             [ 5] 	sta (z80_L),y												
e2b5 : e6f3             [ 5] 	inc z80_L                                       
e2b7 : d002             [ 3]         bne sd
e2b9 : e6f4             [ 5]         inc z80_H
e2bb :                       sd      
e2bb : a5f0             [ 3]         lda z80_B													
e2bd : 6900             [ 2] 	adc #00 													
e2bf : 91f3             [ 5] 	sta (z80_L),y												
e2c1 : 18               [ 2] 	clc                                             
e2c2 : a5f1             [ 3]         lda z80_E
AS65 Assembler for R6502 [1.42].                                     Page   61
---------------------------------- bank3.s -----------------------------------

e2c4 : 65f3             [ 3]         adc z80_L
e2c6 : 85f3             [ 3]         sta z80_L
e2c8 : a5f2             [ 3]         lda z80_D
e2ca : 65f4             [ 3]         adc z80_H
e2cc : 85f4             [ 3]         sta z80_H
e2ce : c6f6             [ 5] 	dec z80_IX+1											    
e2d0 : d0d8             [ 3] 	bne L2														
                             
e2d2 : 68               [ 4] 	pla															
e2d3 : 85f2             [ 3] 	sta z80_D
e2d5 : 68               [ 4] 	pla         
e2d6 : 6902             [ 2]         adc #02     
e2d8 : 85f1             [ 3]         sta z80_E   
e2da : 9002             [ 3]         bcc sf      
e2dc : e6f2             [ 5]         inc z80_D 
                             
e2de :                       sf     
e2de : 68               [ 4] 	pla												    	    
e2df : 85f4             [ 3] 	sta z80_H
e2e1 : 68               [ 4] 	pla
e2e2 : 85f3             [ 3] 	sta z80_L
e2e4 : e6f3             [ 5] 	inc z80_L                                       
e2e6 : d002             [ 3]         bne sg
e2e8 : e6f4             [ 5]         inc z80_H
e2ea :                       sg     
e2ea : 68               [ 4] 	pla												    	    
e2eb : 85f0             [ 3] 	sta z80_B
e2ed : 68               [ 4] 	pla
e2ee : 85ef             [ 3] 	sta z80_C
e2f0 : c6f0             [ 5] 	dec z80_B													
e2f2 : f003             [ 3] 	beq sg1
e2f4 : 4c7ae2           [ 3]         jmp L1
e2f7 :                       sg1        
e2f7 : 68               [ 4] 	pla															
e2f8 : 85f4             [ 3] 	sta z80_H
e2fa : 68               [ 4] 	pla
e2fb : 85f3             [ 3] 	sta z80_L
e2fd : 68               [ 4] 	pla															
e2fe : 85f2             [ 3] 	sta z80_D
e300 : 68               [ 4] 	pla
e301 : 85f1             [ 3] 	sta z80_E
                                     								
e303 : c952             [ 2] 	cmp #lo(TCOLD_1)		        								
e305 : d005             [ 3]         bne CORR_1													
e307 : a9fd             [ 2] 	lda #$FD													
e309 : 8d77ef           [ 4] 	sta NT_+$2E									 				
                             
e30c :                       CORR_1	
e30c : 18               [ 2]         clc                                      
e30d : b1f1             [ 5]         lda (z80_E),y																										
e30f : f037             [ 3] 	beq TC_EXIT													
e311 : 6a               [ 2] 	ror a															
e312 : 08               [ 3] 	php			    ; save carry														
e313 : 0a               [ 2] 	asl a															
e314 : 85ef             [ 3] 	sta z80_C													
e316 : 18               [ 2] 	clc                                             
e317 : 65f3             [ 3]         adc z80_L
e319 : 85f3             [ 3]         sta z80_L
e31b : a5f0             [ 3]         lda z80_B
e31d : 65f4             [ 3]         adc z80_H
e31f : 85f4             [ 3]         sta z80_H                                
e321 : 28               [ 4] 	plp             ; restore carry (du ror)	       
AS65 Assembler for R6502 [1.42].                                     Page   62
---------------------------------- bank3.s -----------------------------------

e322 : 9007             [ 3] 	bcc CORR_2                                      
e324 : b1f3             [ 5] 	lda (z80_L),y												
e326 : 38               [ 2] 	sec															
e327 : e902             [ 2] 	sbc #$02
e329 : 91f3             [ 5] 	sta (z80_L),y
                             	
e32b :                       CORR_2	
e32b : b1f3             [ 5]         lda (z80_L),y												
e32d : 18               [ 2] 	clc			
e32e : 6901             [ 2] 	adc #$01
e330 : 91f3             [ 5] 	sta (z80_L),y
e332 : 38               [ 2]         sec   		                                 
e333 : a5f3             [ 3] 	lda z80_L                                       
e335 : e5ef             [ 3] 	sbc z80_C
e337 : 85f3             [ 3] 	sta z80_L
e339 : a5f4             [ 3] 	lda z80_H
e33b : e5f0             [ 3] 	sbc z80_B
e33d : 85f4             [ 3] 	sta z80_H
e33f : e6f1             [ 5] 	inc z80_E                                       
e341 : d002             [ 3]         bne sh
e343 : e6f2             [ 5]         inc z80_D
e345 :                       sh     
e345 : 4c0ce3           [ 3] 	jmp CORR_1												    
                             
e348 :                       TC_EXIT
e348 : 68               [ 4] 	pla			; restore version number						
                             
                             ;VolTableCreator (c) Ivan Roshin
                             ;A - VersionForVolumeTable (0..4 - 3.xx..3.4x;
                             ;5.. - 3.5x..3.6x..VTII1.0)
                             
e349 : c905             [ 2] 	cmp #5		; version 										
e34b : a911             [ 2] 	lda #lo($11)                                    
e34d : 85f3             [ 3] 	sta z80_L
e34f : a900             [ 2]         lda #hi($11)													
e351 : 85f4             [ 3] 	sta z80_H													
e353 : 85f2             [ 3] 	sta z80_D                                       
e355 : 85f1             [ 3] 	sta z80_E													
e357 : a92a             [ 2] 	lda #$2A	; ($2A = rol A)								    
e359 : b008             [ 3] 	bcs M1		; CP -> carry inverse (CP 5)					
e35b : c6f3             [ 5] 	dec z80_L													
e35d : a5f3             [ 3] 	lda z80_L													
e35f : 85f1             [ 3] 	sta z80_E
e361 : a9ea             [ 2] 	lda #$EA	; ($EA = NOP)			    					
e363 :                       M1          
e363 : 8d8ae3           [ 4]         sta M2														
e366 : a959             [ 2] 	lda #lo(VT_+16)												
e368 : 85f5             [ 3] 	sta z80_IX
e36a : a9ee             [ 2] 	lda #hi(VT_+16)
e36c : 85f6             [ 3] 	sta z80_IX+1
e36e : a910             [ 2] 	lda #$10													
e370 : 85ef             [ 3] 	sta z80_C
                             
e372 :                       INITV2  
e372 : 18               [ 2]         clc
e373 : a5f3             [ 3]         lda z80_L													
e375 : 48               [ 3] 	pha
e376 : 65f1             [ 3]         adc z80_E
e378 : 85f1             [ 3]         sta z80_E
e37a : a5f4             [ 3] 	lda z80_H
e37c : 48               [ 3] 	pha
e37d : 65f2             [ 3]         adc z80_D
AS65 Assembler for R6502 [1.42].                                     Page   63
---------------------------------- bank3.s -----------------------------------

e37f : 85f2             [ 3]         sta z80_D
                             	    
e381 : a900             [ 2]         lda #00														
e383 : 85f3             [ 3] 	sta z80_L
e385 : 85f4             [ 3] 	sta z80_H
e387 : 18               [ 2]         clc
e388 :                       INITV1  
e388 : a5f3             [ 3]         lda z80_L													
e38a :                       M2          
e38a : ac                            fcb $AC	    ; $EA (nop) ou $2A (rol)
e38b : a5f4             [ 3] 	lda z80_H													
e38d : 6900             [ 2] 	adc #00			; + carry                             
e38f : 91f5             [ 5] 	sta (z80_IX),y												
e391 : e6f5             [ 5] 	inc z80_IX                                      
e393 : d002             [ 3]         bne si
e395 : e6f6             [ 5]         inc z80_IX+1
e397 :                       si     
e397 : 18               [ 2] 	clc                                             
e398 : a5f1             [ 3]         lda z80_E
e39a : 65f3             [ 3]         adc z80_L
e39c : 85f3             [ 3]         sta z80_L
e39e : a5f2             [ 3]         lda z80_D
e3a0 : 65f4             [ 3]         adc z80_H
e3a2 : 85f4             [ 3]         sta z80_H
e3a4 : e6ef             [ 5] 	inc z80_C												    
e3a6 : a5ef             [ 3] 	lda z80_C													
e3a8 : 290f             [ 2] 	and #15														
e3aa : 18               [ 2]         clc         ; carry cleared by and
e3ab : d0db             [ 3] 	bne INITV1													
                             
e3ad : 68               [ 4] 	pla															
e3ae : 85f4             [ 3] 	sta z80_H
e3b0 : 68               [ 4] 	pla
e3b1 : 85f3             [ 3] 	sta z80_L
e3b3 : a5f1             [ 3] 	lda z80_E													
e3b5 : c977             [ 2] 	cmp #$77													
e3b7 : d002             [ 3] 	bne M3														
e3b9 : e6f1             [ 5] 	inc z80_E													
e3bb :                       M3      
e3bb : 18               [ 2]         clc                                      
e3bc : a5ef             [ 3]         lda z80_C																								
e3be : d0b2             [ 3] 	bne	INITV2													
                             
e3c0 : 4c37ec           [ 3] 	jmp ROUT													
                             ; ===============================================
                             ; Pattern Decoder
e3c3 :                       PD_OrSm	
e3c3 : a014             [ 2]         ldy #Env_En     										    
e3c5 : a900             [ 2] 	lda #00
e3c7 : 91f5             [ 5] 	sta (z80_IX),y
e3c9 : 2014e7           [ 6] 	jsr SETORN													
e3cc : a000             [ 2] 	ldy #00					; lda ($AC,x)									
e3ce : b1ef             [ 5] 	lda (z80_C),y
e3d0 : e6ef             [ 5] 	inc z80_C                                       
e3d2 : d002             [ 3]         bne sj
e3d4 : e6f0             [ 5]         inc z80_B
e3d6 :                       sj     
e3d6 : 4a               [ 2] 	lsr a 													    
e3d7 : 9002             [ 3]         bcc sj1
e3d9 : 0980             [ 2]         ora #$80
e3db :                       sj1     
e3db :                       PD_SAM	
AS65 Assembler for R6502 [1.42].                                     Page   64
---------------------------------- bank3.s -----------------------------------

e3db : 0a               [ 2]         asl a 											    		
e3dc :                       PD_SAM_	
e3dc : 85f1             [ 3]         sta z80_E													
e3de :                       SamPtrs		
e3de : a9ac             [ 2] 	lda #$AC				
e3e0 : 18               [ 2]         clc
e3e1 : 65f1             [ 3]         adc z80_E
e3e3 : 85f3             [ 3] 	sta z80_L
e3e5 : a9ac             [ 2] 	lda #$AC
e3e7 : 6900             [ 2]         adc #00
e3e9 : 85f4             [ 3] 	sta z80_H
                             
e3eb : a000             [ 2]         ldy #00
e3ed : b1f3             [ 5] 	lda (z80_L),y
e3ef :                       MODADDR		
e3ef : 69ac             [ 2] 	adc #$AC												
e3f1 : aa               [ 2] 	tax             ; save
e3f2 : c8               [ 2] 	iny                                             
e3f3 : b1f3             [ 5] 	lda (z80_L),y
e3f5 : 69ac             [ 2]         adc #$AC								    			
                             
e3f7 : a010             [ 2] 	ldy #SamPtr+1         										
e3f9 : 91f5             [ 5] 	sta (z80_IX),y
e3fb : 88               [ 2] 	dey															
e3fc : 8a               [ 2] 	txa         
e3fd : 91f5             [ 5] 	sta (z80_IX),y
e3ff : 4c74e4           [ 3] 	jmp PD_LOOP													
                             
e402 :                       PD_VOL	
e402 : 0a               [ 2]         asl a															
e403 : 6900             [ 2]         adc #00
e405 : 0a               [ 2] 	asl a															
e406 : 6900             [ 2]         adc #00
e408 : 0a               [ 2] 	asl a															
e409 : 6900             [ 2]         adc #00
e40b : 0a               [ 2] 	asl a															
e40c : 6900             [ 2]         adc #00
e40e : a01c             [ 2] 	ldy #Volume         										
e410 : 91f5             [ 5] 	sta (z80_IX),y
e412 : 4c78e4           [ 3]         jmp PD_LP2													
                             	
e415 :                       PD_EOff	
e415 : a014             [ 2]         ldy #Env_En		    	        							
e417 : 91f5             [ 5] 	sta (z80_IX),y
e419 : a000             [ 2] 	ldy #PsInOr   			    					    		
e41b : 91f5             [ 5] 	sta (z80_IX),y
e41d : 4c78e4           [ 3] 	jmp PD_LP2													
                             
e420 :                       PD_SorE	
e420 : 38               [ 2]         sec															
e421 : e901             [ 2] 	sbc #01
e423 : 85ee             [ 3]         sta z80_A
e425 : d011             [ 3] 	bne PD_ENV													
e427 : a000             [ 2] 	ldy #00			        ; lda ($AC,x)												
e429 : b1ef             [ 5] 	lda (z80_C),y
e42b : e6ef             [ 5] 	inc z80_C                                       
e42d : d002             [ 3]         bne sl
e42f : e6f0             [ 5]         inc z80_B
e431 :                       sl     
e431 : a011             [ 2] 	ldy #NNtSkp    		        								
e433 : 91f5             [ 5] 	sta (z80_IX),y
e435 : 4c78e4           [ 3]         jmp PD_LP2													
AS65 Assembler for R6502 [1.42].                                     Page   65
---------------------------------- bank3.s -----------------------------------

                             
e438 :                       PD_ENV	
e438 : 20d7e6           [ 6]         jsr SETENV													
e43b : 4c78e4           [ 3] 	jmp PD_LP2													
                             
e43e :                       PD_ORN	
e43e : 2014e7           [ 6]         jsr SETORN													
e441 : 4c74e4           [ 3] 	jmp PD_LOOP													
                             
e444 :                       PD_ESAM	
e444 : a014             [ 2]         ldy #Env_En	             									
e446 : 91f5             [ 5] 	sta (z80_IX),y
e448 : a000             [ 2] 	ldy #PsInOr	    		        							
e44a : 91f5             [ 5] 	sta (z80_IX),y
e44c : a5ee             [ 3] 	lda z80_A           
e44e : f003             [ 3]         beq sm														
e450 : 20d7e6           [ 6] 	jsr SETENV
e453 : a000             [ 2] sm	ldy #00			    ; lda ($AC,x)												
e455 : b1ef             [ 5] 	lda (z80_C),y
e457 : e6ef             [ 5] 	inc z80_C                                       
e459 : d002             [ 3]         bne sn
e45b : e6f0             [ 5]         inc z80_B
e45d :                       sn     
e45d : 4cdce3           [ 3]         jmp PD_SAM_								     			    
                             
e460 :                       PTDECOD 
e460 : a012             [ 2]         ldy #Note   							    				
e462 : b1f5             [ 5] 	lda (z80_IX),y
e464 : 8d59e5           [ 4] 	sta PrNote+1												
e467 : a006             [ 2] 	ldy #CrTnSl    		    						    		
e469 : b1f5             [ 5] 	lda (z80_IX),y                                  
e46b : 8d9fe5           [ 4] 	sta PrSlide+1												
e46e : c8               [ 2]         iny 
e46f : b1f5             [ 5] 	lda (z80_IX),y											
e471 : 8da6e5           [ 4] 	sta PrSlide+8
                             
e474 :                       PD_LOOP	
e474 : a910             [ 2]         lda #$10													
e476 : 85f1             [ 3] 	sta z80_E
                             	
e478 :                       PD_LP2	
e478 : a000             [ 2]         ldy #00			    ; lda ($AC,x)												
e47a : b1ef             [ 5] 	lda (z80_C),y
e47c : e6ef             [ 5] 	inc z80_C                                       
e47e : d002             [ 3]         bne so
e480 : e6f0             [ 5]         inc z80_B
e482 :                       so
e482 : 18               [ 2] 	clc															
e483 : 6910             [ 2] 	adc #$10
e485 : 9005             [ 3] 	bcc so1
e487 : 85ee             [ 3]         sta z80_A            
e489 : 4cc3e3           [ 3]         jmp PD_OrSm
e48c : 6920             [ 2] so1     adc #$20                                 
e48e : d003             [ 3] 	bne so11													
e490 : 4c0be5           [ 3]         jmp PD_FIN
e493 : 9003             [ 3] so11	bcc so2													    
e495 : 4cdbe3           [ 3]         jmp PD_SAM
e498 : 6910             [ 2] so2	adc #$10                                     
e49a : f04b             [ 3] 	beq PD_REL													
e49c : 9003             [ 3] 	bcc so3 													
e49e : 4c02e4           [ 3]         jmp PD_VOL
e4a1 : 6910             [ 2] so3	adc #$10                                     
AS65 Assembler for R6502 [1.42].                                     Page   66
---------------------------------- bank3.s -----------------------------------

e4a3 : d003             [ 3] 	bne so4										    			
e4a5 : 4c15e4           [ 3]         jmp PD_EOff
e4a8 : 9003             [ 3] so4	bcc	so5												    	
e4aa : 4c20e4           [ 3] 	jmp PD_SorE
e4ad : 6960             [ 2] so5     adc #96                                  
e4af : b041             [ 3] 	bcs PD_NOTE													
e4b1 : 6910             [ 2] 	adc #$10                                        
e4b3 : 9005             [ 3] 	bcc so6
e4b5 : 85ee             [ 3]         sta z80_A												    	
e4b7 : 4c3ee4           [ 3]         jmp PD_ORN													
e4ba : 6920             [ 2] so6	adc #$20                                     
e4bc : b023             [ 3] 	bcs PD_NOIS													 														
e4be : 6910             [ 2] 	adc #$10                                        
e4c0 : 9005             [ 3]         bcc so7
e4c2 : 85ee             [ 3]         sta z80_A												    	
e4c4 : 4c44e4           [ 3]         jmp PD_ESAM
e4c7 : 0a               [ 2] so7	asl a															
e4c8 : 85f1             [ 3] 	sta z80_E
e4ca : 18               [ 2]         clc                                      
e4cb : 6963             [ 2]         adc #lo(SPCCOMS+$FF20)							        
e4cd : 85f3             [ 3]         sta z80_L
e4cf : a9e6             [ 2] 	lda #hi(SPCCOMS+$FF20)
e4d1 : 6900             [ 2]         adc #00
e4d3 : 85f4             [ 3] 	sta z80_H
                                     ; on doit inverser le PUSH car l'adresse 
e4d5 : a001             [ 2]         ldy #01	
e4d7 : b1f3             [ 5] 	lda (z80_L),y												
e4d9 : 48               [ 3] 	pha             ; push D
e4da : 88               [ 2] 	dey                                             
e4db : b1f3             [ 5] 	lda (z80_L),y										        
e4dd : 48               [ 3] 	pha             ; push E
e4de : 4c74e4           [ 3] 	jmp PD_LOOP													
                             
e4e1 :                       PD_NOIS									
e4e1 : 8d47ee           [ 4]         sta Ns_Base                              
e4e4 : 4c78e4           [ 3] 	jmp PD_LP2													
                             
e4e7 :                       PD_REL	
e4e7 : a015             [ 2]         ldy #Flags   								    			
e4e9 : b1f5             [ 5] 	lda (z80_IX),y
e4eb : 29fe             [ 2] 	and #%11111110
e4ed : 91f5             [ 5] 	sta (z80_IX),y
e4ef : 4cfee4           [ 3] 	jmp PD_RES													
                             	
e4f2 :                       PD_NOTE	
e4f2 : a012             [ 2]         ldy #Note    	 				    						
e4f4 : 91f5             [ 5] 	sta (z80_IX),y	
e4f6 : a015             [ 2] 	ldy #Flags      											
e4f8 : b1f5             [ 5] 	lda (z80_IX),y
e4fa : 0901             [ 2] 	ora #%00000001
e4fc : 91f5             [ 5] 	sta (z80_IX),y
                             	    													
e4fe :                       PD_RES												
e4fe : a900             [ 2]         lda #00	
e500 : 85f3             [ 3]         sta z80_L
e502 : 85f4             [ 3] 	sta z80_H
e504 : a00b             [ 2] 	ldy #11
e506 :                       bres
e506 : 91f5             [ 5] 	sta (z80_IX),y          
e508 : 88               [ 2] 	dey
e509 : 10fb             [ 3]         bpl bres
e50b :                       PD_FIN	
AS65 Assembler for R6502 [1.42].                                     Page   67
---------------------------------- bank3.s -----------------------------------

e50b : a011             [ 2] 	ldy #NNtSkp     						    				
e50d : b1f5             [ 5] 	lda (z80_IX),y
e50f : a01b             [ 2] 	ldy #NtSkCn     		    								
e511 : 91f5             [ 5] 	sta (z80_IX),y
e513 : 60               [ 6] 	rts 														
                             
e514 :                       C_PORTM
e514 : a015             [ 2] 	ldy #Flags  												
e516 : b1f5             [ 5] 	lda (z80_IX),y
e518 : 29fb             [ 2] 	and #%11111011
e51a : 91f5             [ 5] 	sta (z80_IX),y
e51c : a000             [ 2] 	ldy #00			    ; lda ($AC,x)												
e51e : b1ef             [ 5] 	lda (z80_C),y
e520 : a016             [ 2]         ldy #TnSlDl     				    			    		
e522 : 91f5             [ 5] 	sta (z80_IX),y
e524 : a005             [ 2]         ldy #TSlCnt	        			    						
e526 : 91f5             [ 5] 	sta (z80_IX),y
                             
e528 : 18               [ 2]         clc
e529 : a5ef             [ 3]         lda z80_C
e52b : 6903             [ 2]         adc #03
e52d : 85ef             [ 3]         sta z80_C
e52f : 9002             [ 3]         bcc st
e531 : e6f0             [ 5]         inc z80_B
e533 :                       st     
e533 : a949             [ 2] 	lda #lo(NT_)			; OPT										
e535 : 85f1             [ 3] 	sta z80_E
e537 : a9ef             [ 2] 	lda #hi(NT_)           ; OPT
e539 : 85f2             [ 3] 	sta z80_D
e53b : a012             [ 2] 	ldy #Note	        										
e53d : b1f5             [ 5] 	lda (z80_IX),y
e53f : a013             [ 2] 	ldy #SlToNt         										
e541 : 91f5             [ 5] 	sta (z80_IX),y
e543 : 0a               [ 2] 	asl a																																											
e544 : 18               [ 2] 	clc                                             
e545 : 65f1             [ 3]         adc z80_E           ; OPT
e547 : 85f3             [ 3]         sta z80_L
e549 : a5f2             [ 3]         lda z80_D           ; OPT
e54b : 6900             [ 2]         adc #00           
e54d : 85f4             [ 3]         sta z80_H
e54f : a000             [ 2]         ldy #00	
e551 : b1f3             [ 5] 	lda (z80_L),y 												
e553 : 48               [ 3] 	pha	
e554 : c8               [ 2] 	iny                                             
e555 : b1f3             [ 5] 	lda (z80_L),y 												
e557 : 48               [ 3] 	pha
e558 :                       PrNote	
e558 : a93e             [ 2]         lda #$3E													
e55a : a012             [ 2] 	ldy #Note   					    						
e55c : 91f5             [ 5] 	sta (z80_IX),y
e55e : 0a               [ 2] 	asl a																																			
e55f : 18               [ 2] 	clc                                             
e560 : 65f1             [ 3]         adc z80_E           ; OPT
e562 : 85f3             [ 3]         sta z80_L
e564 : a5f2             [ 3]         lda z80_D           ; OPT
e566 : 6900             [ 2]         adc #00
e568 : 85f4             [ 3]         sta z80_H
e56a : a000             [ 2] 	ldy #00
e56c : b1f3             [ 5]         lda (z80_L),y												
e56e : 85f1             [ 3] 	sta z80_E
e570 : c8               [ 2] 	iny                                             
e571 : b1f3             [ 5] 	lda (z80_L),y											    
AS65 Assembler for R6502 [1.42].                                     Page   68
---------------------------------- bank3.s -----------------------------------

e573 : 85f2             [ 3] 	sta z80_D
e575 : a019             [ 2] 	ldy #TnDelt 
e577 : 68               [ 4]         pla															
e578 : 85f4             [ 3] 	sta z80_H
e57a : 68               [ 4] 	pla       
e57b : 38               [ 2] 	sec                                             
e57c : e5f1             [ 3]         sbc z80_E
e57e : 85f3             [ 3]         sta z80_L
e580 : 91f5             [ 5]         sta (z80_IX),y
e582 : a5f4             [ 3]         lda z80_H
e584 : e5f2             [ 3]         sbc z80_D
e586 : 85f4             [ 3]         sta z80_H 
e588 : c8               [ 2]         iny                                      
e589 : 91f5             [ 5]         sta (z80_IX),y
e58b : a006             [ 2] 	ldy #CrTnSl                                     
e58d : b1f5             [ 5]         lda (z80_IX),y
e58f : 85f1             [ 3]         sta z80_E
e591 : c8               [ 2] 	iny                                             
e592 : b1f5             [ 5]         lda (z80_IX),y
e594 : 85f2             [ 3]         sta z80_D
e596 :                       Version
e596 : a93e             [ 2] 	lda #$3E                                        
e598 : c906             [ 2] 	cmp #6                                          
e59a : 900f             [ 3] 	bcc OLDPRTM     ; < 6
e59c : a006             [ 2]         ldy #CrTnSl                              
e59e :                       PrSlide	
e59e : a9ac             [ 2]         lda #$AC                                 
e5a0 : 85f1             [ 3]         sta z80_E
e5a2 : 91f5             [ 5]         sta (z80_IX),y
e5a4 : c8               [ 2]         iny
e5a5 : a9ac             [ 2]         lda #$AC
e5a7 : 85f2             [ 3]         sta z80_D
e5a9 : 91f5             [ 5]         sta (z80_IX),y
                             	                                                
e5ab :                       OLDPRTM	
e5ab : a000             [ 2]         ldy #00                                  
e5ad : b1ef             [ 5]         lda (z80_C),y
e5af : c8               [ 2]         iny                                      
e5b0 : 85f7             [ 3]         sta z80_AP                               
e5b2 : b1ef             [ 5] 	lda (z80_C),y                                   
e5b4 : 85ee             [ 3] 	sta z80_A
e5b6 : a5ef             [ 3]         lda z80_C
e5b8 : 18               [ 2]         clc
e5b9 : 6902             [ 2]         adc #02
e5bb : 85ef             [ 3]         sta z80_C
e5bd : 9002             [ 3]         bcc sw
e5bf : e6f0             [ 5]         inc z80_B
e5c1 :                       sw
e5c1 : a5ee             [ 3] 	lda z80_A                                       
e5c3 : f010             [ 3] 	beq NOSIG                                       
e5c5 : a5f1             [ 3] 	lda z80_E													
e5c7 : a6f3             [ 3] 	ldx z80_L
e5c9 : 85f3             [ 3] 	sta z80_L
e5cb : 86f1             [ 3] 	stx z80_E
e5cd : a5f2             [ 3] 	lda z80_D
e5cf : a6f4             [ 3] 	ldx z80_H
e5d1 : 85f4             [ 3] 	sta z80_H
e5d3 : 86f2             [ 3] 	stx z80_D
e5d5 :                       NOSIG	
e5d5 : 38               [ 2]         sec                            
e5d6 : a5f3             [ 3]         lda z80_L
e5d8 : e5f1             [ 3]         sbc z80_E
AS65 Assembler for R6502 [1.42].                                     Page   69
---------------------------------- bank3.s -----------------------------------

e5da : 85f3             [ 3]         sta z80_L
e5dc : a5f4             [ 3]         lda z80_H
e5de : e5f2             [ 3]         sbc z80_D
e5e0 : 85f4             [ 3]         sta z80_H
e5e2 : 1015             [ 3] 	bpl SET_STP                                     
e5e4 : a5ee             [ 3] 	lda z80_A                                       
e5e6 : 49ff             [ 2]         eor #$FF                                 
e5e8 : a6f7             [ 3]         ldx z80_AP                               
e5ea : 85f7             [ 3]         sta z80_AP
e5ec : 8a               [ 2]         txa
e5ed : 49ff             [ 2] 	eor #$FF                                        
e5ef : 18               [ 2]         clc             
e5f0 : 6901             [ 2]         adc #01                                  
e5f2 : aa               [ 2]         tax                                      
e5f3 : a5f7             [ 3]         lda z80_AP
e5f5 : 86f7             [ 3]         stx z80_AP
e5f7 : 85ee             [ 3]         sta z80_A
e5f9 :                       SET_STP	
e5f9 : a018             [ 2]         ldy #(TSlStp+1)                          
e5fb : a5ee             [ 3]         lda z80_A
e5fd : 91f5             [ 5]         sta (z80_IX),y                           
e5ff : aa               [ 2]         tax                                      
e600 : a5f7             [ 3]         lda z80_AP
e602 : 86f7             [ 3]         stx z80_AP
e604 : 85ee             [ 3]         sta z80_A
e606 : 88               [ 2] 	    dey                       
e607 : 91f5             [ 5]         sta (z80_IX),y
e609 : a00a             [ 2]         ldy #COnOff                              
e60b : a900             [ 2]         lda #00
e60d : 91f5             [ 5]         sta (z80_IX),y
e60f : 60               [ 6] 	rts                                             
                             
e610 :                       C_GLISS	
e610 : a015             [ 2]         ldy #Flags       											
e612 : b1f5             [ 5] 	lda (z80_IX),y
e614 : 0904             [ 2] 	ora #%00000100
e616 : 91f5             [ 5] 	sta (z80_IX),y
e618 : a000             [ 2] 	ldy #00                 ; lda ($AC,x)	          
e61a : b1ef             [ 5]         lda (z80_C),y
e61c : 85ee             [ 3]         sta z80_A
e61e : e6ef             [ 5]         inc z80_C                                
e620 : d002             [ 3]         bne sy
e622 : e6f0             [ 5]         inc z80_B
e624 :                       sy     
e624 : a016             [ 2] 	ldy #TnSlDl                                     
e626 : 91f5             [ 5]         sta (z80_IX),y
e628 : 18               [ 2] 	clc                                             
e629 : a5ee             [ 3]         lda z80_A                                
e62b : d00d             [ 3] 	bne GL36                                        
e62d : ad97e5           [ 4] 	lda Version+1                                   
e630 : c907             [ 2] 	cmp #7                                          
e632 : b004             [ 3] 	bcs sz                                          
e634 : a900             [ 2]         lda #00         ; si A < 7  , A = 0 ($FF+
e636 : f002             [ 3]         beq saa
e638 : a901             [ 2] sz      lda #01         ; si A >= 7 , A = 1 ($00+
e63a :                       saa	    
e63a :                       GL36	
e63a : a005             [ 2]         ldy #TSlCnt                              
e63c : 91f5             [ 5] 	sta (z80_IX),y                                  
e63e : a000             [ 2]         ldy #00                                  
e640 : b1ef             [ 5]         lda (z80_C),y
e642 : 85f7             [ 3]         sta z80_AP
AS65 Assembler for R6502 [1.42].                                     Page   70
---------------------------------- bank3.s -----------------------------------

e644 : c8               [ 2]         iny
e645 : b1ef             [ 5]         lda (z80_C),y
e647 : 85ee             [ 3]         sta z80_A
e649 : 18               [ 2]         clc
e64a : a5ef             [ 3]         lda z80_C
e64c : 6902             [ 2]         adc #02
e64e : 85ef             [ 3]         sta z80_C                                
e650 : 9002             [ 3]         bcc sac
e652 : e6f0             [ 5]         inc z80_B
e654 :                       sac     
e654 : 4cf9e5           [ 3] 	jmp SET_STP                                     
                             
e657 :                       C_SMPOS	
e657 : a000             [ 2]         ldy #00                  ; lda ($AC,x)	  
e659 : b1ef             [ 5]         lda (z80_C),y
e65b : e6ef             [ 5]         inc z80_C                                
e65d : d002             [ 3]         bne sad
e65f : e6f0             [ 5]         inc z80_B
e661 :                       sad     
e661 : a001             [ 2] 	ldy #PsInSm                                     
e663 : 91f5             [ 5]         sta (z80_IX),y
e665 : 60               [ 6] 	rts                                             
                             
e666 :                       C_ORPOS	
e666 : a000             [ 2]         ldy #00                 ; lda ($AC,x)	   
e668 : b1ef             [ 5]         lda (z80_C),y
e66a : e6ef             [ 5]         inc z80_C                                
e66c : d002             [ 3]         bne sae
e66e : e6f0             [ 5]         inc z80_B
e670 :                       sae     
e670 : a000             [ 2] 	ldy #PsInOr                                     
e672 : 91f5             [ 5]         sta (z80_IX),y
e674 : 60               [ 6] 	rts                                             
                                 
e675 :                       C_VIBRT	
e675 : a000             [ 2]         ldy #00                 ; lda ($AC,x)	   
e677 : b1ef             [ 5]         lda (z80_C),y
e679 : e6ef             [ 5]         inc z80_C                                
e67b : d002             [ 3]         bne saf
e67d : e6f0             [ 5]         inc z80_B
e67f :                       saf     
e67f : a00b             [ 2] 	ldy #OnOffD                                     
e681 : 91f5             [ 5]         sta (z80_IX),y
e683 : a00a             [ 2]         ldy #COnOff                              
e685 : 91f5             [ 5]         sta (z80_IX),y
e687 : a000             [ 2] 	ldy #00                 ; lda ($AC,x)	          
e689 : b1ef             [ 5]         lda (z80_C),y
e68b : e6ef             [ 5]         inc z80_C                                
e68d : d002             [ 3]         bne sag
e68f : e6f0             [ 5]         inc z80_B
e691 : a00c             [ 2] sag     ldy #OffOnD                              
e693 : 91f5             [ 5]         sta (z80_IX),y
e695 : a900             [ 2]         lda #00                                  
e697 : a005             [ 2]         ldy #TSlCnt                              
e699 : 91f5             [ 5]         sta (z80_IX),y
e69b : a006             [ 2] 	ldy #CrTnSl                                     
e69d : 91f5             [ 5]         sta (z80_IX),y
e69f : c8               [ 2] 	iny                                             
e6a0 : 91f5             [ 5]         sta (z80_IX),y
e6a2 : 60               [ 6] 	rts                                             
                             
e6a3 :                       C_ENGLS	
AS65 Assembler for R6502 [1.42].                                     Page   71
---------------------------------- bank3.s -----------------------------------

e6a3 : a000             [ 2]         ldy #00                                  
e6a5 : b1ef             [ 5]         lda (z80_C),y
e6a7 : 8d24ec           [ 4]         sta Env_Del+1                            
e6aa : 8d46ee           [ 4] 	sta CurEDel
e6ad : c8               [ 2]         iny
e6ae : b1ef             [ 5]         lda (z80_C),y
e6b0 : 85f3             [ 3]         sta z80_L                                
e6b2 : 8d29ec           [ 4]         sta ESldAdd+1
e6b5 : c8               [ 2]         iny
e6b6 : b1ef             [ 5]         lda (z80_C),y
e6b8 : 85f4             [ 3]         sta z80_H                                
e6ba : 8d31ec           [ 4] 	sta ESldAdd+9
e6bd : 18               [ 2]         clc
e6be : a5ef             [ 3]         lda z80_C 
e6c0 : 6903             [ 2]         adc #03
e6c2 : 85ef             [ 3]         sta z80_C
e6c4 : 9002             [ 3]         bcc sah
e6c6 : e6f0             [ 5]         inc z80_B
e6c8 :                       sah	                                             
e6c8 : 60               [ 6] 	rts                                             
                             
e6c9 :                       C_DELAY	
e6c9 : a000             [ 2]         ldy #00                 ; lda ($AC,x)	   
e6cb : b1ef             [ 5]         lda (z80_C),y
e6cd : e6ef             [ 5]         inc z80_C                                
e6cf : d002             [ 3]         bne sak
e6d1 : e6f0             [ 5]         inc z80_B
e6d3 :                       sak
e6d3 : 8d5feb           [ 4] 	sta Delay+1                                     
e6d6 : 60               [ 6] 	rts                                             
                             
e6d7 :                       SETENV	
e6d7 : a014             [ 2]         ldy #Env_En                              
e6d9 : a5f1             [ 3]         lda z80_E
e6db : 91f5             [ 5]         sta (z80_IX),y
e6dd : a5ee             [ 3]         lda z80_A                ; OPT (inverser 
e6df : 8d56ee           [ 4]         sta AYREGS+EnvTp
e6e2 : a000             [ 2] 	ldy #00                                         
e6e4 : b1ef             [ 5]         lda (z80_C),y           
e6e6 : 85f4             [ 3] 	sta z80_H                                       
e6e8 : 8d58ee           [ 4]         sta EnvBase+1                            
e6eb : c8               [ 2] 	iny                                             
e6ec : b1ef             [ 5]         lda (z80_C),y
e6ee : 85f3             [ 3] 	sta z80_L                                       
e6f0 : 8d57ee           [ 4] 	sta EnvBase
e6f3 : a5ef             [ 3]         lda z80_C
e6f5 : 18               [ 2]         clc
e6f6 : 6902             [ 2]         adc #02
e6f8 : 85ef             [ 3]         sta z80_C
e6fa : 9002             [ 3]         bcc sam
e6fc : e6f0             [ 5]         inc z80_B                                
e6fe : a900             [ 2] sam	lda #00                                      
e700 : a000             [ 2] 	ldy #PsInOr                                     
e702 : 91f5             [ 5]         sta (z80_IX),y
e704 : 8d46ee           [ 4] 	sta CurEDel                                     
e707 : 85f4             [ 3] 	sta z80_H                                       
e709 : 8d45ee           [ 4]         sta CurESld+1                            
e70c : 85f3             [ 3] 	sta z80_L                                       
e70e : 85ee             [ 3]         sta z80_A
e710 : 8d44ee           [ 4] 	sta CurESld                                     
e713 :                       C_NOP	
e713 : 60               [ 6]         rts                                      
AS65 Assembler for R6502 [1.42].                                     Page   72
---------------------------------- bank3.s -----------------------------------

                             
e714 :                       SETORN	
e714 : a5ee             [ 3]         lda z80_A
e716 : 0a               [ 2]         asl a                                    
e717 : 85f1             [ 3] 	sta z80_E                                       
e719 : a900             [ 2] 	lda #00             ; OPT (inutile ?)           
e71b : 85f2             [ 3]         sta z80_D
e71d : a000             [ 2] 	ldy #PsInOr                                     
e71f : 91f5             [ 5]         sta (z80_IX),y
e721 :                       OrnPtrs
e721 : a9ac             [ 2] 	    lda #$AC           
e723 : 18               [ 2]         clc
e724 : 65f1             [ 3]         adc z80_E                                
e726 : 85f3             [ 3]         sta z80_L
e728 : a9ac             [ 2]         lda #$AC
e72a : 6900             [ 2]         adc #00
e72c : 85f4             [ 3]         sta z80_H
e72e : a000             [ 2] 	ldy #00                                         
e730 : b1f3             [ 5]         lda (z80_L),y
e732 :                       MDADDR2
e732 : 69ac             [ 2] 	adc #$AC
e734 : aa               [ 2]         tax             ; save
e735 : c8               [ 2] 	iny                                             
e736 : b1f3             [ 5] 	lda (z80_L),y
e738 : 69ac             [ 2]         adc #$AC                                 
                             	    
e73a : a00e             [ 2] 	ldy #OrnPtr+1                                   
e73c : 91f5             [ 5]         sta (z80_IX),y
e73e : 88               [ 2]         dey
e73f : 8a               [ 2] 	txa                                             
e740 : 91f5             [ 5]         sta (z80_IX),y
e742 : 60               [ 6] 	rts                                             
                             
                             ;ALL 16 ADDRESSES TO PROTECT FROM BROKEN PT3 MODU
e743 :                       SPCCOMS 
e743 : 12e7                          fcw C_NOP-1
e745 : 0fe6                  	fcw C_GLISS-1
e747 : 13e5                  	fcw C_PORTM-1
e749 : 56e6                  	fcw C_SMPOS-1
e74b : 65e6                  	fcw C_ORPOS-1
e74d : 74e6                  	fcw C_VIBRT-1
e74f : 12e7                  	fcw C_NOP-1
e751 : 12e7                  	fcw C_NOP-1
e753 : a2e6                  	fcw C_ENGLS-1
e755 : c8e6                  	fcw C_DELAY-1
e757 : 12e7                  	fcw C_NOP-1
e759 : 12e7                  	fcw C_NOP-1
e75b : 12e7                  	fcw C_NOP-1
e75d : 12e7                  	fcw C_NOP-1
e75f : 12e7                  	fcw C_NOP-1
e761 : 12e7                  	fcw C_NOP-1
                             ; ===============================================
e763 :                       CHREGS	
e763 : a900             [ 2]         lda #00                                  
e765 : 85ee             [ 3] 	    sta z80_A       ; save
e767 : 8d53ee           [ 4]         sta Ampl                                 
e76a : a5f3             [ 3] 	    lda z80_L                                   
e76c : 85fc             [ 3]         sta val3                                 
e76e : a5f4             [ 3]         lda z80_H
e770 : 85fd             [ 3]         sta val3+1
e772 : a015             [ 2]         ldy #Flags                               
e774 : a901             [ 2]         lda #%00000001
AS65 Assembler for R6502 [1.42].                                     Page   73
---------------------------------- bank3.s -----------------------------------

e776 : 85f8             [ 3]         sta val1
e778 : b1f5             [ 5]         lda (z80_IX),y
e77a : 24f8             [ 3]         bit val1
e77c : d003             [ 3] 	    bne saq
e77e : 4cfae9           [ 3]         jmp CH_EXIT                              
e781 :                       saq     	
                                                                              
e781 : a00d             [ 2] 	    ldy #OrnPtr                                 
e783 : b1f5             [ 5]         lda (z80_IX),y
e785 : 85f3             [ 3]         sta z80_L
e787 : 85f8             [ 3]         sta val1            ; save L
e789 : c8               [ 2]         iny                                      
e78a : b1f5             [ 5]         lda (z80_IX),y
e78c : 85f4             [ 3]         sta z80_H
e78e : 85f9             [ 3]         sta val1+1          ; save H
                             	                                                
e790 : a000             [ 2]         ldy #00
e792 : b1f3             [ 5]         lda (z80_L),y                            
e794 : 85f1             [ 3]         sta z80_E
e796 : c8               [ 2]         iny
e797 : b1f3             [ 5]         lda (z80_L),y
e799 : 85f2             [ 3]         sta z80_D
e79b : a000             [ 2] 	    ldy #PsInOr                                 
e79d : b1f5             [ 5]         lda (z80_IX),y
e79f : 85f3             [ 3] 	    sta z80_L                                   
e7a1 : 85ee             [ 3]         sta z80_A                                
e7a3 : 18               [ 2] 	    clc
e7a4 : a5f8             [ 3]         lda val1
e7a6 : 65f3             [ 3]         adc z80_L
e7a8 : 85f3             [ 3]         sta z80_L
e7aa : a5f9             [ 3]         lda val1+1
e7ac : 6900             [ 2]         adc #00                
e7ae : 85f4             [ 3]         sta z80_H                                
e7b0 : a5f3             [ 3]         lda z80_L
e7b2 : 6902             [ 2]         adc #02
e7b4 : 85f3             [ 3]         sta z80_L
e7b6 : a5f4             [ 3]         lda z80_H
e7b8 : 6900             [ 2]         adc #00
e7ba : 85f4             [ 3]         sta z80_H
e7bc : a5ee             [ 3]         lda z80_A                                
e7be : 6901             [ 2]         adc #01
e7c0 : c5f2             [ 3]         cmp z80_D                                
e7c2 : 9003             [ 3] 	    bcc CH_ORPS                                 
e7c4 : 18               [ 2] 	    clc
e7c5 : a5f1             [ 3]         lda z80_E                                
e7c7 :                       CH_ORPS	
e7c7 : a000             [ 2]         ldy #PsInOr                              
e7c9 : 91f5             [ 5]         sta (z80_IX),y
e7cb : a012             [ 2] 	    ldy #Note                                   
e7cd : b1f5             [ 5]         lda (z80_IX),y
e7cf : a000             [ 2] 	    ldy #00                                     
e7d1 : 71f3             [ 5]         adc (z80_L),y       ; adc ($AC,x)	
e7d3 : 1002             [ 3] 	    bpl CH_NTP                                  
e7d5 : a900             [ 2] 	    lda #00                                     
e7d7 :                       CH_NTP	
e7d7 : c960             [ 2]         cmp #96                                  
e7d9 : 9002             [ 3] 	    bcc CH_NOK                                  
e7db : a95f             [ 2] 	    lda #95                                     
e7dd :                       CH_NOK	
e7dd : 0a               [ 2]         asl a                                    
e7de : 85f7             [ 3]         sta z80_AP                               
e7e0 : a00f             [ 2] 	    ldy #SamPtr                                 
AS65 Assembler for R6502 [1.42].                                     Page   74
---------------------------------- bank3.s -----------------------------------

e7e2 : b1f5             [ 5]         lda (z80_IX),y
e7e4 : 85f3             [ 3]         sta z80_L
e7e6 : 85f8             [ 3] 	    sta val1            ; save L
e7e8 : c8               [ 2]         iny                                      
e7e9 : b1f5             [ 5]         lda (z80_IX),y
e7eb : 85f4             [ 3]         sta z80_H
e7ed : 85f9             [ 3]         sta val1+1          ; save H
e7ef : a000             [ 2] 	    ldy #00
e7f1 : b1f3             [ 5]         lda (z80_L),y                            
e7f3 : 85f1             [ 3]         sta z80_E   
e7f5 : c8               [ 2]         iny
e7f6 : b1f3             [ 5]         lda (z80_L),y
e7f8 : 85f2             [ 3]         sta z80_D   
                             
e7fa : a001             [ 2] 	    ldy #PsInSm                                 
e7fc : b1f5             [ 5]         lda (z80_IX),y
e7fe : 85f0             [ 3] 	    sta z80_B                                   
e800 : 0a               [ 2] 	    asl a                                       
e801 : 0a               [ 2] 	    asl a                                       
e802 : 85f3             [ 3] 	    sta z80_L                                   
e804 : 18               [ 2]         clc
e805 : 65f8             [ 3]         adc val1
e807 : 85f3             [ 3]         sta z80_L
e809 : a5f9             [ 3]         lda val1+1
e80b : 6900             [ 2]         adc #00
e80d : 85f4             [ 3]         sta z80_H                                
e80f : a5f3             [ 3]         lda z80_L
e811 : 6902             [ 2]         adc #02
e813 : 85f3             [ 3]         sta z80_L
e815 : a5f4             [ 3]         lda z80_H
e817 : 6900             [ 2]         adc #00
e819 : 85f4             [ 3]         sta z80_H
                             
e81b : a5f0             [ 3] 	    lda z80_B                                   
e81d : 6901             [ 2]         adc #01
e81f : c5f2             [ 3] 	    cmp z80_D                                   
e821 : 9002             [ 3] 	    bcc CH_SMPS                                 
e823 : a5f1             [ 3] 	    lda z80_E                                   
e825 :                       CH_SMPS	
e825 : a001             [ 2]         ldy #PsInSm                              
e827 : 91f5             [ 5]         sta (z80_IX),y
e829 : a000             [ 2]         ldy #00
e82b : b1f3             [ 5]         lda (z80_L),y                            
e82d : 85ef             [ 3]         sta z80_C
e82f : c8               [ 2]         iny
e830 : b1f3             [ 5]         lda (z80_L),y
e832 : 85f0             [ 3]         sta z80_B
                             
e834 : a008             [ 2]         ldy #TnAcc                               
e836 : b1f5             [ 5]         lda (z80_IX),y
e838 : 85f1             [ 3]         sta z80_E
e83a : c8               [ 2]         iny
e83b : b1f5             [ 5]         lda (z80_IX),y
e83d : 85f2             [ 3] 	    sta z80_D                                   
e83f : 18               [ 2] 	    clc                                         
e840 : a002             [ 2]         ldy #02
e842 : b1f3             [ 5]         lda (z80_L),y                            
e844 : 65f1             [ 3]         adc z80_E
e846 : aa               [ 2]         tax
e847 : c8               [ 2]         iny
e848 : b1f3             [ 5]         lda (z80_L),y
e84a : 65f2             [ 3]         adc z80_D
AS65 Assembler for R6502 [1.42].                                     Page   75
---------------------------------- bank3.s -----------------------------------

e84c : 85f4             [ 3]         sta z80_H
e84e : 85f2             [ 3]         sta z80_D
e850 : 8a               [ 2]         txa
e851 : 85f3             [ 3]         sta z80_L
e853 : 85f1             [ 3]         sta z80_E
                             
e855 : a940             [ 2]         lda #%01000000                           
e857 : 24f0             [ 3]         bit z80_B
e859 : f00b             [ 3] 	    beq CH_NOAC                                 
e85b : a008             [ 2] 	    ldy #TnAcc                                  
e85d : a5f3             [ 3]         lda z80_L
e85f : 91f5             [ 5]         sta (z80_IX),y
e861 : c8               [ 2] 	    iny                                         
e862 : a5f4             [ 3]         lda z80_H
e864 : 91f5             [ 5]         sta (z80_IX),y
e866 :                       CH_NOAC 												             
e866 : a5f7             [ 3]         lda z80_AP                               
e868 : 85ee             [ 3]         sta z80_A                                
e86a : 85f3             [ 3]         sta z80_L                                
e86c : 18               [ 2]         clc
e86d : a949             [ 2]         lda #lo(NT_)
e86f : 65f3             [ 3]         adc z80_L
e871 : 85f3             [ 3]         sta z80_L
e873 : a9ef             [ 2]         lda #hi(NT_)
e875 : 6900             [ 2]         adc #00
e877 : 85f4             [ 3]         sta z80_H
e879 : a000             [ 2]         ldy #00
e87b : b1f3             [ 5]         lda (z80_L),y                            
e87d : 65f1             [ 3]         adc z80_E
e87f : aa               [ 2]         tax
e880 : c8               [ 2]         iny
e881 : b1f3             [ 5]         lda (z80_L),y
e883 : 65f2             [ 3]         adc z80_D                                
e885 : 85f4             [ 3]         sta z80_H
e887 : 8a               [ 2]         txa
e888 : 85f3             [ 3]         sta z80_L
e88a : 18               [ 2]         clc
e88b : a006             [ 2] 	    ldy #CrTnSl                                 
e88d : b1f5             [ 5]         lda (z80_IX),y
e88f : 85f1             [ 3]         sta z80_E
e891 : 65f3             [ 3]         adc z80_L
e893 : 85f3             [ 3]         sta z80_L
e895 : 85fc             [ 3] 	    sta val3
e897 : c8               [ 2]         iny                                      
e898 : b1f5             [ 5]         lda (z80_IX),y
e89a : 85f2             [ 3]         sta z80_D
e89c : 65f4             [ 3]         adc z80_H
e89e : 85f4             [ 3]         sta z80_H
e8a0 : 85fd             [ 3]         sta val3+1
                             ;CSP_	    
                             	   
e8a2 : a900             [ 2]         lda #00                                  
e8a4 : a005             [ 2] 	    ldy #TSlCnt                                 
e8a6 : 11f5             [ 5]         ora (z80_IX),y
e8a8 : 85ee             [ 3] 	    sta z80_A
e8aa : d003             [ 3]         bne saq1                                 
e8ac : 4c2ae9           [ 3]         jmp CH_AMP
e8af : b1f5             [ 5] saq1	lda (z80_IX),y                              
e8b1 : 38               [ 2]         sec
e8b2 : e901             [ 2]         sbc #01
e8b4 : 91f5             [ 5]         sta (z80_IX),y
e8b6 : d072             [ 4] 	    bne CH_AMP                                  
AS65 Assembler for R6502 [1.42].                                     Page   76
---------------------------------- bank3.s -----------------------------------

e8b8 : a016             [ 2] 	    ldy #TnSlDl                                 
e8ba : b1f5             [ 5]         lda (z80_IX),y
e8bc : a005             [ 2]         ldy #TSlCnt                              
e8be : 91f5             [ 5]         sta (z80_IX),y
e8c0 : 18               [ 2] 	    clc
e8c1 : a017             [ 2]         ldy #TSlStp                              
e8c3 : b1f5             [ 5]         lda (z80_IX),y
e8c5 : 65f1             [ 3]         adc z80_E
e8c7 : 85f3             [ 3]         sta z80_L
e8c9 : c8               [ 2] 	    iny                                         
e8ca : b1f5             [ 5]         lda (z80_IX),y
e8cc : 65f2             [ 3]         adc z80_D
e8ce : 85f4             [ 3]         sta z80_H 
e8d0 : 85ee             [ 3] 	    sta z80_A       ; save                      
e8d2 : a007             [ 2] 	    ldy #CrTnSl+1                               
e8d4 : 91f5             [ 5]         sta (z80_IX),y
e8d6 : 88               [ 2]         dey                                      
e8d7 : a5f3             [ 3]         lda z80_L
e8d9 : 91f5             [ 5]         sta (z80_IX),y
e8db : a904             [ 2] 	    lda #%00000100                              
e8dd : 85f8             [ 3]         sta val1
e8df : a015             [ 2]         ldy #Flags
e8e1 : b1f5             [ 5]         lda (z80_IX),y
e8e3 : 24f8             [ 3]         bit val1
e8e5 : d043             [ 4] 	    bne CH_AMP  	                               
e8e7 : a019             [ 2] 	    ldy #TnDelt                                 
e8e9 : b1f5             [ 5]         lda (z80_IX),y
e8eb : 85f1             [ 3]         sta z80_E
e8ed : c8               [ 2] 	    iny                                         
e8ee : b1f5             [ 5]         lda (z80_IX),y
e8f0 : 85f2             [ 3]         sta z80_D
e8f2 : a5ee             [ 3] 	lda z80_A                                       
e8f4 : f010             [ 4] 	beq CH_STPP                                     
e8f6 : a5f1             [ 3] 	lda z80_E												
e8f8 : a6f3             [ 3] 	ldx z80_L
e8fa : 85f3             [ 3] 	sta z80_L
e8fc : 86f1             [ 3] 	stx z80_E
e8fe : a5f2             [ 3] 	lda z80_D
e900 : a6f4             [ 3] 	ldx z80_H
e902 : 85f4             [ 3] 	sta z80_H
e904 : 86f2             [ 3] 	stx z80_D
e906 :                       CH_STPP
e906 : 38               [ 2]         sec           ; carry = 0 becoze And A   
e907 : a5f3             [ 3]         lda z80_L
e909 : e5f1             [ 3]         sbc z80_E
e90b : 85f3             [ 3]         sta z80_L
e90d : a5f4             [ 3]         lda z80_H
e90f : e5f2             [ 3]         sbc z80_D
e911 : 85f4             [ 3]         sta z80_H
e913 : 3015             [ 3]         bmi CH_AMP                               
e915 : a013             [ 2] 	ldy #SlToNt                                     
e917 : b1f5             [ 5]         lda (z80_IX),y
e919 : a012             [ 2] 	ldy #Note                                       
e91b : 91f5             [ 5]         sta (z80_IX),y
e91d : a900             [ 2] 	lda #00                                         
e91f : a005             [ 2] 	ldy #TSlCnt                                     
e921 : 91f5             [ 5]         sta (z80_IX),y
e923 : a006             [ 2] 	ldy #CrTnSl                                     
e925 : 91f5             [ 5]         sta (z80_IX),y
e927 : c8               [ 2]         iny                                      
e928 : 91f5             [ 5]         sta (z80_IX),y
                             
AS65 Assembler for R6502 [1.42].                                     Page   77
---------------------------------- bank3.s -----------------------------------

e92a :                       CH_AMP	
e92a : a002             [ 2]         ldy #CrAmSl                              
e92c : b1f5             [ 5]         lda (z80_IX),y
e92e : 85ee             [ 3] 	    sta z80_A       ; save
e930 : a980             [ 2]         lda #%10000000                           
e932 : 24ef             [ 3]         bit z80_C
e934 : f021             [ 3] 	    beq CH_NOAM                                 
e936 : a940             [ 2] 	    lda #%01000000                              
e938 : 24ef             [ 3]         bit z80_C
e93a : f00c             [ 3] 	    beq CH_AMIN                                 
e93c : a5ee             [ 3] 	    lda z80_A                                   
e93e : c90f             [ 2]         cmp #15
e940 : f015             [ 3] 	    beq CH_NOAM                                 
e942 : 18               [ 2] 	    clc                                         
e943 : 6901             [ 2]         adc #01
e945 : 4c51e9           [ 3] 	    jmp CH_SVAM                                 
e948 :                       CH_AMIN	
e948 : a5ee             [ 3]         lda z80_A                                
e94a : c9f1             [ 2]         cmp #$F1            ; -15
e94c : f009             [ 3] 	    beq CH_NOAM                                 
e94e : 38               [ 2] 	    sec                                         
e94f : e901             [ 2]         sbc #01
e951 :                       CH_SVAM	
e951 : a002             [ 2]         ldy #CrAmSl                              
e953 : 91f5             [ 5]         sta (z80_IX),y
e955 : 85ee             [ 3]         sta z80_A
e957 :                       CH_NOAM	
e957 : a5ee             [ 3]         lda z80_A
e959 : 85f3             [ 3]         sta z80_L                                
e95b : a5f0             [ 3] 	    lda z80_B                                   
e95d : 290f             [ 2] 	    and #15                                     
e95f : 18               [ 2] 	    clc                                         
e960 : 65f3             [ 3]         adc z80_L
e962 : 1002             [ 3] 	    bpl CH_APOS                                 
e964 : a900             [ 2] 	    lda #00                                     
e966 :                       CH_APOS	
e966 : c910             [ 2]         cmp #16                                  
e968 : 9002             [ 3] 	    bcc CH_VOL                                  
e96a : a90f             [ 2] 	    lda #15                                     
e96c :                       CH_VOL	
e96c : a01c             [ 2]         ldy #Volume                              
e96e : 11f5             [ 5]         ora (z80_IX),y
e970 : 85f3             [ 3] 	    sta z80_L
e972 : 18               [ 2]         clc                                      
e973 : a949             [ 2] 	lda #lo(VT_)                                    
e975 : 85f1             [ 3]         sta z80_E
e977 : 65f3             [ 3]         adc z80_L
e979 : 85f3             [ 3]         sta z80_L
e97b : a9ee             [ 2]         lda #hi(VT_)
e97d : 85f2             [ 3]         sta z80_D
e97f : 6900             [ 2]         adc #00
e981 : 85f4             [ 3]         sta z80_H
e983 : a000             [ 2] 	    ldy #00                                     
e985 : b1f3             [ 5]         lda (z80_L),y       ; lda ($AC,x)	
e987 : 85ee             [ 3]         sta z80_A       ; save
e989 :                       CH_ENV	
e989 : a901             [ 2]         lda #%00000001                           
e98b : 24ef             [ 3]         bit z80_C
e98d : d008             [ 3] 	    bne CH_NOEN                                 
e98f : a014             [ 2] 	    ldy #Env_En                                 
e991 : a5ee             [ 3]         lda z80_A
e993 : 11f5             [ 5]         ora (z80_IX),y
AS65 Assembler for R6502 [1.42].                                     Page   78
---------------------------------- bank3.s -----------------------------------

e995 : 85ee             [ 3]         sta z80_A
                             
e997 :                       CH_NOEN	
e997 : a5ee             [ 3]         lda z80_A
e999 : 8d53ee           [ 4]         sta Ampl                                 
e99c : a5ef             [ 3]         lda z80_C                                
e99e : 85ee             [ 3]         sta z80_A
e9a0 : a980             [ 2]         lda #%10000000                           
e9a2 : 24f0             [ 3]         bit z80_B
e9a4 : f034             [ 3] 	    beq NO_ENSL                                 
e9a6 : a5ee             [ 3]         lda z80_A
e9a8 : 2a               [ 2]         rol a                                    
e9a9 : 2a               [ 2] 	    rol a                                       
e9aa : c980             [ 2] 	    cmp #$80                                    
e9ac : 6a               [ 2]         ror a
e9ad : c980             [ 2] 	    cmp #$80                                    
e9af : 6a               [ 2]         ror a
e9b0 : c980             [ 2] 	    cmp #$80                                    
e9b2 : 6a               [ 2]         ror a
e9b3 : a004             [ 2] 	    ldy #CrEnSl                                 
e9b5 : 18               [ 2]         clc
e9b6 : 71f5             [ 5]         adc (z80_IX),y
e9b8 : 85ee             [ 3]         sta z80_A
e9ba : a920             [ 2]         lda #%00100000                           
e9bc : 24f0             [ 3]         bit z80_B
e9be : f006             [ 3] 	    beq NO_ENAC                                 
e9c0 : a004             [ 2] 	    ldy #CrEnSl                                 
e9c2 : a5ee             [ 3]         lda z80_A
e9c4 : 91f5             [ 5]         sta (z80_IX),y
e9c6 :                       NO_ENAC	
e9c6 : a9dd             [ 2]         lda #lo(AddToEn+1)       ; OPT ?         
e9c8 : 85f3             [ 3]         sta z80_L
e9ca : a9eb             [ 2]         lda #hi(AddToEn+1)
e9cc : 85f4             [ 3]         sta z80_H
e9ce : a5ee             [ 3]         lda z80_A
e9d0 : a000             [ 2]         ldy #00                                  
                             		                                               
e9d2 : 18               [ 2]         clc
e9d3 : 71f3             [ 5]         adc (z80_L),y           ; OPT ?
e9d5 : 91f3             [ 5]         sta (z80_L),y                            
e9d7 : 4cf3e9           [ 3] 	    jmp CH_MIX                                  
e9da :                       NO_ENSL 
e9da : a5ee             [ 3]         lda z80_A
e9dc : 6a               [ 2]         ror a                                    
e9dd : a003             [ 2] 	    ldy #CrNsSl                                 
e9df : 18               [ 2]         clc
e9e0 : 71f5             [ 5]         adc (z80_IX),y
e9e2 : 8d48ee           [ 4] 	    sta AddToNs                                 
e9e5 : 85ee             [ 3]         sta z80_A       ; save
e9e7 : a920             [ 2] 	    lda #%00100000                              
e9e9 : 24f0             [ 3]         bit z80_B
e9eb : f006             [ 3] 	    beq CH_MIX                                  
e9ed : a003             [ 2] 	    ldy #CrNsSl                                 
e9ef : a5ee             [ 3]         lda z80_A
e9f1 : 91f5             [ 5]         sta (z80_IX),y
e9f3 :                       CH_MIX	
e9f3 : a5f0             [ 3]         lda z80_B                                
e9f5 : 6a               [ 2] 	    ror a                                       
e9f6 : 2948             [ 2] 	    and #$48                                    
e9f8 : 85ee             [ 3]         sta z80_A
e9fa :                       CH_EXIT	
e9fa : a950             [ 2]         lda #lo(AYREGS+Mixer)                    
AS65 Assembler for R6502 [1.42].                                     Page   79
---------------------------------- bank3.s -----------------------------------

e9fc : 85f3             [ 3]         sta z80_L
e9fe : a9ee             [ 2]         lda #hi(AYREGS+Mixer)
ea00 : 85f4             [ 3]         sta z80_H
ea02 : a5ee             [ 3] 	    lda z80_A
ea04 : a000             [ 2]         ldy #00                                  
ea06 : 11f3             [ 5]         ora (z80_L),y       ; ora ($AC,x)	
ea08 : 4a               [ 2] 	    lsr a                                       
ea09 : 9002             [ 3]         bcc saq2
ea0b : 0980             [ 2]         ora #$80
ea0d : 91f3             [ 5] saq2	sta (z80_L),y                               
ea0f : a5fd             [ 3] 	    lda val3+1                                  
ea11 : 85f4             [ 3]         sta z80_H
ea13 : a5fc             [ 3]         lda val3 
ea15 : 85f3             [ 3]         sta z80_L
ea17 : a900             [ 2] 	    lda #00                                     
ea19 : a00a             [ 2] 	    ldy #COnOff                                 
ea1b : 11f5             [ 5]         ora (z80_IX),y
ea1d : 85ee             [ 3] 	    sta z80_A       ; save
ea1f : d001             [ 3]         bne sas                                  
ea21 : 60               [ 6]         rts
ea22 : a00a             [ 2] sas 	ldy #COnOff                                 
ea24 : b1f5             [ 5]         lda (z80_IX),y
ea26 : 38               [ 2]         sec
ea27 : e901             [ 2]         sbc #01
ea29 : 91f5             [ 5]         sta (z80_IX),y
ea2b : f001             [ 3] 	    beq sat                                     
ea2d : 60               [ 6]         rts
ea2e : a015             [ 2] sat 	ldy #Flags                                  
ea30 : a5ee             [ 3]         lda z80_A
ea32 : 51f5             [ 5]         eor (z80_IX),y                           
ea34 : 91f5             [ 5]         sta (z80_IX),y                           
ea36 : 6a               [ 2] 	    ror a                                       
ea37 : a00b             [ 2] 	    ldy #OnOffD                                 
ea39 : b1f5             [ 5]         lda (z80_IX),y
ea3b : b004             [ 3] 	    bcs CH_ONDL                                 
ea3d : a00c             [ 2] 	    ldy #OffOnD                                 
ea3f : b1f5             [ 5]         lda (z80_IX),y
ea41 :                       CH_ONDL	
ea41 : a00a             [ 2]         ldy #COnOff                              
ea43 : 91f5             [ 5]         sta (z80_IX),y
ea45 : 60               [ 6]         rts                                      
                             ; ===============================================
ea46 :                       PLAY    
ea46 : a900             [ 2]         lda #00                                  
ea48 : 8dddeb           [ 4] 	    sta AddToEn+1                               
ea4b : 8d50ee           [ 4] 	    sta AYREGS+Mixer                            
ea4e : a9ff             [ 2] 	    lda #$FF                                    
ea50 : 8d56ee           [ 4] 	    sta AYREGS+EnvTp                            
ea53 : ce43ee           [ 6] 	    dec DelyCnt                                 
ea56 : f003             [ 3] 	    beq sat1                                    
ea58 : 4c63eb           [ 3]         jmp PL2
ea5b : ce07ee           [ 6] sat1	dec ANtSkCn                                 
ea5e : f003             [ 3] 	    beq sat2                                    
ea60 : 4c1aeb           [ 3]         jmp PL1B
ea63 :                       AdInPtA
ea63 : a901             [ 2] sat2	lda #01                                     
ea65 : 85ef             [ 3]         sta z80_C
ea67 : a901             [ 2]         lda #01
ea69 : 85f0             [ 3]         sta z80_B
ea6b : a000             [ 2] 	    ldy #00                                     
ea6d : b1ef             [ 5]         lda (z80_C),y       ; lda ($AC,x)	       
ea6f : f003             [ 3] 	    beq sat3            ; test 0                
AS65 Assembler for R6502 [1.42].                                     Page   80
---------------------------------- bank3.s -----------------------------------

ea71 : 4c05eb           [ 3]         jmp PL1A
ea74 : 85f2             [ 3] sat3	sta z80_D                                   
ea76 : 8d47ee           [ 4] 	    sta Ns_Base                                 
ea79 : ad93e0           [ 4] 	    lda CrPsPtr                                 
ea7c : 85f3             [ 3]         sta z80_L
ea7e : ad94e0           [ 4]         lda CrPsPtr+1
ea81 : 85f4             [ 3]         sta z80_H
ea83 : e6f3             [ 5] 	    inc z80_L                                   
ea85 : d002             [ 3]         bne sar
ea87 : e6f4             [ 5]         inc z80_H
ea89 :                       sar                                              
ea89 : b1f3             [ 5]         lda (z80_L),y                            
ea8b : 18               [ 2] 	    clc                                         
ea8c : 6901             [ 2]         adc #01
ea8e : 85ee             [ 3]         sta z80_A
ea90 : d014             [ 3]         bne PLNLP                                
ea92 : 20bbe0           [ 6] 	    jsr CHECKLP                                 
ea95 :                       LPosPtr
ea95 : a9ac             [ 2] 	    lda #$AC                                    
ea97 : 85f3             [ 3]         sta z80_L
ea99 : a9ac             [ 2]         lda #$AC
ea9b : 85f4             [ 3]         sta z80_H
ea9d : a000             [ 2] 	    ldy #00                 ; OPT ?             
ea9f : b1f3             [ 5]         lda (z80_L),y       ; lda ($AC,x)	       
eaa1 : 18               [ 2] 	    clc                                         
eaa2 : 6901             [ 2]         adc #01
eaa4 : 85ee             [ 3]         sta z80_A           ; save
eaa6 :                       PLNLP	
eaa6 : a5f3             [ 3]         lda z80_L                                
eaa8 : 8d93e0           [ 4]         sta CrPsPtr
eaab : a5f4             [ 3]         lda z80_H
eaad : 8d94e0           [ 4]         sta CrPsPtr+1
eab0 : a5ee             [ 3] 	    lda z80_A                                   
eab2 : 38               [ 2]         sec
eab3 : e901             [ 2]         sbc #01
eab5 : 0a               [ 2] 	    asl a                                       
eab6 : 85f1             [ 3] 	    sta z80_E                                   
eab8 : 85ee             [ 3]         sta z80_A
eaba : 26f2             [ 5] 	    rol z80_D                                   
eabc :                       PatsPtr
eabc : a9ac             [ 2] 	    lda #$AC
eabe : 18               [ 2]         clc
eabf : 65f1             [ 3]         adc z80_E                                
eac1 : 85f3             [ 3]         sta z80_L
eac3 : a9ac             [ 2]         lda #$AC
eac5 : 65f2             [ 3]         adc z80_D
eac7 : 85f4             [ 3]         sta z80_H
                             	    
eac9 : adf0e3           [ 4] 	    lda MODADDR+1                               
eacc : 85f1             [ 3]         sta z80_E
eace : adf6e3           [ 4]         lda MODADDR+7
ead1 : 85f2             [ 3]         sta z80_D
                                                    	                         
ead3 : a000             [ 2] 	    ldy #00                 ; OPT ?
ead5 : b1f3             [ 5]         lda (z80_L),y           ; lda ($AC,x)	   
ead7 : 18               [ 2]         clc                                      
ead8 : 65f1             [ 3]         adc z80_E               ; OPT (adc MODADD
eada : 85ef             [ 3]         sta z80_C
eadc : c8               [ 2]         iny
eadd : b1f3             [ 5]         lda (z80_L),y
eadf : 65f2             [ 3]         adc z80_D               ; OPT (adc MODADD
eae1 : 85f0             [ 3]         sta z80_B   
AS65 Assembler for R6502 [1.42].                                     Page   81
---------------------------------- bank3.s -----------------------------------

eae3 : c8               [ 2]         iny
eae4 : b1f3             [ 5]         lda (z80_L),y                            
eae6 : 18               [ 2]         clc                     ; OPT ?
eae7 : 65f1             [ 3]         adc z80_E               ; IDEM...
eae9 : 8d28eb           [ 4]         sta AdInPtB+1   
eaec : c8               [ 2]         iny
eaed : b1f3             [ 5]         lda (z80_L),y
eaef : 65f2             [ 3]         adc z80_D
eaf1 : 8d2ceb           [ 4]         sta AdInPtB+5     
eaf4 : c8               [ 2]         iny
eaf5 : b1f3             [ 5]         lda (z80_L),y                            
eaf7 : 18               [ 2]         clc
eaf8 : 65f1             [ 3]         adc z80_E               ; IDEM
eafa : 8d4aeb           [ 4]         sta AdInPtC+1   
eafd : c8               [ 2]         iny
eafe : b1f3             [ 5]         lda (z80_L),y
eb00 : 65f2             [ 3]         adc z80_D
eb02 : 8d4eeb           [ 4]         sta AdInPtC+5
                                                                              
eb05 :                       PSP_	
                             
eb05 :                       PL1A	
eb05 : a9ec             [ 2]         lda #lo(ChanA)                           
eb07 : 85f5             [ 3]         sta z80_IX
eb09 : a9ed             [ 2]         lda #hi(ChanA)
eb0b : 85f6             [ 3]         sta z80_IX+1
eb0d : 2060e4           [ 6] 	jsr PTDECOD                                     
eb10 : a5ef             [ 3] 	lda z80_C                                       
eb12 : 8d64ea           [ 4]         sta AdInPtA+1
eb15 : a5f0             [ 3]         lda z80_B
eb17 : 8d68ea           [ 4]         sta AdInPtA+5
                             
eb1a :                       PL1B	
eb1a : ce24ee           [ 6]         dec BNtSkCn                              
eb1d : d01d             [ 3] 	bne PL1C                                        
eb1f : a909             [ 2] 	lda #lo(ChanB)                                  
eb21 : 85f5             [ 3]         sta z80_IX
eb23 : a9ee             [ 2]         lda #hi(ChanB)
eb25 : 85f6             [ 3]         sta z80_IX+1
eb27 :                       AdInPtB
eb27 : a901             [ 2] 	lda #01                                         
eb29 : 85ef             [ 3]         sta z80_C
eb2b : a901             [ 2]         lda #01
eb2d : 85f0             [ 3]         sta z80_B
eb2f : 2060e4           [ 6] 	jsr PTDECOD                                     
eb32 : a5ef             [ 3] 	lda z80_C                                       
eb34 : 8d28eb           [ 4]         sta AdInPtB+1
eb37 : a5f0             [ 3]         lda z80_B
eb39 : 8d2ceb           [ 4]         sta AdInPtB+5
                             
eb3c :                       PL1C	
eb3c : ce41ee           [ 6]         dec CNtSkCn                              
eb3f : d01d             [ 3] 	bne PL1D                                        
eb41 : a926             [ 2] 	lda #lo(ChanC)                                  
eb43 : 85f5             [ 3]         sta z80_IX
eb45 : a9ee             [ 2]         lda #hi(ChanC)
eb47 : 85f6             [ 3]         sta z80_IX+1
eb49 :                       AdInPtC
eb49 : a901             [ 2] 	lda #01                                         
eb4b : 85ef             [ 3]         sta z80_C
eb4d : a901             [ 2]         lda #01
eb4f : 85f0             [ 3]         sta z80_B
AS65 Assembler for R6502 [1.42].                                     Page   82
---------------------------------- bank3.s -----------------------------------

eb51 : 2060e4           [ 6] 	jsr PTDECOD                                     
eb54 : a5ef             [ 3] 	lda z80_C                                       
eb56 : 8d4aeb           [ 4]         sta AdInPtC+1
eb59 : a5f0             [ 3]         lda z80_B
eb5b : 8d4eeb           [ 4]         sta AdInPtC+5
                             
eb5e :                       Delay
eb5e :                       PL1D	
eb5e : a93e             [ 2]         lda #$3E                                 
eb60 : 8d43ee           [ 4] 	    sta DelyCnt                                 
                             
eb63 :                       PL2	
eb63 : a9ec             [ 2]         lda #lo(ChanA)                           
eb65 : 85f5             [ 3]         sta z80_IX
eb67 : a9ed             [ 2]         lda #hi(ChanA)
eb69 : 85f6             [ 3]         sta z80_IX+1
eb6b : ad49ee           [ 4] 	    lda AYREGS+TonA                             
eb6e : 85f3             [ 3]         sta z80_L
eb70 : ad4aee           [ 4]         lda AYREGS+TonA+1
eb73 : 85f4             [ 3]         sta z80_H
eb75 : 2063e7           [ 6] 	    jsr CHREGS                                  
eb78 : a5f3             [ 3] 	    lda z80_L                                   
eb7a : 8d49ee           [ 4]         sta AYREGS+TonA
eb7d : a5f4             [ 3]         lda z80_H
eb7f : 8d4aee           [ 4]         sta AYREGS+TonA+1
eb82 : ad53ee           [ 4] 	    lda Ampl                                    
eb85 : 8d51ee           [ 4] 	    sta AYREGS+AmplA                            
                             	
eb88 : a909             [ 2]         lda #lo(ChanB)                           
eb8a : 85f5             [ 3]         sta z80_IX
eb8c : a9ee             [ 2]         lda #hi(ChanB)
eb8e : 85f6             [ 3]         sta z80_IX+1
eb90 : ad4bee           [ 4] 	    lda AYREGS+TonB                             
eb93 : 85f3             [ 3]         sta z80_L
eb95 : ad4cee           [ 4]         lda AYREGS+TonB+1
eb98 : 85f4             [ 3]         sta z80_H
eb9a : 2063e7           [ 6] 	    jsr CHREGS                                  
eb9d : a5f3             [ 3] 	    lda z80_L                                   
eb9f : 8d4bee           [ 4]         sta AYREGS+TonB
eba2 : a5f4             [ 3]         lda z80_H
eba4 : 8d4cee           [ 4]         sta AYREGS+TonB+1
eba7 : ad53ee           [ 4] 	    lda Ampl                                    
ebaa : 8d52ee           [ 4] 	    sta AYREGS+AmplB                            
                             	    
ebad : a926             [ 2]         lda #lo(ChanC)                           
ebaf : 85f5             [ 3]         sta z80_IX
ebb1 : a9ee             [ 2]         lda #hi(ChanC)
ebb3 : 85f6             [ 3]         sta z80_IX+1
ebb5 : ad4dee           [ 4] 	    lda AYREGS+TonC                             
ebb8 : 85f3             [ 3]         sta z80_L
ebba : ad4eee           [ 4]         lda AYREGS+TonC+1
ebbd : 85f4             [ 3]         sta z80_H
ebbf : 2063e7           [ 6] 	    jsr CHREGS                                  
ebc2 : a5f3             [ 3] 	    lda z80_L                                   
ebc4 : 8d4dee           [ 4]         sta AYREGS+TonC
ebc7 : a5f4             [ 3]         lda z80_H
ebc9 : 8d4eee           [ 4]         sta AYREGS+TonC+1
                             
ebcc : ad47ee           [ 4] 	    lda Ns_Base_AddToNs                         
ebcf : 85f3             [ 3]         sta z80_L
ebd1 : ad48ee           [ 4]         lda Ns_Base_AddToNs+1
ebd4 : 85f4             [ 3]         sta z80_H                                
AS65 Assembler for R6502 [1.42].                                     Page   83
---------------------------------- bank3.s -----------------------------------

ebd6 : 18               [ 2] 	    clc                                         
ebd7 : 65f3             [ 3]         adc z80_L
ebd9 : 8d4fee           [ 4] 	    sta AYREGS+Noise                            
                             
ebdc :                       AddToEn
ebdc : a93e             [ 2] 	    lda #$3E                                    
ebde : 85f1             [ 3] 	    sta z80_E                                   
ebe0 : 0a               [ 2] 	    asl a                                       
ebe1 : 9004             [ 3] 	    bcc sau                                     
ebe3 : a9ff             [ 2]         lda #$FF
ebe5 : d002             [ 3]         bne sau1      ; always
ebe7 : a900             [ 2] sau     lda #00
ebe9 : 85f2             [ 3] sau1	sta z80_D                                   
ebeb : ad58ee           [ 4]         lda EnvBase+1
ebee : 85f4             [ 3]         sta z80_H           ; OPT ?
ebf0 : ad57ee           [ 4]         lda EnvBase                              
ebf3 : 85f3             [ 3]         sta z80_L           ; OPT ?
ebf5 : 18               [ 2] 	    clc                                         
ebf6 : 65f1             [ 3]         adc z80_E
ebf8 : 85f3             [ 3]         sta z80_L
ebfa : a5f2             [ 3]         lda z80_D
ebfc : 65f4             [ 3]         adc z80_H           ; OPT ?
ebfe : 85f4             [ 3]         sta z80_H 
ec00 : ad45ee           [ 4]         lda CurESld+1
ec03 : 85f2             [ 3]         sta z80_D
ec05 : ad44ee           [ 4]         lda CurESld                              
ec08 : 85f1             [ 3]         sta z80_E
ec0a : 18               [ 2] 	    clc                                         
ec0b : 65f3             [ 3]         adc z80_L
ec0d : 8d54ee           [ 4]         sta AYREGS+Env                           
ec10 : a5f2             [ 3]         lda z80_D
ec12 : 65f4             [ 3]         adc z80_H
ec14 : 8d55ee           [ 4] 	    sta AYREGS+Env+1                            
                             
ec17 : a900             [ 2]         lda #00                                  
ec19 : 0d46ee           [ 4]         ora CurEDel         ; OPT ?              
ec1c : f019             [ 3] 	    beq ROUT                                    
ec1e : ce46ee           [ 6] 	    dec CurEDel                                 
ec21 : d014             [ 3] 	    bne ROUT                                    
ec23 :                       Env_Del
ec23 : a93e             [ 2] 	    lda #$3E                                    
ec25 : 8d46ee           [ 4] 	    sta CurEDel                                 
ec28 :                       ESldAdd
ec28 : a9ac             [ 2] 	    lda #$AC                                    
ec2a : 18               [ 2]         clc
ec2b : 65f1             [ 3]         adc z80_E       
ec2d : 8d44ee           [ 4]         sta CurESld
ec30 : a9ac             [ 2]         lda #$AC
ec32 : 65f2             [ 3]         adc z80_D
ec34 : 8d45ee           [ 4] 	    sta CurESld+1
                             ; ===============================================
                             
ec37 :                       ROUT
ec37 : ae4aee           [ 4]         ldx AYREGS+1    ; hi ToneA
ec3a : ad49ee           [ 4]         lda AYREGS+0    ; lo ToneA
ec3d : 20c0ec           [ 6]         jsr FIX16BITS
                                     
ec40 : a901             [ 2]         lda #01             
ec42 : 200fed           [ 6]         jsr ay_set
ec45 : 98               [ 2]         tya
ec46 : aa               [ 2]         tax
ec47 : a900             [ 2]         lda #00
AS65 Assembler for R6502 [1.42].                                     Page   84
---------------------------------- bank3.s -----------------------------------

ec49 : 200fed           [ 6]         jsr ay_set
                             
ec4c : ae4cee           [ 4]         ldx AYREGS+3    ; hi ToneA
ec4f : ad4bee           [ 4]         lda AYREGS+2    ; lo ToneA
ec52 : 20c0ec           [ 6]         jsr FIX16BITS 
                             
ec55 : a903             [ 2]         lda #03             
ec57 : 200fed           [ 6]         jsr ay_set
ec5a : 98               [ 2]         tya
ec5b : aa               [ 2]         tax
ec5c : a902             [ 2]         lda #02             
ec5e : 200fed           [ 6]         jsr ay_set
                             
ec61 : ae4eee           [ 4]         ldx AYREGS+5    ; hi ToneA
ec64 : ad4dee           [ 4]         lda AYREGS+4    ; lo ToneA
ec67 : 20c0ec           [ 6]         jsr FIX16BITS 
                             
ec6a : a905             [ 2]         lda #05             
ec6c : 200fed           [ 6]         jsr ay_set
ec6f : 98               [ 2]         tya
ec70 : aa               [ 2]         tax
ec71 : a904             [ 2]         lda #04             
ec73 : 200fed           [ 6]         jsr ay_set
                             
ec76 : ad4fee           [ 4]         lda AYREGS+6    ; data
                                     ;jsr FIX8BITS
ec79 : 4a               [ 2]         lsr a             ; /2 
ec7a : aa               [ 2]         tax
ec7b : a906             [ 2]         lda #06             
ec7d : 200fed           [ 6]         jsr ay_set
                             
ec80 : ae50ee           [ 4]         ldx AYREGS+7    ; data
ec83 : a907             [ 2]         lda #07
ec85 : 200fed           [ 6]         jsr ay_set
                             
ec88 : ae51ee           [ 4]         ldx AYREGS+8    ; data
ec8b : a908             [ 2]         lda #08             
ec8d : 200fed           [ 6]         jsr ay_set
                             
ec90 : ae52ee           [ 4]         ldx AYREGS+9    ; data
ec93 : a909             [ 2]         lda #09             
ec95 : 200fed           [ 6]         jsr ay_set
                             
ec98 : ae53ee           [ 4]         ldx AYREGS+10   ; data
ec9b : a90a             [ 2]         lda #10             
ec9d : 200fed           [ 6]         jsr ay_set
                             
eca0 : ae55ee           [ 4]         ldx AYREGS+12   ; hi Env
eca3 : ad54ee           [ 4]         lda AYREGS+11   ; lo Env
eca6 : 20c0ec           [ 6]         jsr FIX16BITS 
                             
eca9 : a90c             [ 2]         lda #12             
ecab : 200fed           [ 6]         jsr ay_set
ecae : 98               [ 2]         tya
ecaf : aa               [ 2]         tax
ecb0 : a90b             [ 2]         lda #11             
ecb2 : 200fed           [ 6]         jsr ay_set
                             
                                     ; shunte R13 si $FF (Y=13) => plus géné
ecb5 : ae56ee           [ 4]         ldx AYREGS+13
ecb8 : 3005             [ 3]         bmi FIN_RTS
ecba : a90d             [ 2]         lda #13
AS65 Assembler for R6502 [1.42].                                     Page   85
---------------------------------- bank3.s -----------------------------------

ecbc : 200fed           [ 6]         jsr ay_set
ecbf :                       FIN_RTS
ecbf : 60               [ 6]         rts
                             ; -------------------------------------
ecc0 :                       FIX16BITS       ; INT(256*2*1000/1773) = 289 = 25
                                             ; IN:  register A is low byte
                                             ;      register X is high byte
                                             ; OUT: register Y is low byte
                                             ;      register X is high byte
                             
                                     ; x256
ecc0 : 86f8             [ 3]         stx TA1
ecc2 : 85fa             [ 3]         sta TB1
ecc4 : 86fb             [ 3]         stx TB2
ecc6 : 85fd             [ 3]         sta TC2
ecc8 : 86fe             [ 3]         stx TB3
ecca : 85ff             [ 3]         sta TC3
eccc : a900             [ 2]         lda #00
ecce : 85f9             [ 3]         sta TA2
                                     
                                     ; x32
ecd0 : 06fd             [ 5]         asl TC2
ecd2 : 26fb             [ 5]         rol TB2
ecd4 : 26f9             [ 5]         rol TA2
ecd6 : 06fd             [ 5]         asl TC2
ecd8 : 26fb             [ 5]         rol TB2
ecda : 26f9             [ 5]         rol TA2
ecdc : 06fd             [ 5]         asl TC2
ecde : 26fb             [ 5]         rol TB2
ece0 : 26f9             [ 5]         rol TA2
ece2 : 06fd             [ 5]         asl TC2
ece4 : 26fb             [ 5]         rol TB2
ece6 : 26f9             [ 5]         rol TA2
ece8 : 06fd             [ 5]         asl TC2
ecea : 26fb             [ 5]         rol TB2
ecec : 26f9             [ 5]         rol TA2
                                     
                                     ; x32 + x01
ecee : 18               [ 2]         clc
ecef : a5ff             [ 3]         lda TC3
ecf1 : 65fd             [ 3]         adc TC2
                                     ; sta TC2
ecf3 : a5fe             [ 3]         lda TB3
ecf5 : 65fb             [ 3]         adc TB2
ecf7 : 85fb             [ 3]         sta TB2
ecf9 : a5f9             [ 3]         lda TA2
ecfb : 6900             [ 2]         adc #00
ecfd : 85f9             [ 3]         sta TA2
                             
                                     ; + x256 
ecff : 18               [ 2]         clc         
ed00 : a5fb             [ 3]         lda TB2
ed02 : 65fa             [ 3]         adc TB1
ed04 : a8               [ 2]         tay         ; sta TB1
ed05 : a5f9             [ 3]         lda TA2
ed07 : 65f8             [ 3]         adc TA1
                                     ; sta TA1
                             
                                     ; / 2 (16bits)
ed09 : 4a               [ 2]         lsr a         ; lsr TA1
ed0a : aa               [ 2]         tax         ; ldx TA1
ed0b : 98               [ 2]         tya         ; lda TB1     
AS65 Assembler for R6502 [1.42].                                     Page   86
---------------------------------- bank3.s -----------------------------------

ed0c : 6a               [ 2]         ror a         ; ror TB1
ed0d : a8               [ 2]         tay         ; ldy TB1
ed0e : 60               [ 6]         rts 
                             
                             ; HB-BBC-128 settings:
                             ;* AY-3-8910 definitions
                             ;* The sound chip is accessed through VIA 2
0480 =                       IO_1		= 0x0480
0000 =                       PRB		= 0x00
0001 =                       PRA		= 0x01
0002 =                       DDRB		= 0x02
0003 =                       DDRA		= 0x03
0481 =                       SND_ADBUS	= IO_1+PRA
0480 =                       SND_MODE	= IO_1+PRB
                             
0040 =                       SND_SELREAD		= 0x40
0002 =                       SND_SELWRITE		= 0x02
0042 =                       SND_SELSETADDR		= (SND_SELREAD|SND_SELWRITE)
00bd =                       SND_DESELECT_MASK	= (0xff-SND_SELREAD-SND_SELWRIT
                             
                             
                             ;****************************************
                             ;* ay_set
                             ;* Set AY register A to value X
                             ;* Input : A = Reg no, X = Value
                             ;* Output : None
                             ;* Regs affected : None
                             ;****************************************
ed0f :                       ay_set
ed0f : 48               [ 3]         pha
                             
ed10 : a9ff             [ 2] 	lda #0xff			; Set Port A to output
ed12 : 8d8304           [ 4] 	sta IO_1 + DDRA
                             
ed15 : 68               [ 4]         pla
ed16 : 8d8104           [ 4] 	sta SND_ADBUS			; Put A on the sound bus (A = re
                             
ed19 : ad8004           [ 4] 	lda SND_MODE			; Need to preserve contents of ot
ed1c : 29bd             [ 2] 	and #SND_DESELECT_MASK	        ; Mask off mode b
ed1e : 0942             [ 2] 	ora #SND_SELSETADDR		; Select AY mode to latch a
ed20 : 8d8004           [ 4] 	sta SND_MODE			; This write will process the dat
                             
ed23 : 29bd             [ 2] 	and #SND_DESELECT_MASK	        ; Mask off mode b
ed25 : 8d8004           [ 4] 	sta SND_MODE			; This write will deselect the AY
                             	
ed28 : 8e8104           [ 4] 	stx SND_ADBUS			; Put X on the sound bus (X = va
ed2b : 0902             [ 2] 	ora #SND_SELWRITE		; Select mode for writing dat
ed2d : 8d8004           [ 4] 	sta SND_MODE			; This write will process the dat
                             	
ed30 : 29bd             [ 2] 	and #SND_DESELECT_MASK	        ; Mask off mode b
ed32 : 8d8004           [ 4] 	sta SND_MODE			; This write will deselect the AY
                             
ed35 : 60               [ 6] 	rts
                             
                             ; ===============================================
ed36 :                       NT_DATA	
ed36 : 64                            fcb (T_NEW_0-T1_)*2
ed37 : 2a                    	    fcb TCNEW_0-T_
ed38 : 65                    	    fcb (T_OLD_0-T1_)*2+1
ed39 : 00                    	    fcb TCOLD_0-T_
ed3a : 01                    	    fcb (T_NEW_1-T1_)*2+1
ed3b : 0c                    	    fcb TCNEW_1-T_
AS65 Assembler for R6502 [1.42].                                     Page   87
---------------------------------- bank3.s -----------------------------------

ed3c : 01                    	    fcb (T_OLD_1-T1_)*2+1
ed3d : 0c                    	    fcb TCOLD_1-T_
ed3e : 94                    	    fcb (T_NEW_2-T1_)*2
ed3f : 35                    	    fcb TCNEW_2-T_
ed40 : 30                    	    fcb (T_OLD_2-T1_)*2
ed41 : 0e                    	    fcb TCOLD_2-T_
ed42 : 60                    	    fcb (T_NEW_3-T1_)*2
ed43 : 20                    	    fcb TCNEW_3-T_
ed44 : 60                    	    fcb (T_OLD_3-T1_)*2
ed45 : 21                    	    fcb TCOLD_3-T_
                             
ed46 :                       T_
                             
ed46 : 0105090b0d0f1315      TCOLD_0	fcb $00+1,$04+1,$08+1,$0A+1,$0C+1,$0E+1,$
ed4e : 19253d00              	    fcb $18+1,$24+1,$3C+1,0
ed52 : 5d00                  TCOLD_1	fcb $5C+1,0
ed54 : 31374d535f7182..      TCOLD_2	fcb $30+1,$36+1,$4C+1,$52+1,$5E+1,$70+1,$
ed5d : 9ea0a6a8aaacae..      	    fcb $9E,$A0,$A6,$A8,$AA,$AC,$AE,$AE,0
ed66 : 57                    TCNEW_3	fcb $56+1
ed67 : 1f2325292d2f33..      TCOLD_3	fcb $1E+1,$22+1,$24+1,$28+1,$2C+1,$2E+1,$
ed70 : 1d2123272b2d3155      TCNEW_0	fcb $1C+1,$20+1,$22+1,$26+1,$2A+1,$2C+1,$
ed78 : bdbf00                	    fcb $BC+1,$BE+1,0
ed52 =                       TCNEW_1 = TCOLD_1
ed7b : 1b2125292b3b4d5f      TCNEW_2	fcb $1A+1,$20+1,$24+1,$28+1,$2A+1,$3A+1,$
ed83 : bbbdbf00              	    fcb $BA+1,$BC+1,$BE+1,0
                             
ed86 =                       EMPTYSAMORN = *-1
ed87 : 010090                	    fcb 1,0,$90 ;delete #90 if you don't need de
                             
                             ;first 12 values of tone tables
                             
ed8a :                       T1_ 	
ed8a : f01d                          fcw $1DF0
ed8c : 201c                          fcw $1C20
ed8e : c01a                          fcw $1AC0
ed90 : 0019                          fcw $1900
ed92 : b017                          fcw $17B0
ed94 : 5016                          fcw $1650
ed96 : 1015                          fcw $1510
ed98 : e013                          fcw $13E0
                             
ed9a : c012                          fcw $12C0
ed9c : c011                          fcw $11C0
ed9e : b010                          fcw $10B0
eda0 : c00f                          fcw $0FC0
eda2 : 7c1a                          fcw $1A7C
eda4 : 0019                          fcw $1900
eda6 : 9817                          fcw $1798
eda8 : 4416                          fcw $1644
                             
edaa : 0415                          fcw $1504
edac : d813                          fcw $13D8
edae : b812                          fcw $12B8
edb0 : ac11                          fcw $11AC
edb2 : b010                          fcw $10B0
edb4 : c00f                          fcw $0FC0
edb6 : dc0e                          fcw $0EDC
edb8 : 080e                          fcw $0E08
                             
edba : b419                          fcw $19B4
edbc : 4418                          fcw $1844
edbe : e616                          fcw $16E6
AS65 Assembler for R6502 [1.42].                                     Page   88
---------------------------------- bank3.s -----------------------------------

edc0 : 9e15                          fcw $159E
edc2 : 6614                          fcw $1466
edc4 : 4213                          fcw $1342
edc6 : 2e12                          fcw $122E
edc8 : 2811                          fcw $1128
                             
edca : 3210                          fcw $1032
edcc : 480f                          fcw $0F48
edce : 6e0e                          fcw $0E6E
edd0 : 9e0d                          fcw $0D9E
edd2 : da0c                          fcw $0CDA
edd4 : 201a                          fcw $1A20
edd6 : aa18                          fcw $18AA
edd8 : 4817                          fcw $1748
                             
edda : f815                          fcw $15F8
eddc : be14                          fcw $14BE
edde : 9413                          fcw $1394
ede0 : 7a12                          fcw $127A
ede2 : 7011                          fcw $1170
ede4 : 7610                          fcw $1076
ede6 : 8a0f                          fcw $0F8A
ede8 : aa0e                          fcw $0EAA
                             
edea : d80d                          fcw $0DD8
                             
ed8a =                       T_OLD_1	= T1_
eda2 =                       T_OLD_2	= T_OLD_1+24
edba =                       T_OLD_3	= T_OLD_2+24
edbc =                       T_OLD_0	= T_OLD_3+2
edbc =                       T_NEW_0	= T_OLD_0
ed8a =                       T_NEW_1	= T_OLD_1
edd4 =                       T_NEW_2	= T_NEW_0+24
edba =                       T_NEW_3	= T_OLD_3
                             
edec =                       FILE_END =*
                             ; ===========================
                             
edec :                       .bss        ; uninitialized data stuff
                             
                             ;vars from here can be stripped
                             ;you can move VARS to any other address
                             
edec :                       VARS
                             ;ChannelsVars
                             
                             ; STRUCT "CHP"
0000 =                       PsInOr	= 0
0001 =                       PsInSm	= 1
0002 =                       CrAmSl  = 2
0003 =                       CrNsSl	= 3
0004 =                       CrEnSl	= 4
0005 =                       TSlCnt	= 5
0006 =                       CrTnSl	= 6
0008 =                       TnAcc	= 8
000a =                       COnOff	= 10
000b =                       OnOffD	= 11
000c =                       OffOnD	= 12
000d =                       OrnPtr	= 13
000f =                       SamPtr	= 15
0011 =                       NNtSkp	= 17
0012 =                       Note	= 18
AS65 Assembler for R6502 [1.42].                                     Page   89
---------------------------------- bank3.s -----------------------------------

0013 =                       SlToNt	= 19
0014 =                       Env_En	= 20
0015 =                       Flags	= 21
0016 =                       TnSlDl	= 22
0017 =                       TSlStp	= 23
0019 =                       TnDelt	= 25
001b =                       NtSkCn	= 27
001c =                       Volume	= 28
                             ; end STRUCT
                             
                             ; CHANNEL A
edec :                       ChanA	
                             ;reset group
edec : 00                    APsInOr	fcb 0
eded : 00                    APsInSm	fcb 0
edee : 00                    ACrAmSl	fcb 0
edef : 00                    ACrNsSl	fcb 0
edf0 : 00                    ACrEnSl	fcb 0
edf1 : 00                    ATSlCnt	fcb 0
edf2 : 0000                  ACrTnSl	fcw 0
edf4 : 0000                  ATnAcc	fcw 0
edf6 : 00                    ACOnOff	fcb 0
                             ;reset group
                             
edf7 : 00                    AOnOffD	fcb 0
                             
edf8 : 00                    AOffOnD	fcb 0
edf9 : 0000                  AOrnPtr	fcw 0
edfb : 0000                  ASamPtr	fcw 0
edfd : 00                    ANNtSkp	fcb 0
edfe : 00                    ANote	fcb 0
edff : 00                    ASlToNt	fcb 0
ee00 : 00                    AEnv_En	fcb 0
ee01 : 00                    AFlags	fcb 0
                              ;Enabled - 0,SimpleGliss - 2
ee02 : 00                    ATnSlDl	fcb 0
ee03 : 0000                  ATSlStp	fcw 0
ee05 : 0000                  ATnDelt	fcw 0
ee07 : 00                    ANtSkCn	fcb 0
ee08 : 00                    AVolume	fcb 0
                             	
                             ; CHANNEL B
ee09 :                       ChanB
                             ;reset group
ee09 : 00                    BPsInOr	fcb 0
ee0a : 00                    BPsInSm	fcb 0
ee0b : 00                    BCrAmSl	fcb 0
ee0c : 00                    BCrNsSl	fcb 0
ee0d : 00                    BCrEnSl	fcb 0
ee0e : 00                    BTSlCnt	fcb 0
ee0f : 0000                  BCrTnSl	fcw 0
ee11 : 0000                  BTnAcc	fcw 0
ee13 : 00                    BCOnOff	fcb 0
                             ;reset group
                             
ee14 : 00                    BOnOffD	fcb 0
                             
ee15 : 00                    BOffOnD	fcb 0
ee16 : 0000                  BOrnPtr	fcw 0
ee18 : 0000                  BSamPtr	fcw 0
ee1a : 00                    BNNtSkp	fcb 0
ee1b : 00                    BNote	fcb 0
AS65 Assembler for R6502 [1.42].                                     Page   90
---------------------------------- bank3.s -----------------------------------

ee1c : 00                    BSlToNt	fcb 0
ee1d : 00                    BEnv_En	fcb 0
ee1e : 00                    BFlags	fcb 0
                              ;Enabled - 0,SimpleGliss - 2
ee1f : 00                    BTnSlDl	fcb 0
ee20 : 0000                  BTSlStp	fcw 0
ee22 : 0000                  BTnDelt	fcw 0
ee24 : 00                    BNtSkCn	fcb 0
ee25 : 00                    BVolume	fcb 0
                             
                             ; CHANNEL C
ee26 :                       ChanC
                             ;reset group
ee26 : 00                    CPsInOr	fcb 0
ee27 : 00                    CPsInSm	fcb 0
ee28 : 00                    CCrAmSl	fcb 0
ee29 : 00                    CCrNsSl	fcb 0
ee2a : 00                    CCrEnSl	fcb 0
ee2b : 00                    CTSlCnt	fcb 0
ee2c : 0000                  CCrTnSl	fcw 0
ee2e : 0000                  CTnAcc	fcw 0
ee30 : 00                    CCOnOff	fcb 0
                             ;reset group
                             
ee31 : 00                    COnOffD	fcb 0
                             
ee32 : 00                    COffOnD	fcb 0
ee33 : 0000                  COrnPtr	fcw 0
ee35 : 0000                  CSamPtr	fcw 0
ee37 : 00                    CNNtSkp	fcb 0
ee38 : 00                    CNote	fcb 0
ee39 : 00                    CSlToNt	fcb 0
ee3a : 00                    CEnv_En	fcb 0
ee3b : 00                    CFlags	fcb 0
                              ;Enabled - 0,SimpleGliss - 2
ee3c : 00                    CTnSlDl	fcb 0
ee3d : 0000                  CTSlStp	fcw 0
ee3f : 0000                  CTnDelt	fcw 0
ee41 : 00                    CNtSkCn	fcb 0
ee42 : 00                    CVolume	fcb 0
                             
                             ; ------------
                             
                             ;GlobalVars
ee43 : 00                    DelyCnt	fcb 0
ee44 : 0000                  CurESld	fcw 0
ee46 : 00                    CurEDel	fcb 0
ee47 :                       Ns_Base_AddToNs
ee47 : 00                    Ns_Base	fcb 0
ee48 : 00                    AddToNs	fcb 0
                             
                             ; ===========================
ee49 :                       AYREGS ; AY registers
                             
0000 =                       TonA	= 0
0002 =                       TonB	= 2
0004 =                       TonC	= 4
0006 =                       Noise	= 6
0007 =                       Mixer	= 7
0008 =                       AmplA	= 8
0009 =                       AmplB	= 9
000a =                       AmplC	= 10
AS65 Assembler for R6502 [1.42].                                     Page   91
---------------------------------- bank3.s -----------------------------------

000b =                       Env	    = 11
000d =                       EnvTp	= 13
                             ; ---
                             
ee53 =                       Ampl	= AYREGS+AmplC
                             ; ===========================
ee49 : 00000000000000..      VT_	ds 256 ;CreatedVolumeTableAddress
                             
ee57 =                       EnvBase	= VT_+14
ee59 =                       VAR0END	= VT_+16 ;INIT zeroes from VARS to VAR0EN
                             
                             ; ===========================
ef49 : 00000000000000..      NT_	ds 192 ;CreatedNoteTableAddress
                             
f009 =                       VARS_END = *
f009 :                       PT3END
                             
                             
                             	; End of Code
f009 :                       _code_end
f009 :                       _bank3_end
                             
No errors in pass 2.
Wrote binary from address $c000 through $ffff.
Total size 16384 bytes.
